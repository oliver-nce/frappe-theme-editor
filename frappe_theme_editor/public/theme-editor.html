<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <title>NCE Design System - Frappe Theme Editor</title>
    <style>
        /* ═══════════════════════════════════════════════════════════════
           LAYER 1: DESIGN TOKENS
           ═══════════════════════════════════════════════════════════════ */
        :root {
            /* Spacing scale */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            /* Border radii */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 12px;
            
            /* Shadows (reusable) */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 48px rgba(0,0,0,0.12);
            
            /* Typography */
            --font-size-xs: 10px;
            --font-size-sm: 12px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            
            /* Breakpoints (as reference) */
            /* --bp-mobile: 600px */
            /* --bp-tablet: 800px */
        }

        /* ═══════════════════════════════════════════════════════════════
           LAYER 2: RESET & BASE
           ═══════════════════════════════════════════════════════════════ */
        * { margin: 0; padding: 0; box-sizing: border-box; } 
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: white; /* Neutral for Safari toolbar */
            color: var(--page-text, #1a1a1a);
            line-height: 1.4;
        }
        
        .page-wrapper {
            min-height: 100vh;
            padding: var(--space-lg);
            background: var(--page-bg);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white !important;  /* Always white */
            padding: var(--space-lg);
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.12);  /* Stronger border for defined edge */
            /* Wide spread shadow - darker while keeping low opacity */
            box-shadow: var(--shadow-lg), 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;  /* Prevent panels from escaping */
        }
        
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--container-bg, white);
            margin: calc(-1 * var(--space-lg)) calc(-1 * var(--space-lg)) var(--space-lg) calc(-1 * var(--space-lg));
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--container-border);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        h1 { font-size: 22px; font-weight: 700; margin-bottom: 2px; }
        .header p { font-size: 11px; color: var(--muted-text, #666); margin: 0; }
        
        .header-buttons { display: flex; gap: var(--space-sm); }
        .header-buttons .btn { min-width: 120px; text-align: center; }

        /* LAYER 3: LAYOUT PRIMITIVES
           ═══════════════════════════════════════════════════════════════ */
        
        /* Standard container - consistent width for all content blocks */
        .c-container {
            width: 100%;
            max-width: 1400px;
        }
        
        .section { 
            margin-bottom: 28px;
        }
        
        /* Section row: flexbox with wrap */
        .section-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-lg);
            margin-bottom: 28px;
        }
        
        /* Inner container for Semantic + Window - wraps internally */
        .section-row-inner {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-lg);
            flex: 1 1 auto;
            min-width: 280px;
        }
        
        .section-row .section,
        .section-row-inner .section {
            flex: 1 1 auto;
            min-width: 280px; /* Minimum width before wrapping */
            margin-bottom: 0;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }
        
        .section-title { font-size: var(--font-size-lg); font-weight: 600; }
        .click-to-edit {
            font-size: 12px;
            font-weight: 400;
            color: #888;
            margin-left: 8px;
        }

        /* ═══════════════════════════════════════════════════════════════
           LAYER 4: COMPONENTS
           ═══════════════════════════════════════════════════════════════ */
        
        /* ─────────────────────────────────────────────────────────────── 
           Component: Buttons
           ─────────────────────────────────────────────────────────────── */
        
        /* NEW: Consolidated button component */
        .c-btn {
            padding: 6px var(--space-md);
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm), inset 0 0 0 1px rgba(0,0,0,0.1);
            background: transparent;
            color: inherit;
        }
        
        .c-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15), inset 0 0 0 1px rgba(0,0,0,0.1);
        }
        
        /* Primary variant */
        .c-btn--primary {
            background: var(--btn-gradient);
            color: var(--btn-text);
        }
        
        /* Secondary variant */
        .c-btn--secondary {
            background: var(--btn-secondary-gradient);
            color: var(--btn-secondary-text);
        }
        
        /* Small size variant */
        .c-btn--small {
            padding: var(--space-xs) var(--space-sm);
            font-size: 11px;
        }
        
        /* Large/Preview size variant */
        .c-btn--large {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
        }
        
        .c-btn--large:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md), inset 0 0 0 1px rgba(0,0,0,0.1);
        }
        
        /* Toggle/Preset button variant */
        .c-btn--toggle {
            border: 1px solid #ddd;
            background: white;
            color: #666;
            box-shadow: none;
        }
        
        .c-btn--toggle:hover {
            border-color: var(--accent-color);
            box-shadow: none;
        }
        
        .c-btn--toggle.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        /* Danger variant */
        .c-btn--danger {
            background: var(--error);
            color: var(--error-text);
        }
        
        /* Outline variant */
        .c-btn--outline {
            background: transparent;
            border: 1px solid var(--primary-500);
            color: var(--primary-600);
        }
        
        .c-btn--outline.c-btn--large {
            border: 1px solid var(--primary-500);
        }
        
        /* Ghost variant */
        .c-btn--ghost {
            background: transparent;
            color: var(--primary-600);
            box-shadow: none;
        }
        
        .c-btn--ghost:hover,
        .c-btn--ghost.c-btn--large:hover {
            box-shadow: none;
        }
        
        /* Close button variant (circular) */
        .c-btn--close {
            width: 24px;
            height: 24px;
            padding: 0;
            border-radius: 50%;
            background: #e0e0e0;
            color: inherit;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
        }
        
        .c-btn--close:hover {
            background: #d44444;
            color: white;
            box-shadow: none;
            transform: none;
        }
        
        /* Scale bump button variant (minimal style) */
        .c-btn--scale-bump {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--neutral-300, #ddd);
            color: #666;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: none;
        }
        
        .c-btn--scale-bump:hover {
            background: var(--neutral-100, #f5f5f5);
            color: #333;
            box-shadow: none;
            transform: none;
        }
        
        .c-btn--scale-bump:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .c-btn--scale-bump svg {
            width: 14px;
            height: 14px;
        }
        
        /* Apply button variant (used in pickers) */
        .c-btn--apply {
            padding: 8px 16px;
            background: var(--primary-500, #2490EF);
            color: white;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .c-btn--apply:hover {
            opacity: 0.9;
            transform: none;
        }
        
        /* Hex apply button variant (neutral style) */
        .c-btn--hex-apply {
            padding: 8px 14px;
            background: var(--neutral-100);
            border: 1px solid var(--neutral-300);
            color: inherit;
            font-size: 13px;
            box-shadow: none;
        }
        
        .c-btn--hex-apply:hover {
            background: var(--neutral-200);
            transform: none;
            box-shadow: none;
        }
        
        /* Tab button variant */
        .c-btn--tab {
            padding: 12px 24px;
            background: transparent;
            color: var(--muted-text, #666);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            font-size: 14px;
            box-shadow: none;
            border-radius: 0;
        }
        
        .c-btn--tab:hover {
            color: var(--page-text, #1a1a1a);
            background: var(--panel-bg, #f5f5f5);
            transform: none;
            box-shadow: none;
        }
        
        .c-btn--tab.active {
            color: var(--accent-color, #667eea);
            border-bottom-color: var(--accent-color, #667eea);
        }
        
        /* Subtab button variant */
        .c-btn--subtab {
            padding: 8px 16px;
            border: 1px solid var(--container-border, #e0e0e0);
            background: var(--panel-bg, #f5f5f5);
            color: var(--muted-text, #666);
            border-radius: 6px;
            min-width: 120px;
            text-align: center;
            font-size: 12px;
            box-shadow: none;
        }
        
        .c-btn--subtab:hover {
            border-color: var(--accent-color, #667eea);
            color: var(--page-text, #1a1a1a);
            transform: none;
            box-shadow: none;
        }
        
        .c-btn--subtab.active {
            background: var(--accent-color, #667eea);
            color: white;
            border-color: var(--accent-color, #667eea);
        }
        
        /* ─────────────────────────────────────────────────────────────── 
           LEGACY BUTTON CLASSES (for backward compatibility)
           TODO: Update HTML to use .c-btn classes, then remove these
           ─────────────────────────────────────────────────────────────── */
        
        /* Base button styles */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 
                0 1px 3px rgba(0,0,0,0.12),
                inset 0 0 0 1px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 2px 6px rgba(0,0,0,0.15),
                inset 0 0 0 1px rgba(0,0,0,0.1);
        }
        
        /* Primary button variant (extends .btn) */
        .btn-primary {
            background: var(--btn-gradient);
            color: var(--btn-text);
        }
        
        /* Secondary button variant */
        .btn-secondary { 
            background: var(--btn-secondary-gradient);
            color: var(--btn-secondary-text);
        }
        
        /* Edit button (standalone - not used with .btn class) */
        .edit-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--btn-gradient);
            color: var(--btn-text);
            box-shadow: 
                0 1px 3px rgba(0,0,0,0.12),
                inset 0 0 0 1px rgba(0,0,0,0.1);
        }
        
        .edit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 2px 6px rgba(0,0,0,0.15),
                inset 0 0 0 1px rgba(0,0,0,0.1);
        }
        
        .btn-apply-hex {
            padding: 8px 14px;
            background: var(--neutral-100);
            border: 1px solid var(--neutral-300);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .btn-apply-hex:hover {
            background: var(--neutral-200);
        }
        
        .picker-apply-btn {
            padding: 8px 16px;
            background: var(--primary-500, #2490EF);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .picker-apply-btn:hover {
            opacity: 0.9;
        }
        
        .close-editor {
            position: absolute;
            top: 6px; right: 8px;
            background: #e0e0e0;
            border: none;
            width: 24px; height: 24px;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .close-editor:hover { background: #d44444; color: white; }
        
        .scale-bump-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--neutral-300, #ddd);
            border-radius: 4px;
            font-size: 11px;
            color: #666;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .scale-bump-btn:hover {
            background: var(--neutral-100, #f5f5f5);
            color: #333;
        }
        
        .scale-bump-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .scale-bump-btn svg {
            width: 14px;
            height: 14px;
        }
        
        .angle-presets {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: nowrap; /* Keep buttons together as a unit */
            margin-bottom: var(--space-sm);
        }
        
        .angle-preset {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .angle-preset:hover { border-color: var(--accent-color); }
        .angle-preset.active { 
            background: var(--accent-color); 
            color: white; 
            border-color: var(--accent-color);
        }
        
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: var(--muted-text, #666);
            cursor: pointer;
            border-bottom: none;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--page-text, #1a1a1a);
        }
        
        .tab-btn.active {
            color: var(--accent-color, #667eea);
        }
        
        .subtab-btn {
            padding: 8px 16px;
            border: 1px solid var(--container-border, #e0e0e0);
            background: var(--panel-bg, #f5f5f5);
            font-size: 12px;
            font-weight: 600;
            color: var(--muted-text, #666);
            cursor: pointer;
            border-radius: 6px;
            min-width: 120px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .subtab-btn:hover {
            border-color: var(--accent-color, #667eea);
            color: var(--page-text, #1a1a1a);
        }
        
        .subtab-btn.active {
            background: var(--accent-color, #667eea);
            color: white;
            border-color: var(--accent-color, #667eea);
        }
        
        /* Designer button classes (exported styles) */
        .btn-solid {
            background: var(--btn-gradient);
            color: var(--btn-text);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-500);
            color: var(--primary-600);
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--primary-600);
            box-shadow: none;
        }
        
        .btn-danger {
            background: var(--error);
            color: var(--error-text);
        }
        
        .btn-preview {
            width: 100%;
            padding: 16px 24px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
            box-shadow: 
                0 1px 3px rgba(0,0,0,0.12),
                inset 0 0 0 1px rgba(0,0,0,0.1);
        }
        
        .btn-preview:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 4px 12px rgba(0,0,0,0.15),
                inset 0 0 0 1px rgba(0,0,0,0.1);
        }
        
        .btn-outline.btn-preview {
            border: 1px solid var(--primary-500);
        }
        
        .btn-ghost.btn-preview {
            box-shadow: none;
        }

        /* ─────────────────────────────────────────────────────────────── 
           Component: Panels
           ─────────────────────────────────────────────────────────────── */
        
        /* NEW: Consolidated panel component */
        .c-panel {
            background: white;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            margin-top: var(--space-md);
            position: relative;
        }
        
        /* Editor panel variant (deeper shadow) */
        .c-panel--editor {
            box-shadow: 0 4px 32px rgba(0,0,0,0.09), 0 1px 8px rgba(0,0,0,0.06);
        }
        
        /* Picker panel variant (lighter shadow) */
        .c-panel--picker {
            box-shadow: 0 2px 24px rgba(0,0,0,0.08), 0 1px 6px rgba(0,0,0,0.05);
            display: none;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .c-panel--picker.active {
            display: block;
        }
        
        /* Modal variant */
        .c-panel--modal {
            padding: var(--space-lg);
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.3s;
            margin: 0;
        }
        
        .modal-overlay.show .c-panel--modal {
            transform: scale(1);
        }
        
        /* Notification variant */
        .c-panel--notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            font-weight: 600;
            box-shadow: var(--shadow-md);
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.3s;
            z-index: 1001;
            margin: 0;
            border: none;
        }
        
        .c-panel--notification.success {
            background: var(--success-color, #10b981);
            color: white;
        }
        
        .c-panel--notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Scale bump panel variant (minimal styling) */
        .c-panel--scale-bump {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        /* ─────────────────────────────────────────────────────────────── 
           Component: Color Swatches & Grids
           ─────────────────────────────────────────────────────────────── */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 125px));
            gap: 10px;
            margin-bottom: 16px;
        }
        
        /* Semantic and Window grids: no internal wrapping */
        #semanticGrid,
        #windowGrid {
            grid-template-columns: repeat(3, minmax(80px, 125px));
        }
        
        .color-swatch {
            border: 1px solid rgba(0,0,0,0.15);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15), var(--shadow-sm);
            transition: all 0.2s;
        }
        
        .color-swatch.clickable { cursor: pointer; }
        .color-swatch.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            border-color: var(--accent-color, #667eea);
        }
        
        .color-box { height: 50px; width: 100%; position: relative; }
        
        .color-box-input {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }
        
        .color-box-bg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }
        
        .color-box-label {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: var(--font-size-xs);
            font-weight: 600;
            pointer-events: none;
            z-index: 3;
        }
        
        .color-info { padding: 6px; background: white; }
        .color-name { font-size: var(--font-size-xs); font-weight: 600; color: #1a1a1a; }
        .color-value { font-size: 9px; font-family: monospace; color: #666; }

        /* ─────────────────────────────────────────────────────────────── 
           Component: Editor Panels
           ─────────────────────────────────────────────────────────────── */
        
        /* LEGACY: Use .c-panel--editor instead */
        .editor-panel {
            background: white;
            border: 1px solid rgba(0,0,0,0.15);
            border-radius: 12px;
            padding: 24px;
            padding-top: 48px;  /* Space for drag handle */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: auto;
            min-width: 1100px;  /* Wide enough for both pickers */
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 40px rgba(0,0,0,0.15), 0 2px 12px rgba(0,0,0,0.1);
        }
        .editor-panel.hidden {
            display: none;
        }
        .editor-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 999;
        }
        .editor-panel-overlay.hidden {
            display: none;
        }
        .editor-drag-handle {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 36px;
            background: linear-gradient(to bottom, #f8f8f8, #f0f0f0);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px 12px 0 0;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        .editor-drag-handle::before {
            content: '';
            width: 40px;
            height: 4px;
            background: #ccc;
            border-radius: 2px;
        }
        .editor-panel.dragging {
            transition: none;
        }

        .editor-panel label {
            display: block;
            font-size: var(--font-size-sm);
            margin-bottom: 10px;
            color: #666;
        }
        
        .hue-slider-row {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-sm);
            border-radius: var(--radius-lg);
            border: 2px solid #e0e0e0;
        }
        
        .hue-slider {
            flex: 1;
            height: 36px;
            border-radius: var(--radius-md);
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }
        
        .hue-slider.rainbow {
            background: linear-gradient(to right,
                hsl(0,100%,50%), hsl(60,100%,50%), hsl(120,100%,50%),
                hsl(180,100%,50%), hsl(240,100%,50%), hsl(300,100%,50%), hsl(360,100%,50%)
            );
        }
        
        .editor-row {
            display: flex;
            gap: 20px;
        }
        
        .editor-col {
            display: flex;
            flex-direction: column;
        }
        
        .brand-input-row {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
        }
        
        .color-picker-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            padding: 0;
        }
        
        .color-picker-btn::-webkit-color-swatch-wrapper {
            padding: 2px;
        }
        
        .color-picker-btn::-webkit-color-swatch {
            border-radius: var(--radius-sm);
            border: 1px solid rgba(0,0,0,0.15);
        }
        
        .hex-input {
            width: 90px;
            padding: var(--space-sm) 10px;
            border: 1px solid var(--neutral-300);
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: var(--font-size-md);
        }

        /* ─────────────────────────────────────────────────────────────── 
           Component: Sliders & Scale Controls
           ─────────────────────────────────────────────────────────────── */
        /* LEGACY: Use .c-panel--scale-bump instead */
        /* Scale Bump Controls */
        .scale-bump-panel {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .scale-bump-buttons {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: var(--space-sm);
        }

        .scale-bump-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--neutral-500, #888);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .scale-bump-indicator {
            font-size: 14px;
            font-weight: 600;
            color: var(--neutral-700, #444);
            min-width: 40px;
            text-align: center;
        }

        /* ─────────────────────────────────────────────────────────────── 
           Component: Color Picker Panel (Apple-style)
           ─────────────────────────────────────────────────────────────── */
        /* LEGACY: Use .c-panel--picker instead */
        /* Inline color picker panel */
        .color-picker-panel {
            background: white;  /* Front panel - always white */
            border: 1px solid rgba(0,0,0,0.12);  /* Stronger border for defined edge */
            border-radius: 12px;
            padding: 16px;
            max-width: 100%;  /* Prevent overflow */
            box-sizing: border-box;  /* Include padding in width */
            /* Wide spread shadow - darker while keeping low opacity */
            box-shadow: 0 2px 24px rgba(0,0,0,0.08), 0 1px 6px rgba(0,0,0,0.05);
        }
        .color-picker-panel.active {
            display: block;
        }
        
        .picker-layout {
            display: flex;
            gap: 24px;
            align-items: stretch;
            max-width: 100%;  /* Prevent overflow */
            flex-wrap: wrap;  /* Allow wrapping on narrow screens */
        }
        
        /* Left column: Grid + Hex */
        .picker-left-col {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-width: 300px;  /* Minimum width before wrapping */
            flex-shrink: 0;  /* Prevent shrinking */
        }
        
        /* Right column: Preview + Bump + Sliders + Apply */
        .picker-right-col {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 300px;  /* Minimum width before wrapping */
        }
        
        /* Top row: Preview + Scale Bump side by side */
        .picker-top-row {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        
        /* Spacer pushes sliders/apply to bottom */
        .picker-spacer {
            flex: 1;
        }

        /* Color grid */
        .color-grid-picker {
            flex-shrink: 0;
            display: grid;
            grid-template-columns: repeat(12, 20px);
            grid-template-rows: 20px 6px repeat(10, 20px); /* top row + spacer + gray row + 9 color rows */
            gap: 2px;
        }
        .color-grid-picker .grid-cell {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .color-grid-picker .grid-cell:hover {
            transform: scale(1.15);
            z-index: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .color-grid-picker .grid-cell.selected {
            outline: 2px solid #333;
            outline-offset: 1px;
        }
        .color-grid-picker .grid-spacer {
            height: 6px;
        }
        .color-grid-picker .grid-cell.no-fill {
            background: #FFFFFF linear-gradient(
                to bottom left,
                transparent calc(50% - 1px),
                #FF3B30 calc(50% - 1px),
                #FF3B30 calc(50% + 1px),
                transparent calc(50% + 1px)
            ) !important;
            cursor: default;
        }
        
        /* Large swatch */
        .picker-swatch-large {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        /* HSV Sliders */
        .hsv-sliders {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        .hsv-slider-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .hsv-slider-row label {
            width: 16px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }
        .hsv-slider-row input[type="range"] {
            flex: 1;
            height: 12px;
            border-radius: 6px;
            -webkit-appearance: none;
            cursor: pointer;
        }
        .hsv-slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            border: 2px solid #666;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .hsv-slider-row input[type="number"] {
            width: 55px;
            padding: 4px 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
        }
        .hue-slider-picker {
            background: linear-gradient(to right, 
                hsl(0,100%,50%), hsl(60,100%,50%), hsl(120,100%,50%), 
                hsl(180,100%,50%), hsl(240,100%,50%), hsl(300,100%,50%), hsl(360,100%,50%));
        }
        .sat-slider-picker {
            background: linear-gradient(to right, #888, hsl(210,100%,50%));
        }
        .val-slider-picker {
            background: linear-gradient(to right, #000, hsl(210,100%,50%));
        }
        
        /* Hex row with copy */
        .picker-hex-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
        }
        .picker-hex-row input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }
        .picker-hex-row button {
            width: 32px;
            height: 32px;
            padding: 0;
            border: none;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        .picker-hex-row button:hover {
            background: var(--neutral-200, #e5e5e5);
            color: #333;
        }
        .copied-indicator {
            display: none;
            font-size: 11px;
            color: var(--success-color, #10b981);
        }
        .copied-indicator.show {
            display: inline;
        }
        .picker-hex-row button.eyedropper-hidden {
            display: none;
        }
        
        /* Eyedropper hint - inline, fades out smoothly */
        .eyedropper-hint {
            display: none;
            margin-left: 8px;
            font-size: 11px;
            color: #666;
            opacity: 1;
            transition: opacity 0.6s ease;
            pointer-events: none;
            white-space: nowrap;
        }
        .eyedropper-hint.show {
            display: inline;
            opacity: 1;
        }
        .eyedropper-hint.fade {
            opacity: 0;
        }

        /* Responsive: stack columns on very small screens (phones) */
        @media (max-width: 600px) {
            .picker-layout {
                flex-direction: column;
            }
            .picker-top-row {
                flex-direction: column;
            }
        }

        /* ─────────────────────────────────────────────────────────────── 
           Component: Neutral Color Picker
           ─────────────────────────────────────────────────────────────── */
        /* LEGACY: Use .c-panel--picker instead */
        /* NEUTRAL COLOR PICKER STYLES */
        .neutral-picker-panel {
            background: white;  /* Front panel - always white */
            border: 1px solid rgba(0,0,0,0.12);  /* Stronger border for defined edge */
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            /* Wide spread shadow - darker while keeping low opacity */
            box-shadow: 0 2px 24px rgba(0,0,0,0.08), 0 1px 6px rgba(0,0,0,0.05);
        }
        .neutral-picker-layout {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }
        .neutral-color-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
        }
        .neutral-grid-cell {
            width: 35px;
            height: 35px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.1s, border-color 0.15s;
        }
        .neutral-grid-cell:hover {
            transform: scale(1.05);
            z-index: 1;
        }
        .neutral-grid-cell.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }
        .neutral-picker-right {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .neutral-preview-swatch {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* COMBINED COLOR PICKERS LAYOUT */
        .color-pickers-combined {
            display: flex;
            gap: 24px;
            align-items: stretch;  /* Same height */
            flex-wrap: nowrap;
        }
        .color-picker-panel {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
        }
        .color-picker-panel .picker-layout {
            flex: 1;
        }
        .neutral-picker-sidebar {
            flex: 0 0 280px;  /* Fixed width, wider */
            background: white;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 12px;
            padding: 16px;  /* Same as color-picker-panel */
            box-shadow: 0 2px 24px rgba(0,0,0,0.08), 0 1px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;  /* Equal spacing between elements */
        }
        .brand-picker-wrapper,
        .neutral-picker-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .brand-picker-wrapper .color-picker-panel,
        .neutral-picker-wrapper .neutral-picker-sidebar {
            flex: 1;
        }
        .picker-label,
        .neutral-sidebar-label {
            display: block;
            font-weight: 500;
            font-size: 14px;
            color: #333;
        }
        .neutral-picker-sidebar .neutral-color-grid {
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }
        .neutral-picker-sidebar .neutral-grid-cell {
            width: 100%;
            aspect-ratio: 1;
        }
        .neutral-middle-row {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .neutral-picker-sidebar .neutral-preview-swatch {
            width: 70px;
            height: 70px;
            flex-shrink: 0;
        }
        .neutral-scale-bump {
            flex: 1;
        }
        .neutral-apply-btn {
            width: 100%;
        }
        
        /* Responsive: stack on narrow screens */
        @media (max-width: 900px) {
            .color-pickers-combined {
                flex-direction: column;
            }
            .neutral-picker-sidebar {
                flex: 0 0 auto;
                width: 100%;
            }
        }

        /* TEXT FLIP THRESHOLD SELECTOR */
        .text-flip-selector {
            display: block;
            margin: 16px 0;
            padding: 12px;
            background: var(--neutral-50, #fafafa);
            border: 1px solid var(--neutral-200, #e5e5e5);
            border-radius: 8px;
        }
        .text-flip-track {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .text-flip-arrow {
            background: var(--neutral-100, #f0f0f0);
            border: 1px solid var(--neutral-300, #d0d0d0);
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.15s;
        }
        .text-flip-arrow:hover {
            background: var(--neutral-200, #e5e5e5);
        }
        .text-flip-arrow:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .text-flip-tiles {
            display: flex;
            gap: 4px;
        }
        .text-flip-tile {
            flex: 1;
            height: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.15s;
        }
        .text-flip-pointer-track {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            height: 24px;
            margin-top: 2px;
        }
        .text-flip-pointer {
            position: absolute;
            font-size: 18px;
            line-height: 1;
            color: #333;
            font-weight: bold;
            transform: translateX(-50%);
            transition: left 0.2s ease;
        }
        .text-flip-label {
            text-align: center;
            font-size: 13px;
            color: var(--neutral-600, #666);
            margin-top: 4px;
        }

        .offset-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(to right, #222 0%, #888 50%, #eee 100%);
            outline: none;
            cursor: pointer;
        }
        
        .offset-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid #666;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }
        
        .hue-slider.neutral {
            background: linear-gradient(to right,
                hsl(240,5%,80%), hsl(180,5%,80%), hsl(120,5%,80%),
                hsl(60,5%,80%), hsl(0,5%,80%)
            );
        }
        
        .hue-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; height: 40px;
            background: white;
            border: 3px solid #333;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .hue-input {
            width: 60px;
            padding: 6px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }
        
        .hue-input:focus { outline: none; border-color: var(--accent-color, #667eea); }
        
        .button-group { display: flex; gap: 12px; flex-wrap: wrap; }

        /* LEGACY: Use .c-panel--notification instead */
        .notification {
            position: fixed;
            top: 20px; right: 20px;
            background: var(--success-color, #10b981);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            pointer-events: none;
            z-index: 1000;
        }
        
        .notification.show { opacity: 1; transform: translateY(0); }
        .hidden { display: none; }
        
        /* Modal Dialog */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .modal-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        /* LEGACY: Use .c-panel--modal instead */
        .modal {
            background: var(--container-bg, white);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        
        .modal-overlay.show .modal {
            transform: scale(1);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--page-text);
        }
        
        .modal-message {
            font-size: 14px;
            color: var(--muted-text);
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .modal-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(0,0,0,0.15);
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .modal-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(var(--accent-color), 0.1);
        }
        
        .modal-success {
            text-align: center;
            padding: 20px 0;
        }
        
        /* Wide modal for themes list */
        .modal-wide {
            max-width: 800px;
            width: 90%;
        }
        
        /* Themes table */
        .themes-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        
        .themes-table th {
            text-align: left;
            padding: 12px 8px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            font-size: 12px;
            font-weight: 600;
            color: var(--muted-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .themes-table td {
            padding: 12px 8px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            font-size: 14px;
        }
        
        .themes-table tr:hover {
            background: rgba(0,0,0,0.02);
        }
        
        .theme-swatch {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .swatch-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .theme-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            min-width: auto;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            border: none;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .modal-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--muted-text);
        }

        /* ─────────────────────────────────────────────────────────────── 
           Component: Background & Gradient Settings
           ─────────────────────────────────────────────────────────────── */
        /* Backgrounds Grid */
        .backgrounds-grid {
            display: flex;
            gap: var(--space-lg);
            flex-wrap: wrap;
        }
        
        .background-setting {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .background-setting label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--page-text, #1a1a1a);
        }

        /* Gradient Editor */
        .gradient-editor {
            display: flex;
            gap: var(--space-lg);
            align-items: flex-start;
        }
        
        .gradient-preview-area {
            flex: 0 0 200px;
        }
        
        /* Button Preview Grid */
        .btn-preview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
        }
        .btn-preview-item {
            text-align: center;
        }
        .btn-preview-label {
            display: block;
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }
        
        /* Button Controls Row */
        .btn-controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-lg);
            align-items: flex-start;
        }
        
        .btn-controls-row .gradient-control-group {
            flex: 0 0 auto;
            min-width: max-content; /* Keep group together, wrap as unit */
        }
        
        .btn-controls-row .gradient-control-group:last-child {
            flex: 0 0 auto;
            min-width: max-content; /* Keep group together, wrap as unit */
        }
        
        /* Typography Controls */
        .typography-controls {
            display: flex;
            gap: 24px;
            align-items: flex-end;
        }

        .gradient-controls {
            flex: 1;
        }
        
        .gradient-control-group {
            margin-bottom: 16px;
        }
        
        .gradient-control-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #555;
        }
        
        .angle-presets {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: nowrap; /* Keep buttons together as a unit */
            margin-bottom: var(--space-sm);
        }
        
        .angle-preset {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: var(--radius-sm);
            background: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .angle-preset:hover { border-color: var(--accent-color); }
        .angle-preset.active { 
            background: var(--accent-color); 
            color: white; 
            border-color: var(--accent-color);
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        /* Responsive: stack button controls on very small screens (phones) */
        @media (max-width: 600px) {
            .btn-controls-row {
                flex-direction: column;
                gap: var(--space-md);
            }
        }

        /* ─────────────────────────────────────────────────────────────── 
           Component: Tabs
           ─────────────────────────────────────────────────────────────── */
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 0;
            margin-bottom: var(--space-lg);
            border-bottom: 2px solid var(--container-border, #e0e0e0);
        }

        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════
           FRAPPE ONLY: CSS START - Subtabs and Frappe Settings Grid
           ═══════════════════════════════════════════════════════════════════════════ */
        
        /* Subtab Navigation */
        .subtab-nav {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .subtab-content {
            display: none;
        }
        
        .subtab-content.active {
            display: block;
        }
        
        .subtab-placeholder {
            color: var(--muted-text, #666);
            font-style: italic;
            padding: 20px;
            text-align: center;
            background: var(--panel-bg, #f5f5f5);
            border-radius: 8px;
        }
        
        /* Frappe Settings Grid */
        .frappe-settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px 24px;
        }
        
        .frappe-settings-grid .setting-section-header {
            grid-column: 1 / -1;
        }
        
        @media (min-width: 800px) {
            .frappe-settings-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ─────────────────────────────────────────────────────────────── 
           Component: Form Controls & Settings Rows
           ─────────────────────────────────────────────────────────────── */
        /* Frappe Settings Row Styles (used only in Frappe Settings tab) */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--panel-bg, #f9f9f9);
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .setting-label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .setting-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--page-text, #1a1a1a);
        }
        
        .setting-desc {
            font-size: 11px;
            color: var(--muted-text, #666);
        }
        
        .setting-control {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 220px;
            justify-content: flex-end;
        }
        
        .setting-control select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            min-width: 160px;
            cursor: pointer;
        }
        
        .setting-control select:focus {
            outline: none;
            border-color: var(--accent-color, #667eea);
        }
        
        .color-swatch-mini {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        /* Placeholder for rows without swatches to maintain alignment */
        .swatch-placeholder {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            visibility: hidden;
        }
        
        /* Print Settings - Dual Column Layout (Color + B&W) */
        .print-dual-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        @media (min-width: 800px) {
            .print-dual-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .print-column {
            background: var(--panel-bg, #f9f9f9);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e0e0e0;
        }
        
        .print-column-header {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .print-column-header .color-badge {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        .print-column-header .color-badge.color {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .print-column-header .color-badge.bw {
            background: linear-gradient(135deg, #333, #999);
        }
        
        .print-setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .print-setting-row:last-child {
            border-bottom: none;
        }
        
        .print-setting-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--page-text);
        }

        /* ─────────────────────────────────────────────────────────────── 
           Component: Dropdown Pickers (Swatch & Gray)
           ─────────────────────────────────────────────────────────────── */
        /* Pure Gray Picker (no hue tint) */
        .gray-picker {
            position: relative;
        }
        
        .gray-picker-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            min-width: 160px;
            font-size: 12px;
        }
        
        .gray-picker-trigger:hover {
            border-color: var(--accent-color, #667eea);
        }
        
        .gray-picker-trigger .gray-swatch {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.15);
            flex-shrink: 0;
        }
        
        .gray-picker-trigger .gray-label {
            flex: 1;
        }
        
        .gray-picker-trigger .gray-arrow {
            font-size: 10px;
            color: #999;
        }
        
        .gray-picker-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 1000;
            display: none;
        }
        
        .gray-picker-dropdown.open {
            display: block;
        }
        
        .gray-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 4px;
        }
        
        .gray-option {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .gray-option:hover {
            transform: scale(1.15);
            z-index: 1;
        }
        
        .gray-option.selected {
            border-color: var(--accent-color, #667eea);
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════
           FRAPPE ONLY: CSS END
           ═══════════════════════════════════════════════════════════════════════════ */
        
        /* Custom Swatch Picker (SHARED - used in Core Theme backgrounds + Frappe Settings) */
        .swatch-picker {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .swatch-picker-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            min-width: 160px;
            font-size: 12px;
        }
        
        .swatch-picker-trigger:hover {
            border-color: var(--accent-color, #667eea);
        }
        
        .swatch-picker-trigger .trigger-swatch {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.15);
            flex-shrink: 0;
        }
        
        .swatch-picker-trigger .trigger-label {
            flex: 1;
        }
        
        .swatch-picker-trigger .trigger-arrow {
            font-size: 10px;
            color: #999;
        }
        
        .swatch-picker-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px;
            z-index: 1000;
            display: none;
            min-width: 280px;
        }
        
        .swatch-grid-section {
            margin-bottom: 10px;
        }
        
        .swatch-grid-section:last-child {
            margin-bottom: 0;
        }
        
        .swatch-grid-label {
            font-size: 10px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }
        
        .swatch-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
        }
        
        .swatch-grid-item {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.1s;
            position: relative;
        }
        
        .swatch-grid-item:hover {
            transform: scale(1.1);
            z-index: 1;
        }
        
        .swatch-grid-item.selected {
            border-color: var(--accent-color, #667eea);
        }
        
        .swatch-grid-item::after {
            content: attr(data-shade);
            position: absolute;
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            color: #999;
            opacity: 0;
            transition: opacity 0.1s;
            white-space: nowrap;
        }
        
        .swatch-grid-item:hover::after {
            opacity: 1;
        }
        
        .swatch-picker-dropdown.open {
            display: block;
        }
        
        .swatch-picker-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .swatch-picker-option:hover {
            background: var(--panel-bg, #f5f5f5);
        }
        
        .swatch-picker-option.selected {
            background: var(--panel-bg, #f0f0f0);
        }
        
        .swatch-picker-option .option-swatch {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .swatch-picker-option .option-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--page-text, #1a1a1a);
        }
        
        .swatch-picker-option .option-desc {
            font-size: 10px;
            color: var(--muted-text, #666);
        }
        
        .setting-suggestion {
            display: block;
            font-size: 11px;
            font-style: italic;
            color: var(--accent-color, #667eea);
            margin-top: 2px;
        }
        
        /* Inherited settings */
        .setting-row.inherited {
            opacity: 0.7;
        }
        
        .setting-inherited {
            display: block;
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
        
        .inherited-value {
            font-size: 12px;
            color: #666;
            padding: 6px 12px;
            background: #f5f5f5;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .inherited-value.inherited-swatch {
            width: 160px;
            height: 34px;
            padding: 0;
            display: inline-block;
            border: 1px solid #ddd;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .setting-section-header {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 0 4px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 8px;
        }
        
        /* Color input (native picker) */
        .color-input {
            width: 160px;
            height: 34px;
            padding: 2px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            background: white;
        }
        
        .color-input:hover {
            border-color: var(--accent-color, #667eea);
        }

        /* ─────────────────────────────────────────────────────────────── 
           Component: Styled Dropdown Menus
           ─────────────────────────────────────────────────────────────── */
        /* Styled Menu (non-color dropdowns) */
        .styled-menu {
            position: relative;
            display: inline-block;
        }
        
        .styled-menu-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            min-width: 160px;
            font-size: 12px;
        }
        
        .styled-menu-trigger:hover {
            border-color: var(--accent-color, #667eea);
        }
        
        .styled-menu-trigger .menu-label {
            flex: 1;
        }
        
        .styled-menu-trigger .menu-arrow {
            font-size: 10px;
            color: #999;
        }
        
        .styled-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 4px;
            z-index: 1000;
            display: none;
            min-width: 160px;
        }
        
        .styled-menu-dropdown.open {
            display: block;
        }
        
        .styled-menu-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.15s;
        }
        
        .styled-menu-option:hover {
            background: var(--panel-bg, #f5f5f5);
        }
        
        .styled-menu-option.selected {
            background: var(--panel-bg, #f0f0f0);
            font-weight: 500;
        }

        /* ─────────────────────────────────────────────────────────────── 
           Component: Toggle Switches
           ─────────────────────────────────────────────────────────────── */
        /* Toggle Switch */
        .toggle {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }
        
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .toggle input:checked + .toggle-slider {
            background-color: var(--accent-color, #667eea);
        }
        
        .toggle input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* ═══════════════════════════════════════════════════════════════
           LAYER 5: RESPONSIVE & UTILITIES
           ═══════════════════════════════════════════════════════════════ */
        
        /* Responsive: stack setting rows on very small screens (phones) */
        @media (max-width: 600px) {
            .setting-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .setting-control {
                width: 100%;
            }
            .setting-control select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Frappe Theme Editor</h1>
                <p>Theme editor for Frappe applications • Use Save Theme to export</p>
            </div>
            <div class="header-buttons">
                <button class="btn btn-secondary" data-action="my-themes">My Themes</button>
                <button class="btn btn-secondary" data-action="revert" id="btnRevert" style="display: none;">Revert</button>
                <button class="btn btn-secondary" data-action="update-theme" id="btnUpdate" style="display: none;">Update</button>
                <button class="btn btn-primary" data-action="save-as-new">Save as New Theme</button>
            </div>
        </div>
        
        <!-- ═══════════════════════════════════════════════════════════════════════════
             FRAPPE ONLY: HTML START - Tab Navigation
             ═══════════════════════════════════════════════════════════════════════════ -->
        <div class="tab-nav">
            <button class="tab-btn active" data-action="switch-tab" data-target="core">Core Theme</button>
            <button class="tab-btn" data-action="switch-tab" data-target="frappe">Frappe Settings</button>
        </div>
        <!-- ═══════════════════════════════════════════════════════════════════════════
             FRAPPE ONLY: HTML END - Tab Navigation
             ═══════════════════════════════════════════════════════════════════════════ -->
        
        <!-- ═══════════════════════════════════════════════════════════════════════════
             BASIC VERSION: Core Theme Content (Tab 1)
             In basic version: remove wrapping div and class, keep content
             ═══════════════════════════════════════════════════════════════════════════ -->
        <div id="tab-core" class="tab-content active">
        
        <!-- Primary Colors -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title" data-action="toggle-editor" data-target="primary" style="cursor: pointer;">Primary Colors (<span id="primaryLabel">Blue</span> Scale) <span class="click-to-edit">Click to Edit</span></h2>
            </div>
            <div class="color-grid" id="primaryGrid"></div>
            <div id="anchorLegend" style="font-size: 11px; color: #888; margin-top: 4px; display: none;">* = This is your designated brand color</div>

            <div class="editor-panel-overlay hidden" id="editor-overlay" data-action="toggle-editor" data-target="primary"></div>
            <div class="editor-panel hidden" id="editor-primary">
                <div class="editor-drag-handle" id="editorDragHandle"></div>
                <button class="close-editor" data-action="toggle-editor" data-target="primary">✕</button>
                <div class="editor-row">
                    <div class="editor-col" style="flex: 0 0 auto;">
                        <!-- Safari: native picker row (hidden but accessible) -->
                        <div class="brand-input-row" id="safariPickerRow">
                            <input type="color" class="color-picker-btn" id="brandColorPicker" value="#888888">
                            <input type="text" class="hex-input" id="brandHexInput" placeholder="Paste hex" maxlength="7">
                            <button class="btn-apply-hex" id="applyBrandHex">Apply</button>
                        </div>
                        
                        <!-- Combined Color Pickers: Brand + Neutral side by side -->
                        <div class="color-pickers-combined">
                            <!-- Brand Color Picker -->
                            <div class="brand-picker-wrapper">
                                <label class="picker-label">Brand Color</label>
                                <div class="color-picker-panel" id="colorPickerPanel">
                                <div class="picker-layout">
                                    <!-- Left Column: Color Grid + Hex Row -->
                                    <div class="picker-left-col">
                                        <div class="color-grid-picker" id="colorGridPicker"></div>
                                        <div class="picker-hex-row">
                                            <input type="text" id="pickerHexInput" value="#4299F0" maxlength="7">
                                            <button id="pickerCopyBtn" title="Copy hex">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                </svg>
                                            </button>
                                            <span class="copied-indicator" id="copiedIndicator">Copied</span>
                                            <button id="pickerEyedropperBtn" class="eyedropper-hidden" title="Pick from screen" data-action="eyedropper">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="m2 22 1-1h3l9-9"></path>
                                                    <path d="M3 21v-3l9-9"></path>
                                                    <path d="m15 6 3.4-3.4a2.1 2.1 0 1 1 3 3L18 9l.4.4a2.1 2.1 0 1 1-3 3l-3.8-3.8a2.1 2.1 0 1 1 3-3l.4.4"></path>
                                                </svg>
                                            </button>
                                            <span class="eyedropper-hint" id="eyedropperHint">Click "Show Colors" to access the eye dropper</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Right Column: Preview + Bump + Sliders + Apply -->
                                    <div class="picker-right-col">
                                        <!-- Top Row: Preview Swatch + Scale Bump -->
                                        <div class="picker-top-row">
                                            <div class="picker-swatch-large" id="pickerSwatchLarge"></div>
                                            <div class="scale-bump-panel">
                                                <div class="scale-bump-title">Scale Bump</div>
                                                <div class="scale-bump-buttons">
                                                    <button class="scale-bump-btn" id="anchorBumpLeft" data-action="bump-anchor" data-value="-1">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <circle cx="12" cy="12" r="5"></circle>
                                                            <line x1="12" y1="1" x2="12" y2="3"></line>
                                                            <line x1="12" y1="21" x2="12" y2="23"></line>
                                                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                                            <line x1="1" y1="12" x2="3" y2="12"></line>
                                                            <line x1="21" y1="12" x2="23" y2="12"></line>
                                                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                                        </svg>
                                                        Lighter
                                                    </button>
                                                    <span class="scale-bump-indicator" id="anchorIndicator">--</span>
                                                    <button class="scale-bump-btn" id="anchorBumpRight" data-action="bump-anchor" data-value="1">
                                                        Darker
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Spacer to push sliders down -->
                                        <div class="picker-spacer"></div>
                                        
                                        <!-- HSV Sliders -->
                                        <div class="hsv-sliders">
                                            <div class="hsv-slider-row">
                                                <label>H</label>
                                                <input type="range" class="hue-slider-picker" id="pickerHue" min="0" max="360" value="210">
                                                <input type="number" id="pickerHueNum" min="0" max="360" value="210">
                                            </div>
                                            <div class="hsv-slider-row">
                                                <label>S</label>
                                                <input type="range" class="sat-slider-picker" id="pickerSat" min="0" max="100" value="85">
                                                <input type="number" id="pickerSatNum" min="0" max="100" value="85">
                                            </div>
                                            <div class="hsv-slider-row">
                                                <label>V</label>
                                                <input type="range" class="val-slider-picker" id="pickerVal" min="0" max="100" value="94">
                                                <input type="number" id="pickerValNum" min="0" max="100" value="94">
                                            </div>
                                        </div>
                                        
                                        <!-- Apply Button (aligned with hex row) -->
                                        <button class="picker-apply-btn" id="pickerApplyBtn">Apply as Brand Color</button>
                                    </div>
                                </div>
                                </div>
                            </div>
                            
                            <!-- Neutral Color Picker (sidebar) -->
                            <div class="neutral-picker-wrapper">
                                <label class="neutral-sidebar-label">Neutral Temperature</label>
                                <div class="neutral-picker-sidebar">
                                    <!-- Grid at top (full width) -->
                                    <div class="neutral-color-grid" id="neutralColorGrid"></div>
                                    <!-- Middle row: Swatch + Scale Bump -->
                                    <div class="neutral-middle-row">
                                        <div class="neutral-preview-swatch" id="neutralPreviewSwatch"></div>
                                        <div class="scale-bump-panel neutral-scale-bump">
                                        <div class="scale-bump-title">Scale Bump</div>
                                        <div class="scale-bump-buttons">
                                            <button class="scale-bump-btn" id="neutralBumpLighter" data-action="bump-neutral" data-value="-1">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="5"></circle>
                                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                                </svg>
                                                Lighter
                                            </button>
                                            <span class="scale-bump-indicator" id="neutralBumpIndicator">--</span>
                                            <button class="scale-bump-btn" id="neutralBumpDarker" data-action="bump-neutral" data-value="1">
                                                Darker
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        </div>
                                    </div>
                                    <!-- Apply button -->
                                    <button class="picker-apply-btn neutral-apply-btn" data-action="apply-neutral">Apply as Neutral Color</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Neutral Colors -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title" data-action="toggle-editor" data-target="primary" style="cursor: pointer;">Neutral Colors (<span id="neutralLabel">Cool</span> Gray) <span class="click-to-edit">Click to Edit</span></h2>
            </div>
            <div class="color-grid" id="neutralGrid" data-action="toggle-editor" data-target="primary" style="cursor: pointer;"></div>
        </div>
        
        <!-- Semantic Colors, Window Controls, Backgrounds & Typography (side by side) -->
        <div class="section-row">
            <!-- Inner container: Semantic + Window wrap together -->
            <div class="section-row-inner">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Semantic Colors</h2>
                    </div>
                    <div class="color-grid" id="semanticGrid"></div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Window Controls</h2>
                    </div>
                    <div class="color-grid" id="windowGrid"></div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Backgrounds & Typography</h2>
                </div>
                <div class="typography-controls">
                    <div class="gradient-control-group">
                        <label>Page Background</label>
                        <div class="swatch-picker" id="picker-pageBg">
                            <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-pageBg" data-action="toggle-swatch-picker" data-target="picker-pageBg">
                                <div class="trigger-swatch"></div>
                                <span class="trigger-label">neutral-50</span>
                                <span class="trigger-arrow">▼</span>
                            </div>
                            <div class="swatch-picker-dropdown" id="picker-pageBg-dropdown"></div>
                        </div>
                    </div>
                    <div class="gradient-control-group">
                        <label>UI Font</label>
                        <div style="display: flex; gap: 16px; align-items: center;">
                            <div class="styled-menu" id="menu-uiFont">
                                <div class="styled-menu-trigger" data-action="toggle-menu" data-target="menu-uiFont" data-action="toggle-menu" data-target="menu-uiFont" title="Select UI font family">
                                    <span class="menu-label" id="fontMenuLabel">Arial</span>
                                    <span class="menu-arrow">▼</span>
                                </div>
                                <div class="styled-menu-dropdown" id="menu-uiFont-dropdown">
                                    <div class="styled-menu-option selected font-option" data-action="select-font" data-value="Arial" style="font-family: Arial, sans-serif;">Arial</div>
                                    <div class="styled-menu-option font-option" data-action="select-font" data-value="Verdana" style="font-family: Verdana, sans-serif;">Verdana</div>
                                    <div class="styled-menu-option font-option" data-action="select-font" data-value="Trebuchet MS" style="font-family: 'Trebuchet MS', sans-serif;">Trebuchet MS</div>
                                </div>
                            </div>
                            <button class="angle-preset" id="boldToggle" data-action="toggle-bold" title="Toggle bold text" style="padding: 6px 12px; font-weight: bold; font-size: 12px; box-sizing: border-box;">B</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Buttons</h2>
            </div>
            
            <!-- All Controls in One Row -->
            <div class="btn-controls-row">
                <!-- Button Previews Group -->
                <div class="gradient-control-group">
                    <div class="btn-preview-grid">
                        <div class="btn-preview-item">
                            <button class="btn-solid btn-preview" id="gradientPreview">Primary</button>
                            <span class="btn-preview-label">Solid</span>
                        </div>
                        <div class="btn-preview-item">
                            <button class="btn-outline btn-preview" id="outlinePreview">Outline</button>
                            <span class="btn-preview-label">Outline</span>
                        </div>
                        <div class="btn-preview-item">
                            <button class="btn-ghost btn-preview" id="ghostPreview">Ghost</button>
                            <span class="btn-preview-label">Ghost</span>
                        </div>
                        <div class="btn-preview-item">
                            <button class="btn-danger btn-preview" id="dangerPreview">Danger</button>
                            <span class="btn-preview-label">Destructive</span>
                        </div>
                    </div>
                </div>
                
                <!-- Gradient Toggle Group -->
                <div class="gradient-control-group">
                    <label>Apply Gradient?</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="gradientToggle" data-action="toggle-gradient">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <!-- Shade Controls Group -->
                <div class="gradient-control-group">
                    <label>Default Shade + Text Color Flip Point</label>
                    <div style="display: inline-block;">
                        <div class="angle-presets" id="textFlipButtons">
                            <!-- Buttons generated by JS -->
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 4px;">
                            <button class="angle-preset" style="flex: 1;" data-action="move-text-flip" data-value="-1" id="textFlipLeft">◀</button>
                            <button class="angle-preset" style="flex: 1;" data-action="move-text-flip" data-value="1" id="textFlipRight">▶</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        </div>
        <!-- ═══════════════════════════════════════════════════════════════════════════
             END: Core Theme Content (Tab 1)
             ═══════════════════════════════════════════════════════════════════════════ -->
        
        <!-- ═══════════════════════════════════════════════════════════════════════════
             FRAPPE ONLY: HTML START - Tab 2 (Frappe Settings)
             Remove entire section for basic version
             ═══════════════════════════════════════════════════════════════════════════ -->
        <!-- Tab 2: Frappe Settings -->
        <div id="tab-frappe" class="tab-content">
            
            <!-- Subtab Navigation -->
            <div class="subtab-nav">
                <button class="subtab-btn active" data-action="switch-subtab" data-target="common">Common Elements</button>
                <button class="subtab-btn" data-action="switch-subtab" data-target="lists">Lists</button>
                <button class="subtab-btn" data-action="switch-subtab" data-target="forms">Forms</button>
                <button class="subtab-btn" data-action="switch-subtab" data-target="indicators">Indicators</button>
                <button class="subtab-btn" data-action="switch-subtab" data-target="navigation">Navigation</button>
                <button class="subtab-btn" data-action="switch-subtab" data-target="print">Print</button>
            </div>
            
            <!-- Subtab: Common Elements -->
            <div id="subtab-common" class="subtab-content active">
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Common Elements</h2>
                    </div>
                    <p style="font-size: 12px; color: var(--muted-text); margin-bottom: 16px;">
                        These settings apply across multiple Frappe application points.
                    </p>
                    
                    <div class="frappe-settings-grid">
                        
                        <!-- Frappe Core Variables Section Header -->
                        <div class="setting-section-header">Frappe CSS Variables</div>
                        
                        <!-- --primary (inherited) -->
                        <div class="setting-row inherited">
                            <div class="setting-label">
                                <span class="setting-name">--primary</span>
                                <span class="setting-desc">Main brand color for buttons, links, active states</span>
                                <span class="setting-inherited">↑ Inherits from Core Theme → Primary Hue (600 shade)</span>
                            </div>
                            <div class="setting-control">
                                <span class="inherited-value inherited-swatch" id="inherited-primary"></span>
                            </div>
                        </div>
                        
                        <!-- --bg-color (inherited) -->
                        <div class="setting-row inherited">
                            <div class="setting-label">
                                <span class="setting-name">--bg-color</span>
                                <span class="setting-desc">Page background color</span>
                                <span class="setting-inherited">↑ Inherits from Core Theme → Page Background</span>
                            </div>
                            <div class="setting-control">
                                <span class="inherited-value inherited-swatch" id="inherited-bg-color"></span>
                            </div>
                        </div>
                        
                        <!-- --fg-color (inherited) -->
                        <div class="setting-row inherited">
                            <div class="setting-label">
                                <span class="setting-name">--fg-color</span>
                                <span class="setting-desc">Card/panel/form background</span>
                                <span class="setting-inherited">↑ Inherits from Core Theme → Panel Background</span>
                            </div>
                            <div class="setting-control">
                                <span class="inherited-value inherited-swatch" id="inherited-fg-color"></span>
                            </div>
                        </div>
                        
                        <!-- --btn-default-bg (editable) -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">--btn-default-bg</span>
                                <span class="setting-desc">Secondary/default button background</span>
                                <span class="setting-suggestion">💡 Suggest: primary-100 for contrast with primary buttons</span>
                            </div>
                            <div class="setting-control">
                                <div class="swatch-picker" id="picker-btnDefaultBg">
                                    <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-btnDefaultBg">
                                        <div class="trigger-swatch"></div>
                                        <span class="trigger-label">primary-100</span>
                                        <span class="trigger-arrow">▼</span>
                                    </div>
                                    <div class="swatch-picker-dropdown" id="picker-btnDefaultBg-dropdown"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- --control-bg (editable) -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">--control-bg</span>
                                <span class="setting-desc">Input field background color</span>
                                <span class="setting-suggestion">💡 Suggest: neutral-50 for subtle contrast</span>
                            </div>
                            <div class="setting-control">
                                <div class="swatch-picker" id="picker-controlBg">
                                    <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-controlBg">
                                        <div class="trigger-swatch"></div>
                                        <span class="trigger-label">neutral-50</span>
                                        <span class="trigger-arrow">▼</span>
                                    </div>
                                    <div class="swatch-picker-dropdown" id="picker-controlBg-dropdown"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- UI Settings Section Header -->
                        <div class="setting-section-header" style="margin-top: 20px;">UI Settings</div>
                        
                        <!-- Navbar Theme -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">Navbar Theme</span>
                                <span class="setting-desc">Top navigation bar color scheme</span>
                                <span class="setting-suggestion">💡 Dark is standard Frappe look</span>
                            </div>
                            <div class="setting-control">
                                <div class="swatch-picker" id="picker-navbarTheme">
                                    <div class="swatch-picker-trigger" data-action="toggle-navbar-picker">
                                        <div class="trigger-swatch" id="navbar-trigger-swatch"></div>
                                        <span class="trigger-label" id="navbar-trigger-label">Dark</span>
                                        <span class="trigger-arrow">▼</span>
                                    </div>
                                    <div class="swatch-picker-dropdown" id="picker-navbarTheme-dropdown">
                                        <div class="swatch-picker-option selected" data-value="dark" data-action="select-navbar-theme">
                                            <div class="option-swatch" style="background: #1a1a1a;"></div>
                                            <div><div class="option-label">Dark</div><div class="option-desc">neutral-900</div></div>
                                        </div>
                                        <div class="swatch-picker-option" data-value="light" data-action="select-navbar-theme">
                                            <div class="option-swatch" style="background: #ffffff; border: 1px solid #ddd;"></div>
                                            <div><div class="option-label">Light</div><div class="option-desc">white</div></div>
                                        </div>
                                        <div class="swatch-picker-option" data-value="primary" data-action="select-navbar-theme">
                                            <div class="option-swatch" id="navbar-primary-swatch"></div>
                                            <div><div class="option-label">Primary</div><div class="option-desc">primary-700</div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alternate Rows -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">Alternate Row Colors</span>
                                <span class="setting-desc">Zebra striping in tables and lists for easier scanning</span>
                            </div>
                            <div class="setting-control">
                                <div class="styled-menu" id="menu-alternateRows">
                                    <div class="styled-menu-trigger" data-action="toggle-menu" data-target="menu-alternateRows">
                                        <span class="menu-label">Yes</span>
                                        <span class="menu-arrow">▼</span>
                                    </div>
                                    <div class="styled-menu-dropdown" id="menu-alternateRows-dropdown">
                                        <div class="styled-menu-option selected" data-value="true" data-action="select-menu-option">Yes</div>
                                        <div class="styled-menu-option" data-value="false" data-action="select-menu-option">No</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alternate Row Color -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">Alternate Row Color</span>
                                <span class="setting-desc">Background color for every other row (zebra stripes)</span>
                                <span class="setting-suggestion">💡 Suggest: neutral-50 for subtle striping</span>
                            </div>
                            <div class="setting-control">
                                <div class="swatch-picker" id="picker-alternateRowColor">
                                    <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-alternateRowColor">
                                        <div class="trigger-swatch"></div>
                                        <span class="trigger-label">neutral-50</span>
                                        <span class="trigger-arrow">▼</span>
                                    </div>
                                    <div class="swatch-picker-dropdown" id="picker-alternateRowColor-dropdown"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row Hover Color -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">Row Hover Color</span>
                                <span class="setting-desc">Background when mouse hovers over a row</span>
                                <span class="setting-suggestion">💡 Suggest: light (50-100) for subtle, non-distracting feedback</span>
                            </div>
                            <div class="setting-control">
                                <div class="swatch-picker" id="picker-rowHoverColor">
                                    <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-rowHoverColor">
                                        <div class="trigger-swatch"></div>
                                        <span class="trigger-label">primary-50</span>
                                        <span class="trigger-arrow">▼</span>
                                    </div>
                                    <div class="swatch-picker-dropdown" id="picker-rowHoverColor-dropdown"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row Selection Color -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">Row Selection Color</span>
                                <span class="setting-desc">Background for selected/checked rows</span>
                                <span class="setting-suggestion">💡 Suggest: primary (100-200) to clearly show selection</span>
                            </div>
                            <div class="setting-control">
                                <div class="swatch-picker" id="picker-rowSelectionColor">
                                    <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-rowSelectionColor">
                                        <div class="trigger-swatch"></div>
                                        <span class="trigger-label">primary-100</span>
                                        <span class="trigger-arrow">▼</span>
                                    </div>
                                    <div class="swatch-picker-dropdown" id="picker-rowSelectionColor-dropdown"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card Border Radius -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">Card Border Radius</span>
                                <span class="setting-desc">Corner rounding for cards, modals, panels</span>
                            </div>
                            <div class="setting-control">
                                <div class="styled-menu" id="menu-cardBorderRadius">
                                    <div class="styled-menu-trigger" data-action="toggle-menu" data-target="menu-cardBorderRadius">
                                        <span class="menu-label">8px (default)</span>
                                        <span class="menu-arrow">▼</span>
                                    </div>
                                    <div class="styled-menu-dropdown" id="menu-cardBorderRadius-dropdown">
                                        <div class="styled-menu-option" data-value="0" data-action="select-menu-option">0 (sharp)</div>
                                        <div class="styled-menu-option" data-value="4px" data-action="select-menu-option">4px (minimal)</div>
                                        <div class="styled-menu-option selected" data-value="8px" data-action="select-menu-option">8px (default)</div>
                                        <div class="styled-menu-option" data-value="12px" data-action="select-menu-option">12px (rounded)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Focus Ring Color -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">Focus Ring Color</span>
                                <span class="setting-desc">Glow around focused input fields (shows which field is active)</span>
                                <span class="setting-suggestion">💡 Suggest: primary (100-300) for accessibility visibility</span>
                            </div>
                            <div class="setting-control">
                                <div class="swatch-picker" id="picker-focusRingColor">
                                    <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-focusRingColor">
                                        <div class="trigger-swatch"></div>
                                        <span class="trigger-label">primary-100</span>
                                        <span class="trigger-arrow">▼</span>
                                    </div>
                                    <div class="swatch-picker-dropdown" id="picker-focusRingColor-dropdown"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Default Border Color -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">Default Border Color</span>
                                <span class="setting-desc">Standard border for inputs, cards, dividers</span>
                                <span class="setting-suggestion">💡 Suggest: neutral (200-400) for clean, unobtrusive lines</span>
                            </div>
                            <div class="setting-control">
                                <div class="swatch-picker" id="picker-defaultBorderColor">
                                    <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-defaultBorderColor">
                                        <div class="trigger-swatch"></div>
                                        <span class="trigger-label">neutral-300</span>
                                        <span class="trigger-arrow">▼</span>
                                    </div>
                                    <div class="swatch-picker-dropdown" id="picker-defaultBorderColor-dropdown"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section Header -->
                        <div class="setting-section-header" style="margin-top: 20px;">Sizing & Dimensions</div>
                        
                        <!-- Border Radius (global) -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">--border-radius</span>
                                <span class="setting-desc">Global corner radius for buttons, inputs, badges</span>
                            </div>
                            <div class="setting-control">
                                <div class="styled-menu" id="menu-borderRadius">
                                    <div class="styled-menu-trigger" data-action="toggle-menu" data-target="menu-borderRadius">
                                        <span class="menu-label">6px (default)</span>
                                        <span class="menu-arrow">▼</span>
                                    </div>
                                    <div class="styled-menu-dropdown" id="menu-borderRadius-dropdown">
                                        <div class="styled-menu-option" data-value="0" data-action="select-menu-option">0 (sharp)</div>
                                        <div class="styled-menu-option" data-value="4px" data-action="select-menu-option">4px (subtle)</div>
                                        <div class="styled-menu-option selected" data-value="6px" data-action="select-menu-option">6px (default)</div>
                                        <div class="styled-menu-option" data-value="8px" data-action="select-menu-option">8px (rounded)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Border Radius Large (dialogs/modals) -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">--border-radius-lg</span>
                                <span class="setting-desc">Corner radius for dialogs, modals, cards</span>
                            </div>
                            <div class="setting-control">
                                <div class="styled-menu" id="menu-borderRadiusLg">
                                    <div class="styled-menu-trigger" data-action="toggle-menu" data-target="menu-borderRadiusLg">
                                        <span class="menu-label">12px (default)</span>
                                        <span class="menu-arrow">▼</span>
                                    </div>
                                    <div class="styled-menu-dropdown" id="menu-borderRadiusLg-dropdown">
                                        <div class="styled-menu-option" data-value="0" data-action="select-menu-option">0 (sharp)</div>
                                        <div class="styled-menu-option" data-value="8px" data-action="select-menu-option">8px (subtle)</div>
                                        <div class="styled-menu-option selected" data-value="12px" data-action="select-menu-option">12px (default)</div>
                                        <div class="styled-menu-option" data-value="16px" data-action="select-menu-option">16px (rounded)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Button Height -->
                        <div class="setting-row">
                            <div class="setting-label">
                                <span class="setting-name">--btn-height</span>
                                <span class="setting-desc">Standard button height (affects touch targets)</span>
                            </div>
                            <div class="setting-control">
                                <div class="styled-menu" id="menu-btnHeight">
                                    <div class="styled-menu-trigger" data-action="toggle-menu" data-target="menu-btnHeight">
                                        <span class="menu-label">28px (default)</span>
                                        <span class="menu-arrow">▼</span>
                                    </div>
                                    <div class="styled-menu-dropdown" id="menu-btnHeight-dropdown">
                                        <div class="styled-menu-option" data-value="24px" data-action="select-menu-option">24px (compact)</div>
                                        <div class="styled-menu-option selected" data-value="28px" data-action="select-menu-option">28px (default)</div>
                                        <div class="styled-menu-option" data-value="32px" data-action="select-menu-option">32px (comfortable)</div>
                                        <div class="styled-menu-option" data-value="36px" data-action="select-menu-option">36px (large)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
            </div>
            
            <!-- Subtab: Lists -->
            <div id="subtab-lists" class="subtab-content">
                <div class="frappe-settings-grid">
                    
                    <!-- Section Header -->
                    <div class="setting-section-header">List Header</div>
                    
                    <!-- Header Background -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Header Background</span>
                            <span class="setting-desc">Background color for column headers (.list-row-head)</span>
                            <span class="setting-suggestion">💡 Suggest: neutral-100 for subtle contrast</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-listHeaderBg">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-listHeaderBg">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-100</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-listHeaderBg-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Header Text Color -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Header Text Color</span>
                            <span class="setting-desc">Text color for column headers</span>
                            <span class="setting-suggestion">💡 Suggest: neutral-700 for readability</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-listHeaderText">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-listHeaderText">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-700</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-listHeaderText-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Header -->
                    <div class="setting-section-header" style="margin-top: 20px;">Rows</div>
                    
                    <!-- Alternate Row Color (inherited) -->
                    <div class="setting-row inherited">
                        <div class="setting-label">
                            <span class="setting-name">Alternate Row Color</span>
                            <span class="setting-desc">Background for every other row (zebra striping)</span>
                            <span class="setting-inherited">↑ Set in Common Elements</span>
                        </div>
                        <div class="setting-control">
                            <span class="inherited-value inherited-swatch" id="inherited-list-alternate"></span>
                        </div>
                    </div>
                    
                    <!-- Row Border Color -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Row Border Color</span>
                            <span class="setting-desc">Divider line between rows</span>
                            <span class="setting-suggestion">💡 Suggest: neutral-200 for subtle separation</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-listRowBorder">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-listRowBorder">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-200</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-listRowBorder-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Header -->
                    <div class="setting-section-header" style="margin-top: 20px;">Inherited from Common Elements</div>
                    
                    <!-- Row Hover (inherited) -->
                    <div class="setting-row inherited">
                        <div class="setting-label">
                            <span class="setting-name">Row Hover Color</span>
                            <span class="setting-desc">Background when mouse hovers over a row</span>
                            <span class="setting-inherited">↑ Set in Common Elements</span>
                        </div>
                        <div class="setting-control">
                            <span class="inherited-value inherited-swatch" id="inherited-list-hover"></span>
                        </div>
                    </div>
                    
                    <!-- Row Selection (inherited) -->
                    <div class="setting-row inherited">
                        <div class="setting-label">
                            <span class="setting-name">Row Selection Color</span>
                            <span class="setting-desc">Background for selected/checked rows</span>
                            <span class="setting-inherited">↑ Set in Common Elements</span>
                        </div>
                        <div class="setting-control">
                            <span class="inherited-value inherited-swatch" id="inherited-list-selection"></span>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Subtab: Forms -->
            <div id="subtab-forms" class="subtab-content">
                <div class="frappe-settings-grid">
                    
                    <!-- Section Header -->
                    <div class="setting-section-header">Field Labels</div>
                    
                    <!-- Field Label Color -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Label Text Color</span>
                            <span class="setting-desc">Color for field labels (.control-label)</span>
                            <span class="setting-suggestion">💡 Suggest: neutral-700 for readability</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-formLabelColor">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-formLabelColor">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-700</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-formLabelColor-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Required Indicator (inherited from semantic) -->
                    <div class="setting-row inherited">
                        <div class="setting-label">
                            <span class="setting-name">Required Indicator</span>
                            <span class="setting-desc">Color for required field asterisk (*)</span>
                            <span class="setting-inherited">↑ Uses Error color from Core Theme</span>
                        </div>
                        <div class="setting-control">
                            <span class="inherited-value inherited-swatch" id="inherited-form-required"></span>
                        </div>
                    </div>
                    
                    <!-- Section Header -->
                    <div class="setting-section-header" style="margin-top: 20px;">Section Breaks</div>
                    
                    <!-- Section Header Background -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Section Background</span>
                            <span class="setting-desc">Background for section headers (.section-head)</span>
                            <span class="setting-suggestion">💡 Suggest: neutral-300 for visible separation</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-formSectionBg">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-formSectionBg">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-300</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-formSectionBg-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Header Text -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Section Text Color</span>
                            <span class="setting-desc">Text color for section headers</span>
                            <span class="setting-suggestion">💡 Suggest: neutral-800 for emphasis</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-formSectionText">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-formSectionText">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-800</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-formSectionText-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Header -->
                    <div class="setting-section-header" style="margin-top: 20px;">Tabs</div>
                    
                    <!-- Active Tab Color -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Active Tab Color</span>
                            <span class="setting-desc">Underline/highlight for active form tab</span>
                            <span class="setting-suggestion">💡 Suggest: primary-600 to match brand</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-formTabActive">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-formTabActive">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">primary-600</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-formTabActive-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Header -->
                    <div class="setting-section-header" style="margin-top: 20px;">Controls</div>
                    
                    <!-- Checkbox Color -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">--checkbox-color</span>
                            <span class="setting-desc">Check mark color for checkboxes and check icons</span>
                            <span class="setting-suggestion">💡 Suggest: primary-500 for brand consistency</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-checkboxColor">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-checkboxColor">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">primary-500</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-checkboxColor-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Header -->
                    <div class="setting-section-header" style="margin-top: 20px;">Inherited from Common Elements</div>
                    
                    <!-- Input Background (inherited) -->
                    <div class="setting-row inherited">
                        <div class="setting-label">
                            <span class="setting-name">Input Background</span>
                            <span class="setting-desc">Background for text inputs, selects</span>
                            <span class="setting-inherited">↑ Set in Common Elements (--control-bg)</span>
                        </div>
                        <div class="setting-control">
                            <span class="inherited-value inherited-swatch" id="inherited-form-input-bg"></span>
                        </div>
                    </div>
                    
                    <!-- Focus Ring (inherited) -->
                    <div class="setting-row inherited">
                        <div class="setting-label">
                            <span class="setting-name">Focus Ring Color</span>
                            <span class="setting-desc">Glow around focused inputs</span>
                            <span class="setting-inherited">↑ Set in Common Elements</span>
                        </div>
                        <div class="setting-control">
                            <span class="inherited-value inherited-swatch" id="inherited-form-focus"></span>
                        </div>
                    </div>
                    
                    <!-- Border Color (inherited) -->
                    <div class="setting-row inherited">
                        <div class="setting-label">
                            <span class="setting-name">Input Border Color</span>
                            <span class="setting-desc">Border for text inputs, selects</span>
                            <span class="setting-inherited">↑ Set in Common Elements (Default Border)</span>
                        </div>
                        <div class="setting-control">
                            <span class="inherited-value inherited-swatch" id="inherited-form-border"></span>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Subtab: Indicators -->
            <div id="subtab-indicators" class="subtab-content">
                <div class="frappe-settings-grid">
                    
                    <!-- Info Box -->
                    <div class="setting-section-header">About Indicators</div>
                    <div class="setting-row" style="grid-column: 1 / -1;">
                        <div class="setting-label" style="max-width: none;">
                            <span class="setting-desc">Frappe indicators use colored dots/badges to show document status. Most colors are controlled by Semantic Colors in Core Theme.</span>
                        </div>
                    </div>
                    
                    <!-- Section Header -->
                    <div class="setting-section-header" style="margin-top: 12px;">Inherited from Core Theme → Semantic Colors</div>
                    
                    <!-- Green/Success (inherited) -->
                    <div class="setting-row inherited">
                        <div class="setting-label">
                            <span class="setting-name">Green (Submitted, Active)</span>
                            <span class="setting-desc">.indicator.green - Submitted, Paid, Active</span>
                            <span class="setting-inherited">↑ Uses Success color</span>
                        </div>
                        <div class="setting-control">
                            <span class="inherited-value inherited-swatch" id="inherited-indicator-green"></span>
                        </div>
                    </div>
                    
                    <!-- Red/Error (inherited) -->
                    <div class="setting-row inherited">
                        <div class="setting-label">
                            <span class="setting-name">Red (Cancelled, Failed)</span>
                            <span class="setting-desc">.indicator.red - Cancelled, Failed, Overdue</span>
                            <span class="setting-inherited">↑ Uses Error color</span>
                        </div>
                        <div class="setting-control">
                            <span class="inherited-value inherited-swatch" id="inherited-indicator-red"></span>
                        </div>
                    </div>
                    
                    <!-- Orange/Warning (inherited) -->
                    <div class="setting-row inherited">
                        <div class="setting-label">
                            <span class="setting-name">Orange (Pending, Draft)</span>
                            <span class="setting-desc">.indicator.orange - Pending, On Hold, Draft</span>
                            <span class="setting-inherited">↑ Uses Warning color</span>
                        </div>
                        <div class="setting-control">
                            <span class="inherited-value inherited-swatch" id="inherited-indicator-orange"></span>
                        </div>
                    </div>
                    
                    <!-- Section Header -->
                    <div class="setting-section-header" style="margin-top: 20px;">Custom Indicator Colors</div>
                    
                    <!-- Blue/Info -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Blue (Info, In Progress)</span>
                            <span class="setting-desc">.indicator.blue - Draft, In Progress, Info</span>
                            <span class="setting-suggestion">💡 Suggest: primary-500 to match brand</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-indicatorBlue">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-indicatorBlue">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">primary-500</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-indicatorBlue-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Purple -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Purple (Custom)</span>
                            <span class="setting-desc">.indicator.purple - Custom status</span>
                            <span class="setting-suggestion">💡 Pick any color (Frappe default: #743ee2)</span>
                        </div>
                        <div class="setting-control">
                            <input type="color" id="color-indicatorPurple" class="color-input" 
                               >
                        </div>
                    </div>
                    
                    <!-- Gray -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Gray (Disabled, Closed)</span>
                            <span class="setting-desc">.indicator.darkgrey - Disabled, Closed</span>
                            <span class="setting-suggestion">💡 Suggest: neutral-400</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-indicatorGray">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-indicatorGray">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-400</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-indicatorGray-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Subtab: Navigation -->
            <div id="subtab-navigation" class="subtab-content">
                <div class="frappe-settings-grid">
                    
                    <!-- Section Header -->
                    <div class="setting-section-header">Navbar (inherited)</div>
                    
                    <!-- Navbar Theme (inherited) -->
                    <div class="setting-row inherited">
                        <div class="setting-label">
                            <span class="setting-name">Navbar Theme</span>
                            <span class="setting-desc">Top navigation bar color scheme</span>
                            <span class="setting-inherited">↑ Set in Common Elements</span>
                        </div>
                        <div class="setting-control">
                            <span class="inherited-value inherited-swatch" id="inherited-nav-navbar"></span>
                        </div>
                    </div>
                    
                    <!-- Section Header -->
                    <div class="setting-section-header" style="margin-top: 20px;">Sidebar</div>
                    
                    <!-- Sidebar Background -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Sidebar Background</span>
                            <span class="setting-desc">Background for desk sidebar (.desk-sidebar)</span>
                            <span class="setting-suggestion">💡 Suggest: neutral-50 or white</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-sidebarBg">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-sidebarBg">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-50</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-sidebarBg-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sidebar Item Text -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Item Text Color</span>
                            <span class="setting-desc">Text color for sidebar items</span>
                            <span class="setting-suggestion">💡 Suggest: neutral-700</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-sidebarText">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-sidebarText">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-700</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-sidebarText-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sidebar Item Hover -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Item Hover Background</span>
                            <span class="setting-desc">Background when hovering sidebar item</span>
                            <span class="setting-suggestion">💡 Suggest: primary-50</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-sidebarHover">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-sidebarHover">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">primary-50</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-sidebarHover-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sidebar Item Active -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Active Item Background</span>
                            <span class="setting-desc">Background for selected sidebar item</span>
                            <span class="setting-suggestion">💡 Suggest: primary-100</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-sidebarActive">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-sidebarActive">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">primary-100</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-sidebarActive-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sidebar Active Text -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Active Item Text</span>
                            <span class="setting-desc">Text color for selected sidebar item</span>
                            <span class="setting-suggestion">💡 Suggest: primary-700</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-sidebarActiveText">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-sidebarActiveText">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">primary-700</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-sidebarActiveText-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Header -->
                    <div class="setting-section-header" style="margin-top: 20px;">Awesomebar (Search)</div>
                    
                    <!-- Awesomebar Result Hover -->
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-name">Result Hover Background</span>
                            <span class="setting-desc">Background when hovering search result</span>
                            <span class="setting-suggestion">💡 Suggest: primary-50</span>
                        </div>
                        <div class="setting-control">
                            <div class="swatch-picker" id="picker-awesomebarHover">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-awesomebarHover">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">primary-50</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-awesomebarHover-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Subtab: Print -->
            <div id="subtab-print" class="subtab-content">
                
                <!-- Info Box -->
                <p style="font-size: 12px; color: var(--muted-text); margin-bottom: 16px;">
                    <strong>Two palettes:</strong> Full Color for PDF exports, Pure B&W for paper printing.
                    B&W uses true grays with no color cast. Add <code>.print-bw-mode</code> class before printing to activate B&W palette.
                </p>
                
                <!-- Dual Column Layout -->
                <div class="print-dual-grid">
                    
                    <!-- LEFT COLUMN: Full Color (for PDF) -->
                    <div class="print-column">
                        <div class="print-column-header">
                            <span class="color-badge color"></span>
                            Full Color (PDF)
                        </div>
                        
                        <!-- Heading -->
                        <div class="print-setting-row">
                            <span class="print-setting-label">Heading</span>
                            <div class="swatch-picker" id="picker-printHeading">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-printHeading">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">primary-700</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-printHeading-dropdown"></div>
                            </div>
                        </div>
                        
                        <!-- Body Text -->
                        <div class="print-setting-row">
                            <span class="print-setting-label">Body Text</span>
                            <div class="swatch-picker" id="picker-printText">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-printText">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-900</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-printText-dropdown"></div>
                            </div>
                        </div>
                        
                        <!-- Table Header -->
                        <div class="print-setting-row">
                            <span class="print-setting-label">Table Header</span>
                            <div class="swatch-picker" id="picker-printTableHeader">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-printTableHeader">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-100</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-printTableHeader-dropdown"></div>
                            </div>
                        </div>
                        
                        <!-- Table Border -->
                        <div class="print-setting-row">
                            <span class="print-setting-label">Table Border</span>
                            <div class="swatch-picker" id="picker-printTableBorder">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-printTableBorder">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-300</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-printTableBorder-dropdown"></div>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="print-setting-row">
                            <span class="print-setting-label">Footer Text</span>
                            <div class="swatch-picker" id="picker-printFooter">
                                <div class="swatch-picker-trigger" data-action="toggle-swatch-picker" data-target="picker-printFooter">
                                    <div class="trigger-swatch"></div>
                                    <span class="trigger-label">neutral-500</span>
                                    <span class="trigger-arrow">▼</span>
                                </div>
                                <div class="swatch-picker-dropdown" id="picker-printFooter-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RIGHT COLUMN: B&W (for paper printing) -->
                    <div class="print-column">
                        <div class="print-column-header">
                            <span class="color-badge bw"></span>
                            B&W (Paper) 🖨️
                        </div>
                        
                        <!-- Heading B&W -->
                        <div class="print-setting-row">
                            <span class="print-setting-label">Heading</span>
                            <div class="gray-picker" id="gray-printHeadingBW">
                                <div class="gray-picker-trigger" data-action="toggle-gray-picker" data-target="gray-printHeadingBW">
                                    <div class="gray-swatch" style="background: #333333;"></div>
                                    <span class="gray-label">Gray 800</span>
                                    <span class="gray-arrow">▼</span>
                                </div>
                                <div class="gray-picker-dropdown" id="gray-printHeadingBW-dropdown"></div>
                            </div>
                        </div>
                        
                        <!-- Body Text B&W -->
                        <div class="print-setting-row">
                            <span class="print-setting-label">Body Text</span>
                            <div class="gray-picker" id="gray-printTextBW">
                                <div class="gray-picker-trigger" data-action="toggle-gray-picker" data-target="gray-printTextBW">
                                    <div class="gray-swatch" style="background: #1a1a1a;"></div>
                                    <span class="gray-label">Gray 900</span>
                                    <span class="gray-arrow">▼</span>
                                </div>
                                <div class="gray-picker-dropdown" id="gray-printTextBW-dropdown"></div>
                            </div>
                        </div>
                        
                        <!-- Table Header B&W -->
                        <div class="print-setting-row">
                            <span class="print-setting-label">Table Header</span>
                            <div class="gray-picker" id="gray-printTableHeaderBW">
                                <div class="gray-picker-trigger" data-action="toggle-gray-picker" data-target="gray-printTableHeaderBW">
                                    <div class="gray-swatch" style="background: #f5f5f5;"></div>
                                    <span class="gray-label">Gray 100</span>
                                    <span class="gray-arrow">▼</span>
                                </div>
                                <div class="gray-picker-dropdown" id="gray-printTableHeaderBW-dropdown"></div>
                            </div>
                        </div>
                        
                        <!-- Table Border B&W -->
                        <div class="print-setting-row">
                            <span class="print-setting-label">Table Border</span>
                            <div class="gray-picker" id="gray-printTableBorderBW">
                                <div class="gray-picker-trigger" data-action="toggle-gray-picker" data-target="gray-printTableBorderBW">
                                    <div class="gray-swatch" style="background: #cccccc;"></div>
                                    <span class="gray-label">Gray 300</span>
                                    <span class="gray-arrow">▼</span>
                                </div>
                                <div class="gray-picker-dropdown" id="gray-printTableBorderBW-dropdown"></div>
                            </div>
                        </div>
                        
                        <!-- Footer B&W -->
                        <div class="print-setting-row">
                            <span class="print-setting-label">Footer Text</span>
                            <div class="gray-picker" id="gray-printFooterBW">
                                <div class="gray-picker-trigger" data-action="toggle-gray-picker" data-target="gray-printFooterBW">
                                    <div class="gray-swatch" style="background: #888888;"></div>
                                    <span class="gray-label">Gray 500</span>
                                    <span class="gray-arrow">▼</span>
                                </div>
                                <div class="gray-picker-dropdown" id="gray-printFooterBW-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Inherited section -->
                <div style="margin-top: 20px;">
                    <div class="setting-section-header">Inherited from Common Elements</div>
                    <div class="frappe-settings-grid">
                        <div class="setting-row inherited">
                            <div class="setting-label">
                                <span class="setting-name">Alternate Row Color</span>
                                <span class="setting-desc">Zebra striping in print tables</span>
                                <span class="setting-inherited">↑ Set in Common Elements</span>
                            </div>
                            <div class="setting-control">
                                <span class="inherited-value inherited-swatch" id="inherited-print-alternate"></span>
                            </div>
                        </div>
                    </div>
                </div>
                    
                </div>
            </div>
            
        </div><!-- End Tab 2: Frappe Settings -->
        <!-- ═══════════════════════════════════════════════════════════════════════════
             FRAPPE ONLY: HTML END - Tab 2 (Frappe Settings)
             ═══════════════════════════════════════════════════════════════════════════ -->
        
    </div>
    </div>
    
    <div class="notification" id="notification">Copied</div>
    
    <!-- Modal Dialog -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div id="modalContent"></div>
        </div>
    </div>
    
    <script>
    // ═══════════════════════════════════════════════════════════════════════════
    // NCE DESIGN SYSTEM - THEME EDITOR MODULE
    // Wrapped in IIFE for encapsulation
    // ═══════════════════════════════════════════════════════════════════════════
    (function() {
        'use strict';
        
    // ═══════════════════════════════════════════════════════════════════════════
    // DOM CACHE - Cache frequently accessed elements for performance
    // ═══════════════════════════════════════════════════════════════════════════
    const DOM = {
        // Main containers
        body: document.body,
        
        // Editor panels
        editorPanel: null,
        colorPickerPanel: null,
        neutralPickerPanel: null,
        scaleBumpPanel: null,
        
        // Color grids
        primaryGrid: null,
        neutralGrid: null,
        semanticGrid: null,
        windowGrid: null,
        
        // Modal elements
        modalOverlay: null,
        modalContent: null,
        
        // Sliders
        hueSlider: null,
        satSlider: null,
        
        // Preview swatches
        previewSwatch: null,
        neutralPreviewSwatch: null,
        
        // Output areas
        cssOutput: null,
        
        // Initialize cache - called after DOM is ready
        init() {
            this.editorPanel = document.getElementById('editorPanel');
            this.colorPickerPanel = document.getElementById('colorPickerPanel');
            this.neutralPickerPanel = document.getElementById('neutralPickerPanel');
            this.scaleBumpPanel = document.getElementById('scaleBumpPanel');
            
            this.primaryGrid = document.getElementById('primaryGrid');
            this.neutralGrid = document.getElementById('neutralGrid');
            this.semanticGrid = document.getElementById('semanticGrid');
            this.windowGrid = document.getElementById('windowGrid');
            
            this.modalOverlay = document.getElementById('modalOverlay');
            this.modalContent = document.getElementById('modalContent');
            
            this.hueSlider = document.getElementById('hueSlider');
            this.satSlider = document.getElementById('satSlider');
            
            this.previewSwatch = document.getElementById('previewSwatch');
            this.neutralPreviewSwatch = document.getElementById('neutralPreviewSwatch');
            
            this.cssOutput = document.getElementById('cssOutput');
        }
    };
    
    // ═══════════════════════════════════════════════════════════════════════════
    // EVENT DELEGATION - Central event handler for all interactive elements
    // ═══════════════════════════════════════════════════════════════════════════
    function handleDelegatedClick(event) {
        const target = event.target.closest('[data-action]');
        if (!target) return;
        
        const action = target.dataset.action;
        const targetId = target.dataset.target;
        const value = target.dataset.value;
        
        // Prevent default for buttons
        if (target.tagName === 'BUTTON') {
            event.preventDefault();
        }
        
        // Route actions to appropriate handlers
        switch(action) {
            // Tab navigation
            case 'switch-tab':
                switchTab(targetId || value);
                break;
            case 'switch-subtab':
                switchSubtab(targetId || value);
                break;
                
            // Editor actions
            case 'toggle-editor':
                toggleEditor(targetId);
                break;
                
            // Swatch picker actions
            case 'toggle-swatch-picker':
                toggleSwatchPicker(targetId || value);
                break;
            case 'select-swatch':
                selectSwatchOption(targetId, value);
                break;
            case 'eyedropper':
                handleEyedropper();
                break;
                
            // Gray picker actions
            case 'toggle-gray-picker':
                toggleGrayPicker(targetId || value);
                break;
            case 'select-gray':
                const grayName = target.dataset.name || '';
                selectGray(targetId, value, grayName);
                break;
            case 'apply-neutral':
                applyNeutralColor();
                break;
                
            // Scale bump actions
            case 'bump-anchor':
                bumpAnchor(parseInt(value));
                break;
            case 'bump-neutral':
                bumpNeutralScale(parseInt(value));
                break;
                
            // Styled menu actions
            case 'toggle-menu':
                toggleStyledMenu(targetId);
                break;
            case 'select-menu-option':
                selectStyledMenu(targetId, value);
                break;
                
            // Font menu
            case 'select-font':
                selectFontMenu(value);
                break;
                
            // Navbar picker
            case 'toggle-navbar-picker':
                toggleNavbarPicker();
                break;
            case 'select-navbar-theme':
                selectNavbarTheme(value);
                break;
                
            // Typography actions
            case 'toggle-bold':
                toggleBold();
                break;
                
            // Background/gradient actions
            case 'toggle-gradient':
                toggleGradient(target.checked);
                break;
            case 'move-text-flip':
                moveTextFlip(parseInt(value));
                break;
                
            // Modal actions
            case 'show-modal':
                if (targetId === 'save') showSaveModal();
                else if (targetId === 'load') showLoadModal();
                else if (targetId === 'reset') showResetModal();
                break;
            case 'close-modal':
                closeModal();
                break;
            case 'confirm-save':
                confirmSave();
                break;
            case 'confirm-load':
                confirmLoad();
                break;
            case 'confirm-reset':
                confirmReset();
                break;
                
            // Theme management actions
            case 'my-themes':
                showMyThemesModal();
                break;
            case 'save-as-new':
                showSaveAsNewModal();
                break;
            case 'update-theme':
                updateCurrentTheme();
                break;
            case 'revert':
                revertTheme();
                break;
            case 'load-theme':
                loadThemeFromDocType(target.dataset.name);
                break;
            case 'download-theme':
                downloadThemeFromDocType(target.dataset.name);
                break;
            case 'delete-theme':
                confirmDeleteTheme(target.dataset.name);
                break;
            case 'show-json':
                showThemeJSON(target.dataset.name);
                break;
                
            // Copy CSS
            case 'copy-css':
                copyCSS();
                break;
                
            default:
                console.log('Unhandled action:', action, 'target:', targetId, 'value:', value);
        }
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // INITIALIZATION - Set up event delegation after DOM is ready
    // ═══════════════════════════════════════════════════════════════════════════
    function initializeApp() {
        // Cache DOM elements
        DOM.init();
        
        // Set up event delegation for clicks and changes
        document.addEventListener('click', handleDelegatedClick);
        document.addEventListener('change', handleDelegatedClick);
        
        // Initialize neutral picker
        buildNeutralGrid();
        if (DOM.neutralPreviewSwatch) {
            DOM.neutralPreviewSwatch.style.backgroundColor = hsvToHex(210, 8, 62);
        }
        
        // Initialize color grids and UI
        buildColorGrid();
        updateUI();
        
        // Initialize draggable modal
        initDraggableEditor();
        
        console.log('✅ NCE Theme Editor initialized');
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // FRAPPE ONLY: JS START - Tab/Subtab Switching
    // ═══════════════════════════════════════════════════════════════════════════
    
    function switchTab(tabId) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            // Check both data-target and data-value for compatibility
            if (btn.dataset.target === tabId || btn.dataset.value === tabId) {
                btn.classList.add('active');
            }
        });
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        const targetTab = document.getElementById('tab-' + tabId);
        if (targetTab) {
            targetTab.classList.add('active');
        }
    }
    
    function switchSubtab(subtabId) {
        // Update subtab buttons
        document.querySelectorAll('.subtab-btn').forEach(btn => {
            btn.classList.remove('active');
            // Check both data-target and data-value for compatibility
            if (btn.dataset.target === subtabId || btn.dataset.value === subtabId) {
                btn.classList.add('active');
            }
        });
        
        // Update subtab content
        document.querySelectorAll('.subtab-content').forEach(content => {
            content.classList.remove('active');
        });
        const targetSubtab = document.getElementById('subtab-' + subtabId);
        if (targetSubtab) {
            targetSubtab.classList.add('active');
        }
    }
    
    function updateFrappeState(key, value) {
        frappeState[key] = value;
        console.log('Frappe state updated:', key, '=', value);
    }
    // ═══════════════════════════════════════════════════════════════════════════
    // FRAPPE ONLY: JS END - Tab/Subtab Switching
    // ═══════════════════════════════════════════════════════════════════════════
    
    function getTokenColor(token) {
        // Handle special values
        if (token === 'white') return '#ffffff';
        if (token === 'black') return '#000000';
        
        // Parse token like "primary-50" or "neutral-300"
        const [type, shade] = token.split('-');
        const shadeNum = parseInt(shade);

        if (type === 'primary') {
            // If this is the anchor shade, return exact hex
            if (state.anchorShade === shadeNum && state.anchorHex) {
                return state.anchorHex;
            }
            
            const shades = CONFIG.primaryShades;
            const currentIdx = shades.findIndex(s => s.shade === shadeNum);
            
            if (currentIdx !== -1) {
                let config = shades[currentIdx];
                
                if (state.anchorShade && state.anchorL !== null) {
                    // Anchor mode: calculate lightness relative to anchor
                    const anchorConfig = shades.find(s => s.shade === state.anchorShade);
                    if (anchorConfig) {
                        const offset = state.anchorL - anchorConfig.l;
                        const adjustedL = Math.max(5, Math.min(98, config.l + offset));
                        return hslToHex(state.primaryHue, state.primarySat || config.s, adjustedL);
                    }
                } else if (state.shadeOffset) {
                    // Quantum shift mode: use config from shifted index
                    const shiftedIdx = Math.max(0, Math.min(shades.length - 1, currentIdx + state.shadeOffset));
                    config = shades[shiftedIdx];
                }
                
                return hslToHex(state.primaryHue, state.primarySat || config.s, config.l);
            }
        } else if (type === 'neutral') {
            const shades = CONFIG.neutralShades;
            const currentIdx = shades.findIndex(s => s.shade === shadeNum);
            let config = shades.find(s => s.shade === shadeNum);
            
            // Apply neutral offset (bump)
            if (state.neutralOffset && currentIdx !== -1) {
                const shiftedIdx = Math.max(0, Math.min(shades.length - 1, currentIdx + state.neutralOffset));
                config = shades[shiftedIdx];
            }
            
            if (config) return hslToHex(state.neutralHue, config.s, config.l);
        }
        return '#cccccc';
    }
    
    // Get nested panel color (progressively darker behind white container)
    // Container is always white → Nested panels behind it go progressively darker
    function getNestedPanelColor(level = 1) {
        const baseL = 100; // Start from white (the container)
        
        // 4% lightness step per level - going darker
        const stepPercent = 4;
        const lightnessChange = stepPercent * level;
        
        // Always go darker from white container
        const newL = Math.max(5, baseL - lightnessChange);
        
        // Return neutral gray (same saturation as neutral tokens: 5%)
        return hslToHex(state.neutralHue, 5, newL);
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // FRAPPE ONLY: JS START - Frappe Settings UI Functions
    // (initFrappeSwatches, updateInheritedSwatches, swatch pickers for Frappe settings)
    // ═══════════════════════════════════════════════════════════════════════════
    
    // Pure Gray Palette (no color cast)
    const PURE_GRAYS = [
        { name: 'White', hex: '#ffffff' },
        { name: 'Gray 50', hex: '#fafafa' },
        { name: 'Gray 100', hex: '#f5f5f5' },
        { name: 'Gray 200', hex: '#eeeeee' },
        { name: 'Gray 300', hex: '#cccccc' },
        { name: 'Gray 400', hex: '#aaaaaa' },
        { name: 'Gray 500', hex: '#888888' },
        { name: 'Gray 600', hex: '#666666' },
        { name: 'Gray 700', hex: '#444444' },
        { name: 'Gray 800', hex: '#333333' },
        { name: 'Gray 900', hex: '#1a1a1a' },
        { name: 'Black', hex: '#000000' }
    ];
    
    function toggleGrayPicker(pickerId) {
        const dropdown = document.getElementById(pickerId + '-dropdown');
        
        // Build dropdown if not built yet
        if (!dropdown.dataset.built) {
            buildGrayDropdown(pickerId);
        }
        
        // Close other dropdowns
        document.querySelectorAll('.gray-picker-dropdown, .swatch-picker-dropdown, .styled-menu-dropdown').forEach(d => {
            if (d.id !== pickerId + '-dropdown') d.classList.remove('open');
        });
        
        dropdown.classList.toggle('open');
    }
    
    function buildGrayDropdown(pickerId) {
        const dropdown = document.getElementById(pickerId + '-dropdown');
        const stateKey = pickerId.replace('gray-', '');
        const currentValue = frappeState[stateKey];
        
        let html = '<div class="gray-grid">';
        PURE_GRAYS.forEach(gray => {
            const selected = currentValue === gray.hex ? 'selected' : '';
            html += `<div class="gray-option ${selected}" 
                         style="background: ${gray.hex}; ${gray.hex === '#ffffff' ? 'border: 1px solid #ddd;' : ''}"
                         data-hex="${gray.hex}" 
                         data-name="${gray.name}"
                         data-action="select-gray"
                         data-target="${pickerId}"
                         data-value="${gray.hex}"
                         title="${gray.name}"></div>`;
        });
        html += '</div>';
        
        dropdown.innerHTML = html;
        dropdown.dataset.built = 'true';
    }
    
    function selectGray(pickerId, hex, name) {
        const stateKey = pickerId.replace('gray-', '');
        frappeState[stateKey] = hex;
        
        // Update trigger display
        const picker = document.getElementById(pickerId);
        const swatch = picker.querySelector('.gray-swatch');
        const label = picker.querySelector('.gray-label');
        
        if (swatch) swatch.style.background = hex;
        if (label) label.textContent = name;
        
        // Update selected state in dropdown
        const dropdown = document.getElementById(pickerId + '-dropdown');
        dropdown.querySelectorAll('.gray-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.hex === hex);
        });
        
        // Close dropdown
        dropdown.classList.remove('open');
        
        console.log('B&W state updated:', stateKey, '=', hex);
    }
    
    function initGrayPickers() {
        // Initialize all gray pickers with current state
        const grayPickers = ['printHeadingBW', 'printTextBW', 'printTableHeaderBW', 'printTableBorderBW', 'printFooterBW'];
        
        grayPickers.forEach(key => {
            const picker = document.getElementById('gray-' + key);
            if (!picker) return;
            
            const hex = frappeState[key];
            const gray = PURE_GRAYS.find(g => g.hex === hex) || { name: 'Custom', hex: hex };
            
            const swatch = picker.querySelector('.gray-swatch');
            const label = picker.querySelector('.gray-label');
            
            if (swatch) swatch.style.background = hex;
            if (label) label.textContent = gray.name;
        });
    }
    
    function updateSwatch(swatchId, token) {
        const swatch = document.getElementById('swatch-' + swatchId);
        if (swatch) {
            swatch.style.backgroundColor = getTokenColor(token);
        }
    }
    
    function updateNavbarSwatch(theme) {
        const swatch = document.getElementById('swatch-navbar');
        if (!swatch) return;
        
        if (theme === 'dark') {
            swatch.style.backgroundColor = getTokenColor('neutral-900');
        } else if (theme === 'light') {
            swatch.style.backgroundColor = '#ffffff';
        } else if (theme === 'primary') {
            swatch.style.backgroundColor = getTokenColor('primary-700');
        }
    }
    
    function initFrappeSwatches() {
        // Init navbar picker
        initNavbarPicker();
        
        // Update inherited swatches from Core Theme
        const primarySwatch = document.getElementById('inherited-primary');
        if (primarySwatch) {
            primarySwatch.style.backgroundColor = getTokenColor('primary-600');
        }
        
        const bgSwatch = document.getElementById('inherited-bg-color');
        if (bgSwatch) {
            // Page background - read from Core Theme state
            bgSwatch.style.backgroundColor = getTokenColor(state.pageBg);
            if (state.pageBg === 'white') {
                bgSwatch.style.border = '1px solid #ddd';
            }
        }
        
        const fgSwatch = document.getElementById('inherited-fg-color');
        if (fgSwatch) {
            // Panel/card background - read from Core Theme state
            fgSwatch.style.backgroundColor = getTokenColor(state.panelBg);
            if (state.panelBg === 'white') {
                fgSwatch.style.border = '1px solid #ddd';
            }
        }
        
        // Update inherited list swatches (from Common Elements)
        const listHoverSwatch = document.getElementById('inherited-list-hover');
        if (listHoverSwatch) {
            listHoverSwatch.style.backgroundColor = getTokenColor(frappeState.rowHoverColor);
        }
        
        const listSelectionSwatch = document.getElementById('inherited-list-selection');
        if (listSelectionSwatch) {
            listSelectionSwatch.style.backgroundColor = getTokenColor(frappeState.rowSelectionColor);
        }
        
        const listAlternateSwatch = document.getElementById('inherited-list-alternate');
        if (listAlternateSwatch) {
            listAlternateSwatch.style.backgroundColor = getTokenColor(frappeState.alternateRowColor);
        }
        
        // Form inherited swatches
        const formRequiredSwatch = document.getElementById('inherited-form-required');
        if (formRequiredSwatch) {
            // Uses error color from semantic colors
            formRequiredSwatch.style.backgroundColor = hslToHex(state.error.h, state.error.s, Math.min(state.error.l, 50));
        }
        
        const formInputBgSwatch = document.getElementById('inherited-form-input-bg');
        if (formInputBgSwatch) {
            formInputBgSwatch.style.backgroundColor = getTokenColor(frappeState.controlBg);
        }
        
        const formFocusSwatch = document.getElementById('inherited-form-focus');
        if (formFocusSwatch) {
            formFocusSwatch.style.backgroundColor = getTokenColor(frappeState.focusRingColor);
        }
        
        const formBorderSwatch = document.getElementById('inherited-form-border');
        if (formBorderSwatch) {
            formBorderSwatch.style.backgroundColor = getTokenColor(frappeState.defaultBorderColor);
        }
        
        // Indicator inherited swatches (from semantic colors - use exact same color)
        const indicatorGreen = document.getElementById('inherited-indicator-green');
        if (indicatorGreen) {
            indicatorGreen.style.backgroundColor = hslToHex(state.success.h, state.success.s, state.success.l);
        }
        
        const indicatorRed = document.getElementById('inherited-indicator-red');
        if (indicatorRed) {
            indicatorRed.style.backgroundColor = hslToHex(state.error.h, state.error.s, state.error.l);
        }
        
        const indicatorOrange = document.getElementById('inherited-indicator-orange');
        if (indicatorOrange) {
            indicatorOrange.style.backgroundColor = hslToHex(state.warning.h, state.warning.s, state.warning.l);
        }
        
        // Navigation inherited swatches
        const navNavbar = document.getElementById('inherited-nav-navbar');
        if (navNavbar) {
            const theme = frappeState.navbarTheme;
            if (theme === 'dark') {
                navNavbar.style.backgroundColor = '#1a1a1a';
            } else if (theme === 'light') {
                navNavbar.style.backgroundColor = '#ffffff';
                navNavbar.style.border = '1px solid #ddd';
            } else {
                navNavbar.style.backgroundColor = getTokenColor('primary-700');
            }
        }
        
        // Update all swatch pickers
        document.querySelectorAll('.swatch-picker').forEach(picker => {
            updateSwatchPicker(picker);
        });
        
        // Initialize color inputs
        initColorInputs();
        
        // Initialize B&W gray pickers
        initGrayPickers();
    }
    
    // Swatch Picker Functions
    const SHADES = ['50', '100', '200', '300', '400', '500', '600', '700', '800', '900'];
    
    function buildSwatchGrid(pickerId) {
        const dropdown = document.getElementById(pickerId + '-dropdown');
        if (!dropdown || dropdown.dataset.built) return;
        
        const stateKey = pickerId.replace('picker-', '');
        
        // Determine which state to read from
        const coreKeys = ['pageBg', 'panelBg'];
        const currentValue = coreKeys.includes(stateKey) ? state[stateKey] : frappeState[stateKey];
        
        // Include white option for background pickers
        const includeWhite = ['pageBg', 'panelBg'].includes(stateKey);
        
        let html = '';
        
        if (includeWhite) {
            html += `
            <div class="swatch-grid-section">
                <div class="swatch-grid-label">Special</div>
                <div class="swatch-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="swatch-grid-item${currentValue === 'white' ? ' selected' : ''}" 
                        data-value="white" data-shade="white" style="background: #fff; border: 1px solid #ddd;"
                        data-action="select-swatch" data-target="${pickerId}"
                       ></div>
                    <div class="swatch-grid-item${currentValue === 'black' ? ' selected' : ''}" 
                        data-value="black" data-shade="black" style="background: #000;"
                        data-action="select-swatch" data-target="${pickerId}"
                       ></div>
                </div>
            </div>`;
        }
        
        // Panel background should only show neutrals (Apple/Google HIG)
        const neutralOnly = stateKey === 'panelBg';
        
        if (!neutralOnly) {
            html += `
            <div class="swatch-grid-section">
                <div class="swatch-grid-label">Primary</div>
                <div class="swatch-grid">
                    ${SHADES.map(s => `<div class="swatch-grid-item${currentValue === 'primary-'+s ? ' selected' : ''}" 
                        data-value="primary-${s}" data-shade="${s}" 
                        data-action="select-swatch" data-target="${pickerId}"
                       ></div>`).join('')}
                </div>
            </div>`;
        }
        
        html += `
            <div class="swatch-grid-section">
                <div class="swatch-grid-label">Neutral</div>
                <div class="swatch-grid">
                    ${SHADES.map(s => `<div class="swatch-grid-item${currentValue === 'neutral-'+s ? ' selected' : ''}" 
                        data-value="neutral-${s}" data-shade="${s}" 
                        data-action="select-swatch" data-target="${pickerId}"
                       ></div>`).join('')}
                </div>
            </div>`;
        
        dropdown.innerHTML = html;
        dropdown.dataset.built = 'true';
        updateSwatchGridColors(pickerId);
    }
    
    function updateSwatchGridColors(pickerId) {
        const dropdown = document.getElementById(pickerId + '-dropdown');
        if (!dropdown) return;
        
        dropdown.querySelectorAll('.swatch-grid-item').forEach(item => {
            const value = item.dataset.value;
            item.style.backgroundColor = getTokenColor(value);
        });
    }
    
    function toggleSwatchPicker(pickerId) {
        const dropdown = document.getElementById(pickerId + '-dropdown');
        const isOpen = dropdown.classList.contains('open');
        
        // Close all dropdowns first
        document.querySelectorAll('.swatch-picker-dropdown').forEach(d => d.classList.remove('open'));
        
        // Build and toggle this one
        if (!isOpen) {
            buildSwatchGrid(pickerId);
            dropdown.classList.add('open');
        }
    }
    
    function selectSwatchOption(pickerId, value) {
        const stateKey = pickerId.replace('picker-', '');
        
        // Check if this is a Core Theme picker or Frappe picker
        const coreKeys = ['pageBg', 'panelBg'];
        if (coreKeys.includes(stateKey)) {
            state[stateKey] = value;
            updateUI(); // Refresh Core Theme UI
        } else {
            frappeState[stateKey] = value;
        }
        
        // Update trigger display
        const trigger = document.querySelector(`#${pickerId} .trigger-swatch`);
        const triggerLabel = document.querySelector(`#${pickerId} .trigger-label`);
        if (trigger) trigger.style.backgroundColor = getTokenColor(value);
        if (triggerLabel) triggerLabel.textContent = value;
        
        // Update selected state in grid
        const dropdown = document.getElementById(pickerId + '-dropdown');
        dropdown.querySelectorAll('.swatch-grid-item').forEach(item => {
            item.classList.toggle('selected', item.dataset.value === value);
        });
        
        // Close dropdown
        dropdown.classList.remove('open');
        
        // Update inherited swatches that may depend on this value
        updateInheritedSwatches();
        
        console.log('State updated:', stateKey, '=', value);
    }
    
    // Update all inherited swatches when parent values change
    function updateInheritedSwatches() {
        // Common Elements inherited in Lists
        const listHover = document.getElementById('inherited-list-hover');
        if (listHover) listHover.style.backgroundColor = getTokenColor(frappeState.rowHoverColor);
        
        const listSelection = document.getElementById('inherited-list-selection');
        if (listSelection) listSelection.style.backgroundColor = getTokenColor(frappeState.rowSelectionColor);
        
        const listAlternate = document.getElementById('inherited-list-alternate');
        if (listAlternate) listAlternate.style.backgroundColor = getTokenColor(frappeState.alternateRowColor);
        
        // Common Elements inherited in Forms
        const formInputBg = document.getElementById('inherited-form-input-bg');
        if (formInputBg) formInputBg.style.backgroundColor = getTokenColor(frappeState.controlBg);
        
        const formFocus = document.getElementById('inherited-form-focus');
        if (formFocus) formFocus.style.backgroundColor = getTokenColor(frappeState.focusRingColor);
        
        const formBorder = document.getElementById('inherited-form-border');
        if (formBorder) formBorder.style.backgroundColor = getTokenColor(frappeState.defaultBorderColor);
        
        // Navbar inherited in Navigation
        const navNavbar = document.getElementById('inherited-nav-navbar');
        if (navNavbar) {
            const theme = frappeState.navbarTheme;
            navNavbar.style.border = 'none';
            if (theme === 'dark') {
                navNavbar.style.backgroundColor = '#1a1a1a';
            } else if (theme === 'light') {
                navNavbar.style.backgroundColor = '#ffffff';
                navNavbar.style.border = '1px solid #ddd';
            } else {
                navNavbar.style.backgroundColor = getTokenColor('primary-700');
            }
        }
        
        // Core Theme inherited in Frappe CSS Variables
        const primarySwatch = document.getElementById('inherited-primary');
        if (primarySwatch) primarySwatch.style.backgroundColor = getTokenColor('primary-600');
        
        const bgSwatch = document.getElementById('inherited-bg-color');
        if (bgSwatch) {
            bgSwatch.style.backgroundColor = getTokenColor(state.pageBg);
            bgSwatch.style.border = state.pageBg === 'white' ? '1px solid #ddd' : 'none';
        }
        
        const fgSwatch = document.getElementById('inherited-fg-color');
        if (fgSwatch) {
            fgSwatch.style.backgroundColor = getTokenColor(state.panelBg);
            fgSwatch.style.border = state.panelBg === 'white' ? '1px solid #ddd' : 'none';
        }
        
        // Print inherited
        const printAlternate = document.getElementById('inherited-print-alternate');
        if (printAlternate) printAlternate.style.backgroundColor = getTokenColor(frappeState.alternateRowColor);
    }
    
    function updateSwatchPicker(picker) {
        const pickerId = picker.id;
        const stateKey = pickerId.replace('picker-', '');

        // Determine which state to read from
        const coreKeys = ['pageBg', 'panelBg'];
        const value = coreKeys.includes(stateKey) ? state[stateKey] : frappeState[stateKey];

        // Update trigger swatch color
        const trigger = picker.querySelector('.trigger-swatch');
        const triggerLabel = picker.querySelector('.trigger-label');
        if (trigger && value) {
            trigger.style.backgroundColor = getTokenColor(value);
            if (value === 'white') {
                trigger.style.border = '1px solid #ddd';
            } else {
                trigger.style.border = 'none';
            }
        }
        if (triggerLabel && value) {
            triggerLabel.textContent = value;
        }

        // Rebuild grid colors - force rebuild to reflect offset changes
        const dropdown = document.getElementById(pickerId + '-dropdown');
        if (dropdown) {
            dropdown.dataset.built = '';  // Force rebuild with new colors
            // If dropdown is visible, rebuild now
            if (dropdown.classList.contains('active')) {
                buildSwatchGrid(dropdown, pickerId, stateKey);
            }
        }
    }
    
    // Navbar Theme Picker Functions
    function toggleNavbarPicker() {
        const dropdown = document.getElementById('picker-navbarTheme-dropdown');
        const isOpen = dropdown.classList.contains('open');
        
        // Close all dropdowns first
        document.querySelectorAll('.swatch-picker-dropdown').forEach(d => d.classList.remove('open'));
        
        if (!isOpen) {
            // Update primary swatch color
            const primarySwatch = document.getElementById('navbar-primary-swatch');
            if (primarySwatch) {
                primarySwatch.style.backgroundColor = getTokenColor('primary-700');
            }
            dropdown.classList.add('open');
        }
    }
    
    function selectNavbarTheme(value, label) {
        frappeState.navbarTheme = value;
        
        // Update trigger
        const triggerSwatch = document.getElementById('navbar-trigger-swatch');
        const triggerLabel = document.getElementById('navbar-trigger-label');
        
        if (value === 'dark') {
            triggerSwatch.style.backgroundColor = '#1a1a1a';
        } else if (value === 'light') {
            triggerSwatch.style.backgroundColor = '#ffffff';
            triggerSwatch.style.border = '1px solid #ddd';
        } else {
            triggerSwatch.style.backgroundColor = getTokenColor('primary-700');
            triggerSwatch.style.border = 'none';
        }
        triggerLabel.textContent = label;
        
        // Update selected state
        document.querySelectorAll('#picker-navbarTheme-dropdown .swatch-picker-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.value === value);
        });
        
        // Close dropdown
        document.getElementById('picker-navbarTheme-dropdown').classList.remove('open');
        
        // Update inherited swatches that depend on this
        updateInheritedSwatches();
        
        console.log('Navbar theme:', value);
    }
    
    function initNavbarPicker() {
        const value = frappeState.navbarTheme;
        const triggerSwatch = document.getElementById('navbar-trigger-swatch');
        const triggerLabel = document.getElementById('navbar-trigger-label');
        
        if (value === 'dark') {
            triggerSwatch.style.backgroundColor = '#1a1a1a';
            triggerLabel.textContent = 'Dark';
        } else if (value === 'light') {
            triggerSwatch.style.backgroundColor = '#ffffff';
            triggerSwatch.style.border = '1px solid #ddd';
            triggerLabel.textContent = 'Light';
        } else {
            triggerSwatch.style.backgroundColor = getTokenColor('primary-700');
            triggerLabel.textContent = 'Primary';
        }
    }
    
    // Color Input Functions
    function updateColorInput(key, hexValue) {
        frappeState[key] = hexValue;
        console.log('Color updated:', key, '=', hexValue);
    }
    
    function initColorInputs() {
        // Initialize purple indicator with Frappe's default purple
        const purpleInput = document.getElementById('color-indicatorPurple');
        if (purpleInput) {
            purpleInput.value = frappeState.indicatorPurple;
        }
    }
    
    // Styled Menu Functions
    function toggleStyledMenu(menuId) {
        const dropdown = document.getElementById(menuId + '-dropdown');
        const isOpen = dropdown.classList.contains('open');
        
        // Close all dropdowns first
        document.querySelectorAll('.swatch-picker-dropdown, .styled-menu-dropdown').forEach(d => d.classList.remove('open'));
        
        if (!isOpen) {
            dropdown.classList.add('open');
        }
    }
    
    function selectStyledMenu(stateKey, value, label) {
        frappeState[stateKey] = value;
        
        // Update trigger label
        const menu = document.getElementById('menu-' + stateKey);
        const triggerLabel = menu.querySelector('.menu-label');
        if (triggerLabel) triggerLabel.textContent = label;
        
        // Update selected state
        menu.querySelectorAll('.styled-menu-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.value === value);
        });
        
        // Close dropdown
        document.getElementById('menu-' + stateKey + '-dropdown').classList.remove('open');
        
        // Update inherited swatches
        updateInheritedSwatches();
        
        console.log('Frappe state updated:', stateKey, '=', value);
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.swatch-picker') && !e.target.closest('.styled-menu') && !e.target.closest('.gray-picker')) {
            document.querySelectorAll('.swatch-picker-dropdown, .styled-menu-dropdown, .gray-picker-dropdown').forEach(d => d.classList.remove('open'));
        }
    });
    // ═══════════════════════════════════════════════════════════════════════════
    // FRAPPE ONLY: JS END - Frappe Settings UI Functions
    // ═══════════════════════════════════════════════════════════════════════════
    
    // ═══════════════════════════════════════════════════════════════════════════
    // MODAL DIALOG (SHARED)
    // ═══════════════════════════════════════════════════════════════════════════
    
    function showResetModal() {
        document.getElementById('modalContent').innerHTML = `
            <div class="modal-title">Reset to Defaults</div>
            <div class="modal-message">This will reset all colors to default values. Your current theme will be lost unless saved first.</div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" data-action="close-modal" data-action="close-modal">Cancel</button>
                <button class="btn btn-primary" data-action="confirm-reset">Reset</button>
            </div>
        `;
        document.getElementById('modalOverlay').classList.add('show');
    }
    
    function confirmReset() {
        closeModal();
        localStorage.removeItem('colorEditorState');
        state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        updateUI();
    }
    
    function showLoadModal() {
        document.getElementById('modalContent').innerHTML = `
            <div class="modal-title">Load Theme</div>
            <div class="modal-message">Loading a theme will overwrite your current settings. Save your current theme first if you want to keep it.</div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" data-action="close-modal">Cancel</button>
                <button class="btn btn-primary" data-action="confirm-load">Continue</button>
            </div>
        `;
        document.getElementById('modalOverlay').classList.add('show');
    }
    
    function confirmLoad() {
        closeModal();
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const theme = JSON.parse(event.target.result);
                    
                    if (!theme.colors) {
                        showErrorModal('Invalid theme file format');
                        return;
                    }
                    
                    if (theme.colors.primary) {
                        state.primaryHue = theme.colors.primary.hue;
                        state.defaultShade = theme.colors.primary.defaultShade || 400;
                    }
                    if (theme.colors.neutral) state.neutralHue = theme.colors.neutral.hue;
                    if (theme.colors.semantic) {
                        if (theme.colors.semantic.success) state.success = theme.colors.semantic.success;
                        if (theme.colors.semantic.error) state.error = theme.colors.semantic.error;
                        if (theme.colors.semantic.warning) state.warning = theme.colors.semantic.warning;
                    }
                    if (theme.colors.window) {
                        if (theme.colors.window.close) state.close = theme.colors.window.close;
                        if (theme.colors.window.minimize) state.minimize = theme.colors.window.minimize;
                        if (theme.colors.window.maximize) state.maximize = theme.colors.window.maximize;
                    }
                    if (theme.colors.buttons?.gradient) {
                        state.gradient.angle = theme.colors.buttons.gradient.angle;
                    }
                    
                    updateUI();
                } catch (err) {
                    showErrorModal('Failed to load theme: ' + err.message);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }
    
    function showSaveModal() {
        const timestamp = new Date().toISOString().split('T')[0];
        const defaultName = `NCE Theme ${timestamp}`;
        
        document.getElementById('modalContent').innerHTML = `
            <div class="modal-title">Save Theme</div>
            <div class="modal-message">Choose a name for your theme:</div>
            <input type="text" class="modal-input" id="themeNameInput" value="${defaultName}" placeholder="Theme name">
            <div class="modal-buttons">
                <button class="btn btn-secondary" data-action="close-modal">Cancel</button>
                <button class="btn btn-primary" data-action="confirm-save">Save</button>
            </div>
        `;
        
        document.getElementById('modalOverlay').classList.add('show');
        
        setTimeout(() => {
            const input = document.getElementById('themeNameInput');
            input.focus();
            input.select();
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') confirmSave();
            });
        }, 100);
    }
    
    function confirmSave() {
        const themeName = document.getElementById('themeNameInput').value.trim() || 'NCE Theme';
        const timestamp = new Date().toISOString().split('T')[0];
        
        // W3C Design Tokens Format (2025.10)
        // https://www.w3.org/community/design-tokens/
        const theme = {
            "$name": themeName,
            "$description": "NCE Design System theme for business web applications and Frappe applications. Hue-based color system with AI agent guidance.",
            "$version": "1.0.0",
            "$created": new Date().toISOString(),
            
            // ═══════════════════════════════════════════════════════════════
            // $extensions - Custom metadata including AI agent guidance
            // ═══════════════════════════════════════════════════════════════
            "$extensions": {
                "nce-design-system": {
                    "philosophy": {
                        "purpose": "Business web applications and Frappe applications",
                        "principles": [
                            "Usability, clarity, and visual hierarchy",
                            "Color hue as the central organizing principle",
                            "Style differences reflect functional distinctions, not decorative whim",
                            "Color and emphasis must communicate meaning"
                        ],
                        "consistency": "Where a style is defined for a UI element, apply it consistently to the same element type across the application. This ensures visual continuity and reinforces learned user behavior."
                    },
                    "agentGuidance": {
                        "colorSelection": {
                            "hueSystem": "Each hue provides related variants with controlled saturation and lightness. These variants work together as coherent palettes, not isolated colors.",
                            "textContrast": "Text colors are automatically chosen to ensure sufficient contrast and legibility, especially for alerts and status elements.",
                            "actionWeight": {
                                "highImpact": "Darker colors (shades 600-900) for irreversible or high-impact actions: Save, Reset, Exit, Quit, Delete",
                                "lowImpact": "Lighter variants (shades 100-400) for lower-priority or less consequential actions"
                            }
                        },
                        "neutralUsage": {
                            "purpose": "Provide visual rest and contrast where strong colors would be distracting",
                            "applications": [
                                "Page backgrounds",
                                "Alternating row backgrounds in lists",
                                "Low-contrast structural elements"
                            ]
                        },
                        "decisionRules": {
                            "undefinedElements": "If a UI element is not explicitly defined, choose styles within the existing theme gamut, maintaining consistency with the overall design system.",
                            "functionalAreas": "Elements within the same functional area should NOT use different colors for visual variety alone.",
                            "meaningfulDifference": "Style differences must reflect functional distinctions, not decorative whim.",
                            "whenInDoubt": "Choose the more subtle/neutral option — it is easier to add emphasis than remove it."
                        },
                        "rules": {
                            "do": [
                                "Use the defined shade scale (50-900) — never interpolate custom lightness values",
                                "Match button importance to action consequence (darker = more impactful)",
                                "Use semantic colors (success/error/warning) only for their intended meaning",
                                "Maintain consistent element styling within functional areas"
                            ],
                            "dont": [
                                "Never use raw hex/rgb colors — always reference theme variables",
                                "Never mix hues within the same component for decoration",
                                "Never use primary colors for neutral structural elements",
                                "Never choose colors based on visual variety alone"
                            ]
                        }
                    },
                    "shadeGuide": {
                        "50-100": "Backgrounds, subtle highlights, hover states on light elements",
                        "200-300": "Borders, dividers, disabled backgrounds, secondary surfaces",
                        "400-500": "Default interactive elements, icons, secondary text",
                        "600-700": "Primary buttons, links, active states, emphasis",
                        "800-900": "High-impact actions, critical buttons, primary text"
                    },
                    "componentGuidance": {
                        "buttons": {
                            "primary": "High-impact actions. Use primary-600 to primary-800.",
                            "secondary": "Standard actions. Use primary-300 to primary-500.",
                            "tertiary": "Low-priority actions. Use neutral-200 with neutral-700 text.",
                            "danger": "Destructive actions. Use error hue at shade 600-700."
                        },
                        "backgrounds": {
                            "page": "neutral-50 or neutral-100",
                            "card": "white or neutral-50",
                            "alternatingRows": "Alternate between neutral-50 and white",
                            "selected": "primary-100",
                            "hover": "primary-50 or neutral-100"
                        },
                        "text": {
                            "primary": "neutral-900 (high emphasis)",
                            "secondary": "neutral-600 (medium emphasis)",
                            "disabled": "neutral-400",
                            "onDarkBackground": "neutral-50 or white"
                        },
                        "borders": {
                            "subtle": "neutral-200",
                            "default": "neutral-300",
                            "emphasis": "primary-300",
                            "focus": "primary-500"
                        }
                    }
                }
            },
            
            // ═══════════════════════════════════════════════════════════════
            // PRIMARY COLOR - Brand hue with full shade scale
            // ═══════════════════════════════════════════════════════════════
            "primary": {
                "$description": "Primary brand color. Use for CTAs, links, interactive elements, and brand emphasis.",
                "hue": {
                    "$type": "number",
                    "$value": state.primaryHue,
                    "$description": "Primary hue value (0-360 degrees on color wheel)"
                },
                "defaultShade": {
                    "$type": "number",
                    "$value": state.defaultShade,
                    "$description": "Default shade for primary color (50-900)"
                },
                "textFlipShade": {
                    "$type": "number",
                    "$value": state.textFlipShade,
                    "$description": "Shade threshold where button text flips from dark to light"
                },
                "shades": {
                    "$description": "Full primary shade scale - all available for designer use",
                    ...Object.fromEntries(
                        CONFIG.primaryShades.map(({shade, s, l}) => [
                            shade.toString(),
                            {
                                "$type": "color",
                                "$value": hslToHex(state.primaryHue, s, l + (state.primaryOffset || 0))
                            }
                        ])
                    )
                }
            },
            
            // ═══════════════════════════════════════════════════════════════
            // NEUTRAL COLOR - Grays with full shade scale
            // ═══════════════════════════════════════════════════════════════
            "neutral": {
                "$description": "Neutral colors for backgrounds, borders, and structural elements. Use -1 for pure gray, or 0-360 for tinted neutrals.",
                "hue": {
                    "$type": "number",
                    "$value": state.neutralHue,
                    "$description": "Neutral hue value (-1 for pure gray, 0-360 for tinted)"
                },
                "shades": {
                    "$description": "Full neutral shade scale - all available for designer use",
                    ...Object.fromEntries(
                        CONFIG.neutralShades.map(({shade, s, l}) => {
                            const saturation = state.neutralHue === -1 ? 0 : s;
                            const hue = state.neutralHue === -1 ? 0 : state.neutralHue;
                            return [
                                shade.toString(),
                                {
                                    "$type": "color",
                                    "$value": hslToHex(hue, saturation, l + (state.neutralOffset || 0))
                                }
                            ];
                        })
                    )
                }
            },
            
            // ═══════════════════════════════════════════════════════════════
            // SEMANTIC COLORS - Status and feedback
            // ═══════════════════════════════════════════════════════════════
            "semantic": {
                "$description": "Status colors for user feedback. Use consistently to build user recognition.",
                
                "success": {
                    "$type": "color",
                    "$value": `hsl(${state.success.h}, ${state.success.s}%, ${state.success.l}%)`,
                    "$description": "Positive outcomes, completed actions, valid states, confirmations. Use for: form confirmations, successful operations, valid inputs, completed steps, positive badges (Active, Approved, Paid). NOT for: decorative green, unrelated positive emotions.",
                    "$extensions": {
                        "nce-hsl": { "h": state.success.h, "s": state.success.s, "l": state.success.l }
                    }
                },
                "error": {
                    "$type": "color",
                    "$value": `hsl(${state.error.h}, ${state.error.s}%, ${state.error.l}%)`,
                    "$description": "Failures, invalid states, destructive actions, critical problems. Use for: validation errors, failed operations, required fields, destructive buttons (Delete, Remove), negative badges (Rejected, Failed, Overdue). NOT for: warnings, attention-grabbing decoration.",
                    "$extensions": {
                        "nce-hsl": { "h": state.error.h, "s": state.error.s, "l": state.error.l }
                    }
                },
                "warning": {
                    "$type": "color",
                    "$value": `hsl(${state.warning.h}, ${state.warning.s}%, ${state.warning.l}%)`,
                    "$description": "Caution states, potential issues, actions needing attention. Use for: unsaved changes, approaching limits, non-destructive consequential actions (Archive, Disable), pending states, caution badges (Pending Review, Expiring Soon, Draft). NOT for: actual errors, informational notices.",
                    "$extensions": {
                        "nce-hsl": { "h": state.warning.h, "s": state.warning.s, "l": state.warning.l }
                    }
                }
            },
            
            // ═══════════════════════════════════════════════════════════════
            // WINDOW CONTROLS - macOS-style traffic light buttons
            // ═══════════════════════════════════════════════════════════════
            "windowControls": {
                "$description": "Window control button colors (macOS traffic light style)",
                
                "close": {
                    "$type": "color",
                    "$value": `hsl(${state.close.h}, ${state.close.s}%, ${state.close.l}%)`,
                    "$description": "Close/exit button color",
                    "$extensions": {
                        "nce-hsl": { "h": state.close.h, "s": state.close.s, "l": state.close.l }
                    }
                },
                "minimize": {
                    "$type": "color",
                    "$value": `hsl(${state.minimize.h}, ${state.minimize.s}%, ${state.minimize.l}%)`,
                    "$description": "Minimize button color",
                    "$extensions": {
                        "nce-hsl": { "h": state.minimize.h, "s": state.minimize.s, "l": state.minimize.l }
                    }
                },
                "maximize": {
                    "$type": "color",
                    "$value": `hsl(${state.maximize.h}, ${state.maximize.s}%, ${state.maximize.l}%)`,
                    "$description": "Maximize button color",
                    "$extensions": {
                        "nce-hsl": { "h": state.maximize.h, "s": state.maximize.s, "l": state.maximize.l }
                    }
                }
            },
            
            // ═══════════════════════════════════════════════════════════════
            // SURFACE - Background hierarchy
            // ═══════════════════════════════════════════════════════════════
            "surface": {
                "$description": "Background hierarchy for page elements",
                "$extensions": {
                    "nce-design-system": {
                        "rule": "shade-step",
                        "description": "Nested panels automatically step darker from panel background",
                        "direction": state.nestedPanelDirection || "darker",
                        "stepSize": state.nestedPanelStep || 50
                    }
                },
                "page": {
                    "$type": "color",
                    "$value": getTokenColor(state.pageBg),
                    "$description": "Page/canvas background",
                    "$extensions": { "nce-token": state.pageBg, "nce-level": 0 }
                },
                "panel": {
                    "$type": "color",
                    "$value": getTokenColor(state.panelBg),
                    "$description": "Card/panel background",
                    "$extensions": { "nce-token": state.panelBg, "nce-level": 1 }
                },
                "nested": {
                    "$type": "color",
                    "$value": getNestedPanelColor(1),
                    "$description": "Nested panel background (auto-calculated)",
                    "$extensions": { "nce-level": 2, "nce-computed": true }
                }
            },
            
            // ═══════════════════════════════════════════════════════════════
            // BUTTON SETTINGS - Gradient and text configuration
            // ═══════════════════════════════════════════════════════════════
            "button": {
                "$description": "Button styling configuration",
                
                "gradient": {
                    "angle": {
                        "$type": "number",
                        "$value": state.gradient.angle,
                        "$description": "Gradient angle in degrees (180 = top-lit, 0 = bottom-lit, 'none' = flat)"
                    }
                },
                "defaultShade": {
                    "$type": "number",
                    "$value": state.defaultShade,
                    "$description": "Default shade for primary buttons (50-900)"
                },
                "textFlipShade": {
                    "$type": "number",
                    "$value": state.textFlipShade,
                    "$description": "Shade threshold where button text flips from dark to light"
                }
            }
        };
        
        // ═══════════════════════════════════════════════════════════════════
        // FRAPPE ONLY: Add Frappe-specific settings to theme output
        // ═══════════════════════════════════════════════════════════════════
        if (typeof frappeState !== 'undefined') {
            // Add Frappe-specific agent guidance
            theme.$extensions["nce-design-system"].frappeGuidance = {
                "purpose": "Frappe/ERPNext Desk UI customization",
                "cssVariables": "All values map to Frappe CSS custom properties (--variable-name)",
                
                "coreToFrappeMapping": {
                    "$description": "How Core Theme tokens map to Frappe CSS variables",
                    "primary": {
                        "coreToken": "primary-{shade}",
                        "frappeVar": "--primary",
                        "note": "Frappe uses primary-500 as --primary by default. Shades available as --primary-{shade}."
                    },
                    "neutral": {
                        "coreToken": "neutral-{shade}",
                        "frappeVar": "--gray-{shade}",
                        "note": "Neutral tones. Used for --bg-color, --fg-color, borders, text."
                    },
                    "backgrounds": {
                        "pageBg": { "frappeVar": "--bg-color", "description": "Page/desk background" },
                        "panelBg": { "frappeVar": "--fg-color", "description": "Card/panel foreground" },
                        "controlBg": { "frappeVar": "--control-bg", "description": "Input field background" }
                    },
                    "semantic": {
                        "success": { "frappeVar": "--green-*", "indicators": ["Submitted", "Active", "Enabled"] },
                        "error": { "frappeVar": "--red-*", "indicators": ["Cancelled", "Failed", "Disabled"] },
                        "warning": { "frappeVar": "--orange-*", "indicators": ["Pending", "Draft", "On Hold"] }
                    },
                    "sizing": {
                        "borderRadius": { "frappeVar": "--border-radius", "default": "6px" },
                        "borderRadiusLg": { "frappeVar": "--border-radius-lg", "default": "12px" },
                        "btnHeight": { "frappeVar": "--btn-height", "default": "28px" }
                    }
                },
                "components": {
                    "lists": {
                        "description": "List View styling for doctypes",
                        "hover": "Use subtle primary tints (primary-50) for row hover",
                        "selection": "Use slightly stronger primary (primary-100) for selected rows",
                        "alternateRows": "Use neutral-50 for zebra striping to improve scanability"
                    },
                    "forms": {
                        "description": "Form View styling for document editing",
                        "sections": "Section headers use neutral backgrounds for visual grouping",
                        "controls": "Input backgrounds should be subtle (neutral-50) not white",
                        "focus": "Focus rings use primary color to show active field"
                    },
                    "navigation": {
                        "description": "Sidebar and Awesomebar styling",
                        "sidebar": "Use neutral backgrounds with primary accents for active items",
                        "navbar": "Dark theme recommended for contrast with content area"
                    },
                    "indicators": {
                        "description": "Status badge colors for workflow states",
                        "semantic": "Green/Red/Orange inherited from Core Theme semantic colors",
                        "custom": "Blue and Purple for info/custom states"
                    },
                    "print": {
                        "description": "PDF export and paper printing styles",
                        "colorMode": "Full color palette for PDF exports",
                        "bwMode": "Pure grayscale palette for paper printing (no color cast)",
                        "usage": "Add .print-bw-mode class to activate B&W palette before printing"
                    },
                    "customComponents": {
                        "description": "Custom HTML/JS pages, widgets, and panels in Frappe apps",
                        "colorSource": "For custom components, use the full palette from the Core Theme section (primary.shades, neutral.shades)",
                        "note": "The frappeCSS section contains only Frappe-native CSS variables. For custom HTML/JS work, reference the complete shade scales (50-900) in the primary and neutral sections at the root of this JSON.",
                        "examples": [
                            "Custom Page: Read primary.shades.600.$value for button backgrounds",
                            "Client Script HTML: Use neutral.shades.100.$value for panel backgrounds",
                            "Web Template: Reference any shade from the core palette"
                        ]
                    }
                },
                "sizingVariables": {
                    "borderRadius": "Global corner radius for small elements (buttons, inputs)",
                    "borderRadiusLg": "Corner radius for large elements (modals, cards)",
                    "btnHeight": "Standard button height - affects touch targets"
                }
            };
            
            // Helper to resolve token to hex value
            const resolveColor = (token) => {
                if (!token) return null;
                if (token.startsWith('#')) return token; // Already hex
                return getTokenColor(token);
            };
            
            // Get navbar background based on theme
            const getNavbarBg = () => {
                if (frappeState.navbarTheme === 'dark') return '#1a1a1a';
                if (frappeState.navbarTheme === 'light') return '#ffffff';
                return getTokenColor('primary-700');
            };
            
            // Frappe CSS Variables - EXACT names for Python script
            // All values resolved to hex, all inherited values included
            theme.frappeCSS = {
                "$description": "Frappe CSS custom properties - use these variable names exactly",
                "$usage": "Python script reads these directly into app CSS",
                
                // ─────────────────────────────────────────────────────────────
                // CORE (from Core Theme - repeated here for completeness)
                // ─────────────────────────────────────────────────────────────
                "--primary": resolveColor('primary-500'),
                "--primary-light": resolveColor('primary-100'),
                "--primary-dark": resolveColor('primary-700'),
                "--bg-color": resolveColor(state.pageBg),
                "--fg-color": resolveColor(state.panelBg),
                
                // Semantic colors (from Core Theme)
                "--green": hslToHex(state.success.h, state.success.s, 50),
                "--green-light": hslToHex(state.success.h, state.success.s, state.success.l),
                "--red": hslToHex(state.error.h, state.error.s, 50),
                "--red-light": hslToHex(state.error.h, state.error.s, state.error.l),
                "--orange": hslToHex(state.warning.h, state.warning.s, 50),
                "--orange-light": hslToHex(state.warning.h, state.warning.s, state.warning.l),
                
                // ─────────────────────────────────────────────────────────────
                // SIZING
                // ─────────────────────────────────────────────────────────────
                "--border-radius": frappeState.borderRadius,
                "--border-radius-lg": frappeState.borderRadiusLg,
                "--btn-height": frappeState.btnHeight,
                "--card-border-radius": frappeState.cardBorderRadius,
                
                // ─────────────────────────────────────────────────────────────
                // COMMON ELEMENTS
                // ─────────────────────────────────────────────────────────────
                "--navbar-bg": getNavbarBg(),
                "--control-bg": resolveColor(frappeState.controlBg),
                "--btn-default-bg": resolveColor(frappeState.btnDefaultBg),
                "--focus-ring-color": resolveColor(frappeState.focusRingColor),
                "--border-color": resolveColor(frappeState.defaultBorderColor),
                "--row-hover-bg": resolveColor(frappeState.rowHoverColor),
                "--row-selection-bg": resolveColor(frappeState.rowSelectionColor),
                "--alternate-row-bg": resolveColor(frappeState.alternateRowColor),
                
                // ─────────────────────────────────────────────────────────────
                // LISTS
                // ─────────────────────────────────────────────────────────────
                "--list-header-bg": resolveColor(frappeState.listHeaderBg),
                "--list-header-text": resolveColor(frappeState.listHeaderText),
                "--list-row-border": resolveColor(frappeState.listRowBorder),
                // Inherited - repeated for convenience
                "--list-row-hover": resolveColor(frappeState.rowHoverColor),
                "--list-row-selected": resolveColor(frappeState.rowSelectionColor),
                "--list-row-alt": resolveColor(frappeState.alternateRowColor),
                
                // ─────────────────────────────────────────────────────────────
                // FORMS
                // ─────────────────────────────────────────────────────────────
                "--form-label-color": resolveColor(frappeState.formLabelColor),
                "--form-section-bg": resolveColor(frappeState.formSectionBg),
                "--form-section-text": resolveColor(frappeState.formSectionText),
                "--form-tab-active": resolveColor(frappeState.formTabActive),
                "--checkbox-color": resolveColor(frappeState.checkboxColor),
                // Inherited - repeated for convenience
                "--form-control-bg": resolveColor(frappeState.controlBg),
                "--form-focus-ring": resolveColor(frappeState.focusRingColor),
                "--form-border-color": resolveColor(frappeState.defaultBorderColor),
                
                // ─────────────────────────────────────────────────────────────
                // INDICATORS
                // ─────────────────────────────────────────────────────────────
                "--indicator-blue": resolveColor(frappeState.indicatorBlue),
                "--indicator-purple": frappeState.indicatorPurple, // Already hex
                "--indicator-gray": resolveColor(frappeState.indicatorGray),
                // Semantic - repeated for convenience
                "--indicator-green": hslToHex(state.success.h, state.success.s, 50),
                "--indicator-red": hslToHex(state.error.h, state.error.s, 50),
                "--indicator-orange": hslToHex(state.warning.h, state.warning.s, 50),
                
                // ─────────────────────────────────────────────────────────────
                // NAVIGATION
                // ─────────────────────────────────────────────────────────────
                "--sidebar-bg": resolveColor(frappeState.sidebarBg),
                "--sidebar-text": resolveColor(frappeState.sidebarText),
                "--sidebar-hover": resolveColor(frappeState.sidebarHover),
                "--sidebar-active-bg": resolveColor(frappeState.sidebarActive),
                "--sidebar-active-text": resolveColor(frappeState.sidebarActiveText),
                "--awesomebar-hover": resolveColor(frappeState.awesomebarHover),
                
                // ─────────────────────────────────────────────────────────────
                // PRINT - COLOR (for PDF)
                // ─────────────────────────────────────────────────────────────
                "--print-heading": resolveColor(frappeState.printHeading),
                "--print-text": resolveColor(frappeState.printText),
                "--print-table-header": resolveColor(frappeState.printTableHeader),
                "--print-table-border": resolveColor(frappeState.printTableBorder),
                "--print-footer": resolveColor(frappeState.printFooter),
                
                // ─────────────────────────────────────────────────────────────
                // PRINT - B&W (for paper, use with .print-bw-mode class)
                // ─────────────────────────────────────────────────────────────
                "--print-heading-bw": frappeState.printHeadingBW,
                "--print-text-bw": frappeState.printTextBW,
                "--print-table-header-bw": frappeState.printTableHeaderBW,
                "--print-table-border-bw": frappeState.printTableBorderBW,
                "--print-footer-bw": frappeState.printFooterBW
            };
        }
        // ═══════════════════════════════════════════════════════════════════
        // END FRAPPE ONLY
        // ═══════════════════════════════════════════════════════════════════
        
        const json = JSON.stringify(theme, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${themeName.toLowerCase().replace(/\s+/g, '-')}-${timestamp}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        document.getElementById('modalContent').innerHTML = `
            <div class="modal-success">
                <div class="modal-title">Theme Saved</div>
                <div class="modal-message">${themeName} has been downloaded</div>
            </div>
        `;
        
        setTimeout(() => {
            closeModal();
        }, 2000);
    }
    
    function showErrorModal(message) {
        document.getElementById('modalContent').innerHTML = `
            <div class="modal-title">Error</div>
            <div class="modal-message">${message}</div>
            <div class="modal-buttons">
                <button class="btn btn-primary" data-action="close-modal">OK</button>
            </div>
        `;
        document.getElementById('modalOverlay').classList.add('show');
    }
    
    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('show');
    }
    
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
        if (e.target.id === 'modalOverlay') {
            closeModal();
        }
    });
    
    // ═══════════════════════════════════════════════════════════════════════════
    // THEME MANAGEMENT
    // ═══════════════════════════════════════════════════════════════════════════
    
    let currentTheme = null; // Track currently loaded theme
    let originalState = null; // Track original state for revert
    
    // Helper to generate color swatch from hue
    function generateSwatchColor(hue) {
        return hslToHex(hue, 80, 60);
    }
    
    // Show "My Themes" modal with table of saved themes
    async function showMyThemesModal() {
        try {
            const response = await frappe.call({
                method: 'frappe_theme_editor.frappe_theme_editor.doctype.theme.theme.get_all_themes',
                callback: function(r) {
                    if (r.message) {
                        renderThemesTable(r.message);
                    }
                }
            });
        } catch (error) {
            showErrorModal('Failed to load themes: ' + error.message);
        }
    }
    
    function renderThemesTable(themes) {
        let tableHTML = '';
        
        if (themes.length === 0) {
            tableHTML = '<div class="modal-empty">No saved themes yet. Create your first theme!</div>';
        } else {
            tableHTML = `
                <table class="themes-table">
                    <thead>
                        <tr>
                            <th>Colors</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th colspan="3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            themes.forEach(theme => {
                const primaryColor = generateSwatchColor(theme.primary_color || 200);
                const neutralColor = generateSwatchColor(theme.neutral_color || 0);
                const isDefault = theme.name === 'Default';
                
                tableHTML += `
                    <tr>
                        <td>
                            <div class="theme-swatch">
                                <div class="swatch-color" style="background-color: ${primaryColor}"></div>
                                <div class="swatch-color" style="background-color: ${neutralColor}"></div>
                            </div>
                        </td>
                        <td><strong>${theme.theme_name}</strong></td>
                        <td>${theme.description || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" data-action="load-theme" data-name="${theme.name}">
                                Load ${theme.theme_name}
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary" data-action="download-theme" data-name="${theme.name}">
                                Download
                            </button>
                        </td>
                        <td>
                            ${!isDefault ? `<button class="btn btn-sm btn-danger" data-action="delete-theme" data-name="${theme.name}">X</button>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
        }
        
        document.getElementById('modalContent').innerHTML = `
            <div class="modal-title">My Themes</div>
            ${tableHTML}
            <div class="modal-buttons">
                <button class="btn btn-secondary" data-action="close-modal">Close</button>
            </div>
        `;
        
        // Make modal wider for table
        const modal = document.querySelector('.modal');
        modal.classList.add('modal-wide');
        
        document.getElementById('modalOverlay').classList.add('show');
    }
    
    // Show "Save as New Theme" dialog
    function showSaveAsNewModal() {
        const defaultName = `Theme ${new Date().toLocaleDateString()}`;
        
        document.getElementById('modalContent').innerHTML = `
            <div class="modal-title">Save as New Theme</div>
            <div class="modal-message">Enter a name and optional description:</div>
            <input type="text" class="modal-input" id="newThemeName" value="${defaultName}" placeholder="Theme name">
            <textarea class="modal-input" id="newThemeDescription" placeholder="Description (optional)" rows="3"></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" data-action="close-modal">Cancel</button>
                <button class="btn btn-primary" data-action="confirm-save-new">Save</button>
            </div>
        `;
        
        document.getElementById('modalOverlay').classList.add('show');
        
        // Handle save
        document.querySelector('[data-action="confirm-save-new"]').addEventListener('click', async () => {
            const name = document.getElementById('newThemeName').value.trim();
            const description = document.getElementById('newThemeDescription').value.trim();
            
            if (!name) {
                showErrorModal('Please enter a theme name');
                return;
            }
            
            try {
                const jsonData = exportThemeJSON();
                
                await frappe.call({
                    method: 'frappe_theme_editor.frappe_theme_editor.doctype.theme.theme.save_theme',
                    args: {
                        theme_name: name,
                        description: description,
                        json_data: jsonData
                    },
                    callback: function(r) {
                        if (r.message) {
                            showSuccessModal('Theme saved successfully!');
                            currentTheme = { name: r.message, theme_name: name };
                            originalState = JSON.parse(jsonData);
                            updateThemeButtons();
                        }
                    }
                });
            } catch (error) {
                showErrorModal('Failed to save theme: ' + error.message);
            }
        });
    }
    
    // Update current theme
    async function updateCurrentTheme() {
        if (!currentTheme) {
            showErrorModal('No theme is currently loaded');
            return;
        }
        
        try {
            const jsonData = exportThemeJSON();
            
            await frappe.call({
                method: 'frappe_theme_editor.frappe_theme_editor.doctype.theme.theme.update_theme',
                args: {
                    name: currentTheme.name,
                    description: currentTheme.description || '',
                    json_data: jsonData
                },
                callback: function(r) {
                    if (r.message) {
                        showSuccessModal('Theme updated successfully!');
                        originalState = JSON.parse(jsonData);
                        updateThemeButtons();
                    }
                }
            });
        } catch (error) {
            showErrorModal('Failed to update theme: ' + error.message);
        }
    }
    
    // Revert to original loaded state
    function revertTheme() {
        if (!originalState) {
            showErrorModal('No theme to revert to');
            return;
        }
        
        // Restore state from original
        state = JSON.parse(JSON.stringify(originalState));
        updateUI();
        updateThemeButtons();
        showNotification('Reverted to original theme');
    }
    
    // Load theme from DocType
    async function loadThemeFromDocType(themeName) {
        try {
            await frappe.call({
                method: 'frappe_theme_editor.frappe_theme_editor.doctype.theme.theme.get_theme',
                args: { name: themeName },
                callback: function(r) {
                    if (r.message) {
                        const themeData = JSON.parse(r.message.json_data);
                        state = themeData;
                        currentTheme = {
                            name: r.message.name,
                            theme_name: r.message.theme_name,
                            description: r.message.description
                        };
                        originalState = JSON.parse(JSON.stringify(themeData));
                        updateUI();
                        updateThemeButtons();
                        closeModal();
                        showNotification(`Loaded theme: ${currentTheme.theme_name}`);
                    }
                }
            });
        } catch (error) {
            showErrorModal('Failed to load theme: ' + error.message);
        }
    }
    
    // Download theme as JSON file
    async function downloadThemeFromDocType(themeName) {
        try {
            await frappe.call({
                method: 'frappe_theme_editor.frappe_theme_editor.doctype.theme.theme.get_theme',
                args: { name: themeName },
                callback: function(r) {
                    if (r.message) {
                        const jsonData = r.message.json_data;
                        const blob = new Blob([jsonData], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${r.message.theme_name.replace(/\s+/g, '-').toLowerCase()}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        showNotification('Theme downloaded');
                    }
                }
            });
        } catch (error) {
            showErrorModal('Failed to download theme: ' + error.message);
        }
    }
    
    // Confirm delete theme
    function confirmDeleteTheme(themeName) {
        document.getElementById('modalContent').innerHTML = `
            <div class="modal-title">Delete Theme</div>
            <div class="modal-message">Are you sure you want to delete this theme? This action cannot be undone.</div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" data-action="close-modal">Cancel</button>
                <button class="btn btn-danger" data-action="confirm-delete-theme" data-name="${themeName}">Delete</button>
            </div>
        `;
        
        document.getElementById('modalOverlay').classList.add('show');
        
        document.querySelector('[data-action="confirm-delete-theme"]').addEventListener('click', () => {
            deleteTheme(themeName);
        });
    }
    
    // Delete theme
    async function deleteTheme(themeName) {
        try {
            await frappe.call({
                method: 'frappe_theme_editor.frappe_theme_editor.doctype.theme.theme.delete_theme',
                args: { name: themeName },
                callback: function(r) {
                    if (r.message && r.message.success) {
                        showSuccessModal('Theme deleted successfully!');
                        if (currentTheme && currentTheme.name === themeName) {
                            currentTheme = null;
                            originalState = null;
                            updateThemeButtons();
                        }
                        // Refresh themes list
                        setTimeout(() => showMyThemesModal(), 1000);
                    }
                }
            });
        } catch (error) {
            showErrorModal('Failed to delete theme: ' + error.message);
        }
    }
    
    // Show theme JSON in modal
    async function showThemeJSON(themeName) {
        try {
            await frappe.call({
                method: 'frappe_theme_editor.frappe_theme_editor.doctype.theme.theme.get_theme',
                args: { name: themeName },
                callback: function(r) {
                    if (r.message) {
                        const jsonData = JSON.stringify(JSON.parse(r.message.json_data), null, 2);
                        
                        document.getElementById('modalContent').innerHTML = `
                            <div class="modal-title">Theme JSON: ${r.message.theme_name}</div>
                            <pre style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 16px; border-radius: 6px; font-size: 12px;">${jsonData}</pre>
                            <div class="modal-buttons">
                                <button class="btn btn-secondary" data-action="close-modal">Close</button>
                                <button class="btn btn-primary" data-action="copy-json">Copy to Clipboard</button>
                            </div>
                        `;
                        
                        document.querySelector('[data-action="copy-json"]').addEventListener('click', () => {
                            navigator.clipboard.writeText(jsonData);
                            showNotification('JSON copied to clipboard');
                        });
                        
                        document.getElementById('modalOverlay').classList.add('show');
                    }
                }
            });
        } catch (error) {
            showErrorModal('Failed to load theme JSON: ' + error.message);
        }
    }
    
    // Update button visibility based on theme state
    function updateThemeButtons() {
        const btnUpdate = document.getElementById('btnUpdate');
        const btnRevert = document.getElementById('btnRevert');
        
        // Show Update/Revert only if:
        // 1. A theme is loaded
        // 2. It's not the default theme
        // 3. Changes have been made
        const hasChanges = originalState && JSON.stringify(state) !== JSON.stringify(originalState);
        const isCustomTheme = currentTheme && currentTheme.name !== 'Default';
        
        if (isCustomTheme && hasChanges) {
            btnUpdate.style.display = 'inline-block';
            btnRevert.style.display = 'inline-block';
        } else {
            btnUpdate.style.display = 'none';
            btnRevert.style.display = 'none';
        }
    }
    
    // Export current state as JSON string
    function exportThemeJSON() {
        return JSON.stringify(state, null, 2);
    }
    
    // Show success modal
    function showSuccessModal(message) {
        document.getElementById('modalContent').innerHTML = `
            <div class="modal-title">Success</div>
            <div class="modal-message">${message}</div>
            <div class="modal-buttons">
                <button class="btn btn-primary" data-action="close-modal">OK</button>
            </div>
        `;
        document.getElementById('modalOverlay').classList.add('show');
    }
    
    // Show notification
    function showNotification(message) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
        }, 2000);
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // CONFIGURATION
    // ═══════════════════════════════════════════════════════════════════════════
    
    const CONFIG = {
        primaryShades: [
            { shade: 50,  s: 100, l: 97 },
            { shade: 100, s: 98,  l: 94 },
            { shade: 200, s: 95,  l: 88 },
            { shade: 300, s: 92,  l: 80 },
            { shade: 400, s: 88,  l: 70 },
            { shade: 500, s: 83,  l: 60 },
            { shade: 600, s: 78,  l: 50 },
            { shade: 700, s: 73,  l: 42 },
            { shade: 800, s: 68,  l: 37 },
            { shade: 900, s: 65,  l: 35 }
        ],
        
        neutralShades: [
            { shade: 50,  s: 5,  l: 98 },
            { shade: 100, s: 5,  l: 96 },
            { shade: 200, s: 5,  l: 92 },
            { shade: 300, s: 5,  l: 85 },
            { shade: 400, s: 5,  l: 73 },
            { shade: 500, s: 6,  l: 58 },
            { shade: 600, s: 7,  l: 46 },
            { shade: 700, s: 7,  l: 38 },
            { shade: 800, s: 8,  l: 32 },
            { shade: 900, s: 8,  l: 30 }
        ],
        
        semanticColors: [
            { id: 'success', name: 'Success', default: { h: 150, s: 75, l: 85 } },
            { id: 'error',   name: 'Error',   default: { h: 0,   s: 85, l: 90 } },
            { id: 'warning', name: 'Warning', default: { h: 45,  s: 90, l: 85 } }
        ],
        
        windowColors: [
            { id: 'close',    name: 'Close',    default: { h: 0,   s: 70, l: 55 } },
            { id: 'minimize', name: 'Minimize', default: { h: 45,  s: 70, l: 55 } },
            { id: 'maximize', name: 'Maximize', default: { h: 120, s: 50, l: 50 } }
        ]
    };
    
    // ═══════════════════════════════════════════════════════════════════════════
    // STATE
    // ═══════════════════════════════════════════════════════════════════════════
    
    const DEFAULT_STATE = {
        primaryHue: 210,
        primarySat: 83,           // saturation from primary-500 config
        anchorShade: 500,         // which shade is exact match (500 = default brand)
        anchorHex: '#4198F0',     // default primary-500 hex (hsl 210, 83%, 60%)
        anchorL: 60,              // lightness from primary-500 config
        anchorOffset: 0,          // bump offset from initial anchor
        shadeOffset: 0,           // quantum shift for non-anchor mode
        neutralHue: 210,
        pageBg: 'neutral-100',
        panelBg: 'neutral-200',
        nestedPanelDirection: 'lighter',  // nested panels go lighter (Apple HIG style)
        nestedPanelStep: 50,             // half-shade increments
        success:  { h: 150, s: 75, l: 85 },
        error:    { h: 0,   s: 85, l: 90 },
        warning:  { h: 45,  s: 90, l: 85 },
        close:    { h: 0,   s: 70, l: 55 },
        minimize: { h: 45,  s: 70, l: 55 },
        maximize: { h: 120, s: 50, l: 50 },
        gradient: {
            angle: 180,
            stops: { top: 96, mid: 88, bottom: 82 }
        },
        defaultShade: 400,
        textFlipShade: 500,  // Shades >= this use light text
        uiFont: 'Arial',     // UI font family
        uiFontBold: false    // Bold toggle for UI elements
    };
    
    // ═══════════════════════════════════════════════════════════════════════════
    // FRAPPE ONLY: JS START - Frappe State
    // ═══════════════════════════════════════════════════════════════════════════
    const DEFAULT_FRAPPE_STATE = {
        // Common Elements
        navbarTheme: 'dark',
        alternateRows: true,
        alternateRowColor: 'neutral-50',
        btnDefaultBg: 'primary-100',
        controlBg: 'neutral-50',
        rowHoverColor: 'primary-50',
        rowSelectionColor: 'primary-100',
        cardBorderRadius: '8px',
        focusRingColor: 'primary-100',
        defaultBorderColor: 'neutral-300',
        // Sizing & Dimensions
        borderRadius: '6px',
        borderRadiusLg: '12px',
        btnHeight: '28px',
        // Lists
        listHeaderBg: 'neutral-100',
        listHeaderText: 'neutral-700',
        listRowBorder: 'neutral-200',
        // Forms
        formLabelColor: 'neutral-700',
        formSectionBg: 'neutral-300',
        formSectionText: 'neutral-800',
        formTabActive: 'primary-600',
        checkboxColor: 'primary-500',
        // Indicators
        indicatorBlue: 'primary-500',
        indicatorPurple: '#743ee2',  // Frappe's default purple
        indicatorGray: 'neutral-400',
        // Navigation
        sidebarBg: 'neutral-50',
        sidebarText: 'neutral-700',
        sidebarHover: 'primary-50',
        sidebarActive: 'primary-100',
        sidebarActiveText: 'primary-700',
        awesomebarHover: 'primary-50',
        // Print (Full Color - for PDF)
        printHeading: 'primary-700',
        printText: 'neutral-900',
        printTableHeader: 'neutral-100',
        printTableBorder: 'neutral-300',
        printFooter: 'neutral-500',
        // Print B&W (Pure grays - for paper printing)
        printHeadingBW: '#333333',      // Gray 800
        printTextBW: '#1a1a1a',         // Gray 900
        printTableHeaderBW: '#f5f5f5',  // Gray 100
        printTableBorderBW: '#cccccc',  // Gray 300
        printFooterBW: '#888888'        // Gray 500
    };
    
    let frappeState = { ...DEFAULT_FRAPPE_STATE };
    // ═══════════════════════════════════════════════════════════════════════════
    // FRAPPE ONLY: JS END - Frappe State
    // ═══════════════════════════════════════════════════════════════════════════
    
    let state = loadState();
    
    // ═══════════════════════════════════════════════════════════════════════════
    // UTILITIES
    // ═══════════════════════════════════════════════════════════════════════════
    
    function hslToHex(h, s, l) {
        l /= 100;
        const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
    }
    
    function hexToHSL(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        if (!result) return { h: 0, s: 0, l: 50 };
        let r = parseInt(result[1], 16) / 255;
        let g = parseInt(result[2], 16) / 255;
        let b = parseInt(result[3], 16) / 255;
        
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        
        if (max === min) {
            h = s = 0;
        } else {
            const d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
                case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                case g: h = ((b - r) / d + 2) / 6; break;
                case b: h = ((r - g) / d + 4) / 6; break;
            }
        }
        return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
    }
    
    // Calculate relative luminance (WCAG standard)
    // Accounts for human eye sensitivity: green > red > blue
    function getRelativeLuminance(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        if (!result) return 0.5;
        
        // Normalize RGB to 0-1
        let r = parseInt(result[1], 16) / 255;
        let g = parseInt(result[2], 16) / 255;
        let b = parseInt(result[3], 16) / 255;
        
        // Apply gamma correction (sRGB to linear)
        r = r <= 0.04045 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);
        g = g <= 0.04045 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);
        b = b <= 0.04045 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);
        
        // Weighted sum based on human perception
        return 0.2126 * r + 0.7152 * g + 0.0722 * b;
    }
    
    // Get contrasting text color based on background luminance
    function getContrastTextColor(bgHex) {
        const luminance = getRelativeLuminance(bgHex);
        // Threshold raised to favor light text on mid-tones
        return luminance > 0.35 ? '#000000' : '#FFFFFF';
    }
    
    function getHueName(hue) {
        if (hue < 30) return 'Red';
        if (hue < 60) return 'Orange';
        if (hue < 90) return 'Yellow';
        if (hue < 150) return 'Green';
        if (hue < 210) return 'Cyan';
        if (hue < 270) return 'Blue';
        if (hue < 330) return 'Purple';
        return 'Pink';
    }
    
    function getTemperature(hue) {
        if ((hue >= 0 && hue < 60) || hue >= 300) return 'Warm';
        if (hue >= 180 && hue < 300) return 'Cool';
        return 'Neutral';
    }
    
    function getContrastColor(h, s, l) {
        return l > 60 ? hslToHex(h, 60, 20) : hslToHex(h, 20, 95);
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // PERSISTENCE
    // ═══════════════════════════════════════════════════════════════════════════
    
    function loadState() {
        // Always return default state - no localStorage persistence
        // Users must explicitly save/load themes via buttons
        return { ...DEFAULT_STATE };
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // UI GENERATION
    // ═══════════════════════════════════════════════════════════════════════════
    
    function createScaleSwatch(prefix, shade, hex) {
        // Both primary and neutral swatches open the primary editor (which contains both pickers)
        const editorTarget = 'primary';
        return `
            <div class="color-swatch clickable" data-action="toggle-editor" data-target="${editorTarget}">
                <div class="color-box">
                    <div class="color-box-bg" id="bg-${prefix}-${shade}" style="background:${hex}"></div>
                </div>
                <div class="color-info">
                    <div class="color-name" id="name-${prefix}-${shade}">${prefix}-${shade}</div>
                    <div class="color-value" id="hex-${prefix}-${shade}">${hex}</div>
                </div>
            </div>
        `;
    }
    
    function createPickerSwatch(id, name, hex, labelColor) {
        return `
            <div class="color-swatch clickable">
                <div class="color-box">
                    <div class="color-box-bg" id="bg-${id}" style="background:${hex}"></div>
                    <input type="color" class="color-box-input" id="input-${id}" value="${hex}">
                    <span class="color-box-label" id="label-${id}" style="color:${labelColor}">Click to Edit</span>
                </div>
                <div class="color-info">
                    <div class="color-name">${name}</div>
                    <div class="color-value" id="hex-${id}">${hex}</div>
                </div>
            </div>
        `;
    }
    
    function buildUI() {
        // Primary grid
        let primaryHTML = '';
        CONFIG.primaryShades.forEach(({ shade, s, l }) => {
            const hex = getTokenColor(`primary-${shade}`);
            primaryHTML += createScaleSwatch('primary', shade, hex);
        });
        document.getElementById('primaryGrid').innerHTML = primaryHTML;
        
        // Neutral grid
        let neutralHTML = '';
        CONFIG.neutralShades.forEach(({ shade, s, l }) => {
            const hex = hslToHex(state.neutralHue, s, l);
            neutralHTML += createScaleSwatch('neutral', shade, hex);
        });
        document.getElementById('neutralGrid').innerHTML = neutralHTML;
        
        // Semantic grid
        let semanticHTML = '';
        CONFIG.semanticColors.forEach(({ id, name }) => {
            const c = state[id];
            const hex = hslToHex(c.h, c.s, c.l);
            const labelColor = getContrastColor(c.h, c.s, c.l);
            semanticHTML += createPickerSwatch(id, name, hex, labelColor);
        });
        document.getElementById('semanticGrid').innerHTML = semanticHTML;
        
        // Window grid
        let windowHTML = '';
        CONFIG.windowColors.forEach(({ id, name }) => {
            const c = state[id];
            const hex = hslToHex(c.h, c.s, c.l);
            const labelColor = getContrastColor(c.h, c.s, c.l);
            windowHTML += createPickerSwatch(id, name, hex, labelColor);
        });
        document.getElementById('windowGrid').innerHTML = windowHTML;
        
        // Bind color picker events
        [...CONFIG.semanticColors, ...CONFIG.windowColors].forEach(({ id }) => {
            const input = document.getElementById('input-' + id);
            if (input) {
                input.addEventListener('input', function() {
                    state[id] = hexToHSL(this.value);
                    updateUI();
                });
            }
        });
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // TEXT FLIP THRESHOLD SELECTOR
    // ═══════════════════════════════════════════════════════════════════════════
    
    const TEXT_FLIP_SHADES = [50, 100, 200, 300, 400, 500, 600, 700, 800, 900];
    
    function buildTextFlipTiles() {
        // Build 10 buttons showing each shade with live color preview
        const container = document.getElementById('textFlipButtons');
        if (!container) return;
        
        container.innerHTML = '';
        TEXT_FLIP_SHADES.forEach(shade => {
            const btn = document.createElement('button');
            btn.className = 'angle-preset text-flip-btn';
            btn.dataset.shade = shade;
            btn.textContent = shade;
            // Clicking tile sets default shade (button color)
            btn.onclick = function() { setDefaultShade(shade); };
            container.appendChild(btn);
        });
        
        updateTextFlipUI();
    }
    
    function updateTextFlipUI() {
        const flipShade = state.textFlipShade || 500;
        const defaultShade = state.defaultShade || 400;
        
        // Update button colors and text
        TEXT_FLIP_SHADES.forEach(shade => {
            const btn = document.querySelector(`.text-flip-btn[data-shade="${shade}"]`);
            if (!btn) return;
            
            const hex = getTokenColor('primary-' + shade);
            const useLightText = shade >= flipShade;
            
            btn.style.backgroundColor = hex;
            btn.style.color = useLightText ? '#ffffff' : '#000000';
            
            // Show asterisk on anchor shade
            const isAnchor = state.anchorShade === shade && state.anchorHex;
            btn.textContent = `${shade}${isAnchor ? '*' : ''}`;
            
            // Show which is the default shade with bold border
            if (shade === defaultShade) {
                btn.style.borderColor = '#0066cc';
                btn.style.borderWidth = '2px';
                btn.style.fontWeight = 'bold';
            } else {
                btn.style.borderColor = '#ddd';
                btn.style.borderWidth = '1px';
                btn.style.fontWeight = 'normal';
            }
        });
    }
    
    function moveTextFlip(direction) {
        console.log('moveTextFlip called with direction:', direction);
        const currentShade = state.textFlipShade || 500;
        const currentIndex = TEXT_FLIP_SHADES.indexOf(currentShade);
        const newIndex = Math.max(0, Math.min(TEXT_FLIP_SHADES.length - 1, currentIndex + direction));
        
        console.log('Flip shade changing from', currentShade, 'to', TEXT_FLIP_SHADES[newIndex]);
        state.textFlipShade = TEXT_FLIP_SHADES[newIndex];
        updateTextFlipUI();
        updateUI(); // Update button preview
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // UI UPDATE
    // ═══════════════════════════════════════════════════════════════════════════
    
    function updateUI() {
        // ═══════════════════════════════════════════════════════════════════
        // SET ALL CSS VARIABLES - Single source of truth for all elements
        // ═══════════════════════════════════════════════════════════════════
        
        // Primary shade scale (--primary-50 through --primary-900)
        CONFIG.primaryShades.forEach(({ shade }) => {
            const hex = getTokenColor(`primary-${shade}`);
            document.documentElement.style.setProperty(`--primary-${shade}`, hex);

            // Also update UI swatches
            const bg = document.getElementById('bg-primary-' + shade);
            const hexEl = document.getElementById('hex-primary-' + shade);
            const nameEl = document.getElementById('name-primary-' + shade);
            if (bg) bg.style.background = hex;
            if (hexEl) hexEl.textContent = hex;
            // Show asterisk on anchor shade
            if (nameEl) {
                const isAnchor = state.anchorShade === shade && state.anchorHex;
                nameEl.textContent = `primary-${shade}${isAnchor ? '*' : ''}`;
            }
        });
        document.getElementById('primaryLabel').textContent = getHueName(state.primaryHue);
        
        // Show/hide anchor legend
        const anchorLegend = document.getElementById('anchorLegend');
        if (anchorLegend) {
            anchorLegend.style.display = state.anchorHex ? 'block' : 'none';
        }

        // Update text flip tiles (keeps them in sync with primary colors)
        updateTextFlipUI();
        
        // Neutral shade scale (--neutral-50 through --neutral-900)
        CONFIG.neutralShades.forEach(({ shade }) => {
            const hex = getTokenColor('neutral-' + shade);
            document.documentElement.style.setProperty(`--neutral-${shade}`, hex);
            
            // Also update UI swatches
            const bg = document.getElementById('bg-neutral-' + shade);
            const hexEl = document.getElementById('hex-neutral-' + shade);
            if (bg) bg.style.background = hex;
            if (hexEl) hexEl.textContent = hex;
        });
        document.getElementById('neutralLabel').textContent = getTemperature(state.neutralHue);
        
        // Update semantic & window colors
        [...CONFIG.semanticColors, ...CONFIG.windowColors].forEach(({ id }) => {
            const c = state[id];
            const hex = hslToHex(c.h, c.s, c.l);
            const bg = document.getElementById('bg-' + id);
            const input = document.getElementById('input-' + id);
            const hexEl = document.getElementById('hex-' + id);
            const label = document.getElementById('label-' + id);
            
            if (bg) bg.style.background = hex;
            if (input) input.value = hex;
            if (hexEl) hexEl.textContent = hex;
            if (label) label.style.color = getContrastColor(c.h, c.s, c.l);
        });
        
        // Update page styling (self-style)
        const accentHex = hslToHex(state.primaryHue, 75, 55);
        const pageBg = getTokenColor(state.pageBg);              // from state (user-selectable)
        const containerBg = '#ffffff';                           // Always white
        const containerBorder = hslToHex(state.primaryHue, 70, 45); // primary-600
        const nestedPanelBg = getNestedPanelColor(1);            // 4% darker than white
        const nestedPanelBg2 = getNestedPanelColor(2);           // 8% darker than white
        const textColor = hslToHex(state.neutralHue, 10, 15);
        const mutedText = hslToHex(state.neutralHue, 5, 45);
        const successHex = hslToHex(state.success.h, state.success.s, Math.min(state.success.l, 45));
        
        document.documentElement.style.setProperty('--accent-color', accentHex);
        document.documentElement.style.setProperty('--page-bg', pageBg);
        document.documentElement.style.setProperty('--container-bg', containerBg);
        document.documentElement.style.setProperty('--container-border', containerBorder);
        document.documentElement.style.setProperty('--nested-panel-bg', nestedPanelBg);
        document.documentElement.style.setProperty('--nested-panel-bg-2', nestedPanelBg2);
        document.documentElement.style.setProperty('--page-text', textColor);
        document.documentElement.style.setProperty('--muted-text', mutedText);
        // Semantic colors - consistent naming for reuse across components
        const successHex2 = hslToHex(state.success.h, state.success.s, state.success.l);
        const successText = getContrastTextColor(successHex2);
        document.documentElement.style.setProperty('--success', successHex2);
        document.documentElement.style.setProperty('--success-text', successText);
        document.documentElement.style.setProperty('--success-color', successHex); // legacy
        
        const errorHex2 = hslToHex(state.error.h, state.error.s, state.error.l);
        const errorText2 = getContrastTextColor(errorHex2);
        document.documentElement.style.setProperty('--error', errorHex2);
        document.documentElement.style.setProperty('--error-text', errorText2);
        
        const warningHex = hslToHex(state.warning.h, state.warning.s, state.warning.l);
        const warningText = getContrastTextColor(warningHex);
        document.documentElement.style.setProperty('--warning', warningHex);
        document.documentElement.style.setProperty('--warning-text', warningText);

        // Button gradient - based on default shade
        const g = state.gradient;
        const isFlat = g.angle === 'none';

        // Get the lightness from the token (handles anchor system)
        const defaultHex = getTokenColor(`primary-${state.defaultShade}`);
        const defaultHSL = hexToHSL(defaultHex);
        const defaultNeutral = CONFIG.neutralShades.find(s => s.shade === state.defaultShade) || { s: 5, l: 80 };

        // Calculate gradient stops based on default shade lightness
        const baseL = defaultHSL.l;
        const topL = Math.min(98, baseL + 15);
        const midL = baseL;
        const bottomL = Math.max(5, baseL - 10);
        
        const baseNL = defaultNeutral.l;
        const topNL = Math.min(98, baseNL + 10);
        const midNL = baseNL;
        const bottomNL = Math.max(50, baseNL - 8);
        
        const primaryS = state.primarySat || 85;
        let btnGradient, btnSecGradient;
        if (isFlat) {
            btnGradient = `hsl(${state.primaryHue}, ${primaryS}%, ${midL}%)`;
            btnSecGradient = `hsl(${state.neutralHue}, ${defaultNeutral.s}%, ${midNL}%)`;
        } else {
            btnGradient = `linear-gradient(${g.angle}deg, 
                hsl(${state.primaryHue}, ${primaryS}%, ${topL}%) 0%, 
                hsl(${state.primaryHue}, ${primaryS}%, ${midL}%) 50%, 
                hsl(${state.primaryHue}, ${primaryS}%, ${bottomL}%) 100%)`;
            btnSecGradient = `linear-gradient(${g.angle}deg, 
                hsl(${state.neutralHue}, ${defaultNeutral.s}%, ${topNL}%) 0%, 
                hsl(${state.neutralHue}, ${defaultNeutral.s}%, ${midNL}%) 50%, 
                hsl(${state.neutralHue}, ${defaultNeutral.s}%, ${bottomNL}%) 100%)`;
        }
        
        // Text color - use user-defined textFlipShade threshold
        const flipShade = state.textFlipShade || 500;
        const useLightText = state.defaultShade >= flipShade;
        const btnText = useLightText ? '#ffffff' : '#000000';
        
        console.log('Button text update:', { flipShade, defaultShade: state.defaultShade, useLightText, btnText });
        
        document.documentElement.style.setProperty('--btn-gradient', btnGradient);
        document.documentElement.style.setProperty('--btn-text', btnText);
        
        // All button previews now use CSS variables via base classes:
        // .btn-solid uses --btn-gradient, --btn-text
        // .btn-outline uses --primary-500, --primary-600
        // .btn-ghost uses --primary-600
        // .btn-danger uses --error, --error-text
        // No inline style manipulation needed!

        // Secondary button gradient (neutral colors)
        const btnSecBgHex = hslToHex(state.neutralHue, defaultNeutral.s, midNL);
        const btnSecText = getContrastTextColor(btnSecBgHex);
        
        document.documentElement.style.setProperty('--btn-secondary-gradient', btnSecGradient);
        document.documentElement.style.setProperty('--btn-secondary-text', btnSecText);
        
        // Slider fill uses primary color
        const sliderBg = `linear-gradient(to right, hsl(${state.primaryHue}, 75%, 25%), hsl(${state.primaryHue}, 75%, 95%))`;
        document.documentElement.style.setProperty('--stop-slider-bg', sliderBg);

        // Update gradient preview (uses primary hue)
        updateGradientUI();
        
        // Update Frappe swatches (they depend on hue values)
        if (typeof initFrappeSwatches === 'function') {
            initFrappeSwatches();
        }
        
        // Update theme management buttons visibility
        if (typeof updateThemeButtons === 'function') {
            updateThemeButtons();
        }
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // EVENT HANDLERS
    // ═══════════════════════════════════════════════════════════════════════════
    
    function toggleEditor(type) {
        const panel = document.getElementById('editor-' + type);
        const overlay = document.getElementById('editor-overlay');
        panel.classList.toggle('hidden');
        if (overlay) overlay.classList.toggle('hidden');
        
        // Reset position to center when opening
        if (!panel.classList.contains('hidden')) {
            panel.style.top = '50%';
            panel.style.left = '50%';
            panel.style.transform = 'translate(-50%, -50%)';
        }
    }
    
    // Draggable modal functionality
    function initDraggableEditor() {
        const panel = document.getElementById('editor-primary');
        const handle = document.getElementById('editorDragHandle');
        if (!panel || !handle) return;
        
        let isDragging = false;
        let startX, startY, startLeft, startTop;
        
        handle.addEventListener('mousedown', function(e) {
            isDragging = true;
            panel.classList.add('dragging');
            
            // Get current position
            const rect = panel.getBoundingClientRect();
            startLeft = rect.left;
            startTop = rect.top;
            startX = e.clientX;
            startY = e.clientY;
            
            // Remove transform so we can use absolute positioning
            panel.style.transform = 'none';
            panel.style.left = startLeft + 'px';
            panel.style.top = startTop + 'px';
            
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            panel.style.left = (startLeft + dx) + 'px';
            panel.style.top = (startTop + dy) + 'px';
        });
        
        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                panel.classList.remove('dragging');
            }
        });
    }
    
    function closeAllEditors() {
        const editors = ['primary', 'color', 'scaleBump'];
        editors.forEach(type => {
            const panel = document.getElementById('editor-' + type);
            if (panel && !panel.classList.contains('hidden')) {
                panel.classList.add('hidden');
            }
        });
        
        // Also close any open pickers
        const pickers = document.querySelectorAll('.color-picker-panel, .scale-bump-panel');
        pickers.forEach(picker => {
            if (picker && picker.style.display === 'block') {
                picker.style.display = 'none';
            }
        });
    }
    
    // Default shade function
    function setDefaultShade(shade) {
        console.log('setDefaultShade called with:', shade);
        state.defaultShade = parseInt(shade);
        updateTextFlipUI(); // Update tile borders
        updateUI();
    }

    // Brand Hex Application
    function applyBrandHex() {
        let hex = document.getElementById('brandHexInput').value.trim();

        // Validate and normalize hex
        if (!hex.startsWith('#')) hex = '#' + hex;
        if (!/^#[0-9A-Fa-f]{6}$/.test(hex)) {
            alert('Please enter a valid hex color (e.g., #1E90FF)');
            return;
        }

        // Convert to HSL
        const hsl = hexToHSL(hex);

        // Anchor at 500 by default, but adjust if there was a pre-apply bump
        const shades = CONFIG.primaryShades.map(s => s.shade);
        const baseAnchorIdx = shades.indexOf(500);
        const preBumpOffset = state.shadeOffset || 0;
        
        // Apply pre-bump: if user bumped lighter (+), anchor moves to higher shade
        const adjustedIdx = Math.max(0, Math.min(shades.length - 1, baseAnchorIdx - preBumpOffset));
        const anchorShade = shades[adjustedIdx];

        // Update state
        state.primaryHue = hsl.h;
        state.primarySat = hsl.s;
        state.anchorShade = anchorShade;
        state.anchorHex = hex.toUpperCase();
        state.anchorL = hsl.l;

        // Transfer pre-bump offset to anchor offset, then clear shadeOffset
        state.anchorOffset = preBumpOffset;
        state.shadeOffset = 0;
        document.getElementById('anchorIndicator').textContent = 
            state.anchorOffset === 0 ? '0' : `${state.anchorOffset}`;

        // Update UI
        updateUI();
        refreshAllSwatchPickers();
    }

    // Gradient functions
    function toggleGradient(enabled) {
        state.gradient.angle = enabled ? 180 : 'none';
        updateUI(); // Updates all buttons + gradient preview
    }
    
    function setGradientAngle(angle) {
        state.gradient.angle = angle === 'none' ? 'none' : parseInt(angle);
        updateUI(); // Updates all buttons + gradient preview
    }
    
    // Typography functions
    function selectFontMenu(fontFamily) {
        state.uiFont = fontFamily;
        
        // Update trigger label with selected font
        const menu = document.getElementById('menu-uiFont');
        const triggerLabel = menu.querySelector('.menu-label');
        if (triggerLabel) {
            triggerLabel.textContent = fontFamily;
            triggerLabel.style.fontFamily = `${fontFamily}, sans-serif`;
        }
        
        // Update selected state
        menu.querySelectorAll('.styled-menu-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.value === fontFamily);
        });
        
        // Close dropdown
        document.getElementById('menu-uiFont-dropdown').classList.remove('open');
        
        // Apply font to body and button previews
        document.body.style.fontFamily = `${fontFamily}, sans-serif`;
        document.querySelectorAll('.btn-preview').forEach(btn => {
            btn.style.fontFamily = `${fontFamily}, sans-serif`;
        });
        
        updateUI();
    }
    
    function updateFontMenuBold() {
        const fontWeight = state.uiFontBold ? '600' : 'normal';
        // Update font menu options bold state
        document.querySelectorAll('.font-option').forEach(opt => {
            opt.style.fontWeight = fontWeight;
        });
        // Update trigger label bold state
        const triggerLabel = document.getElementById('fontMenuLabel');
        if (triggerLabel) {
            triggerLabel.style.fontWeight = fontWeight;
        }
    }
    
    function updateFont(fontFamily) {
        state.uiFont = fontFamily;
        document.body.style.fontFamily = `${fontFamily}, sans-serif`;
        // Apply to button previews
        document.querySelectorAll('.btn-preview').forEach(btn => {
            btn.style.fontFamily = `${fontFamily}, sans-serif`;
        });
        updateUI();
    }
    
    function toggleBold() {
        state.uiFontBold = !state.uiFontBold;
        const boldBtn = document.getElementById('boldToggle');
        const fontWeight = state.uiFontBold ? '600' : 'normal';
        
        document.body.style.fontWeight = fontWeight;
        // Apply to button previews
        document.querySelectorAll('.btn-preview').forEach(btn => {
            btn.style.fontWeight = fontWeight;
        });
        
        if (state.uiFontBold) {
            boldBtn.classList.add('active');
        } else {
            boldBtn.classList.remove('active');
        }
        
        // Update font menu items bold state
        updateFontMenuBold();
        
        updateUI();
    }
    
    function updateGradientUI() {
        // Update shade preset buttons
        document.querySelectorAll('.shade-preset').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.shade) === state.defaultShade);
        });
        
        // Update toggle switch
        const gradientToggle = document.getElementById('gradientToggle');
        if (gradientToggle) {
            gradientToggle.checked = state.gradient.angle !== 'none';
        }
        
        // Update angle preset buttons (kept for backward compatibility if any exist)
        document.querySelectorAll('.angle-preset:not(.shade-preset)').forEach(btn => {
            const btnAngle = btn.dataset.angle === 'none' ? 'none' : parseInt(btn.dataset.angle);
            btn.classList.toggle('active', btnAngle === state.gradient.angle);
        });
        
        // Update typography controls
        const fontMenu = document.getElementById('menu-uiFont');
        if (fontMenu) {
            const triggerLabel = fontMenu.querySelector('.menu-label');
            const currentFont = state.uiFont || 'Arial';
            if (triggerLabel) {
                triggerLabel.textContent = currentFont;
                triggerLabel.style.fontFamily = `${currentFont}, sans-serif`;
            }
            fontMenu.querySelectorAll('.styled-menu-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.value === state.uiFont);
            });
        }
        const boldBtn = document.getElementById('boldToggle');
        if (boldBtn) {
            boldBtn.classList.toggle('active', state.uiFontBold);
        }
        
        // Update font menu bold state
        if (typeof updateFontMenuBold === 'function') {
            updateFontMenuBold();
        }
        
        // Apply typography to body and button previews
        const fontFamily = `${state.uiFont || 'Arial'}, sans-serif`;
        const fontWeight = state.uiFontBold ? '600' : 'normal';
        document.body.style.fontFamily = fontFamily;
        document.body.style.fontWeight = fontWeight;
        document.querySelectorAll('.btn-preview').forEach(btn => {
            btn.style.fontFamily = fontFamily;
            btn.style.fontWeight = fontWeight;
        });
        
        // Update preview button - use default shade
        const preview = document.getElementById('gradientPreview');
        const h = state.primaryHue;

        // Get the lightness from the token (handles anchor system)
        const defaultHex = getTokenColor(`primary-${state.defaultShade}`);
        const defaultHSL = hexToHSL(defaultHex);
        const baseL = defaultHSL.l;
        const s = state.primarySat || 85;
        
        // Calculate gradient stops based on default shade lightness (with offset)
        const topL = Math.min(98, baseL + 15);
        const midL = baseL;
        const bottomL = Math.max(5, baseL - 10);
        
        const angle = state.gradient.angle;
        
        if (angle === 'none') {
            // Flat color - use base lightness
            preview.style.background = `hsl(${h}, ${s}%, ${midL}%)`;
        } else {
            preview.style.background = `linear-gradient(${angle}deg, 
                hsl(${h}, ${s}%, ${topL}%) 0%, 
                hsl(${h}, ${s}%, ${midL}%) 50%, 
                hsl(${h}, ${s}%, ${bottomL}%) 100%)`;
        }
        
        // Text color handled by CSS: .btn-solid { color: var(--btn-text); }
        // --btn-text is set in updateUI() based on text flip threshold
    }
    
    function setupSlider(sliderId, numId, stateKey) {
        const slider = document.getElementById(sliderId);
        const num = document.getElementById(numId);
        const isPrimaryHue = stateKey === 'primaryHue';
        
        slider.addEventListener('input', () => {
            state[stateKey] = parseInt(slider.value);
            num.value = slider.value;
            // If hue slider used, clear anchor (back to original method)
            if (isPrimaryHue) clearAnchor();
            updateUI();
            if (isPrimaryHue) refreshAllSwatchPickers();
        });

        num.addEventListener('input', () => {
            let val = parseInt(num.value) || 0;
            val = Math.max(0, Math.min(360, val));
            state[stateKey] = val;
            slider.value = val;
            // If hue input used, clear anchor (back to original method)
            if (isPrimaryHue) clearAnchor();
            updateUI();
            if (isPrimaryHue) refreshAllSwatchPickers();
        });
    }
    
    function bumpAnchor(direction) {
        const shades = CONFIG.primaryShades.map(s => s.shade);
        // Shades array is [50,100,200...900], so negative direction = lighter (lower index)
        // direction: +1 = lighter (user wants lighter), -1 = darker (user wants darker)
        // But array index: lower = lighter, higher = darker
        // So we negate: +1 from user -> -1 to index (lighter), -1 from user -> +1 to index (darker)
        const indexDirection = -direction;
        
        if (state.anchorShade && state.anchorHex) {
            // With anchor: shift which shade the brand hex is assigned to
            const currentIdx = shades.indexOf(state.anchorShade);
            const newIdx = currentIdx + indexDirection;
            
            // Check bounds
            if (newIdx < 0 || newIdx >= shades.length) return;
            
            state.anchorShade = shades[newIdx];
            // Update offset counter (relative to initial anchor)
            state.anchorOffset = (state.anchorOffset || 0) + direction;
            document.getElementById('anchorIndicator').textContent = `${state.anchorOffset}`;
        } else {
            // Without anchor: quantum shift all shades
            // Use shadeOffset to track the shift level
            state.shadeOffset = (state.shadeOffset || 0) + direction;
            
            // Clamp to reasonable bounds (-5 to +5 steps)
            state.shadeOffset = Math.max(-5, Math.min(5, state.shadeOffset));
            
            document.getElementById('anchorIndicator').textContent = `${state.shadeOffset}`;
        }
        
        updateBumpButtons();
        updateUI();
        refreshAllSwatchPickers();
    }
    
    function updateBumpButtons() {
        const shades = CONFIG.primaryShades.map(s => s.shade);
        const lighterBtn = document.getElementById('anchorBumpLeft');
        const darkerBtn = document.getElementById('anchorBumpRight');
        
        if (!lighterBtn || !darkerBtn) return;
        
        if (state.anchorShade && state.anchorHex) {
            // Anchor mode: check shade position
            const currentIdx = shades.indexOf(state.anchorShade);
            lighterBtn.disabled = (currentIdx >= shades.length - 1);  // Can't go lighter when at 900
            darkerBtn.disabled = (currentIdx <= 0);  // Can't go darker when at 50
        } else {
            // Offset mode: check offset bounds
            const offset = state.shadeOffset || 0;
            lighterBtn.disabled = (offset <= -5);
            darkerBtn.disabled = (offset >= 5);
        }
    }
    
    function clearAnchor() {
        // Clear all anchor/brand state
        state.anchorShade = null;
        state.anchorHex = null;
        state.anchorL = null;
        state.primarySat = 85;
        state.shadeOffset = 0;
        state.anchorOffset = 0;

        // Clear UI elements
        var indicator = document.getElementById('anchorIndicator');
        var hexInput = document.getElementById('brandHexInput');
        var colorPicker = document.getElementById('brandColorPicker');
        
        if (indicator) indicator.textContent = '--';
        if (hexInput) hexInput.value = '';
        // Sync picker with current primary-500 (visual hint, no anchor)
        if (colorPicker) colorPicker.value = getTokenColor('primary-500');
        
        updateBumpButtons();
    }
    
    // Refresh all swatch pickers to reflect current colors (e.g., after offset change)
    function refreshAllSwatchPickers() {
        document.querySelectorAll('.swatch-picker').forEach(picker => {
            updateSwatchPicker(picker);
        });
        updateInheritedSwatches();
        initNavbarPicker(); // Update navbar theme trigger if showing primary
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // CSS EXPORT
    // ═══════════════════════════════════════════════════════════════════════════
    
    function generateCSS() {
        let css = `/* NCE Design System - Custom Colors */\n:root {\n`;
        css += `    /* Primary Colors */\n`;
        css += `    --primary-hue: ${state.primaryHue};\n`;
        if (state.anchorHex) {
            css += `    /* Brand anchor: ${state.anchorShade} = ${state.anchorHex} */\n`;
        }
        CONFIG.primaryShades.forEach(({ shade }) => {
            css += `    --primary-${shade}: ${getTokenColor(`primary-${shade}`)};\n`;
        });
        css += `\n    /* Primary Defaults (shade ${state.defaultShade}) */\n`;
        css += `    --primary: var(--primary-${state.defaultShade});\n`;
        css += `    --primary-light: var(--primary-${Math.max(50, state.defaultShade - 200)});\n`;
        css += `    --primary-dark: var(--primary-${Math.min(900, state.defaultShade + 200)});\n`;
        
        css += `\n    /* Neutral Colors */\n`;
        css += `    --neutral-hue: ${state.neutralHue};\n`;
        CONFIG.neutralShades.forEach(({ shade, s, l }) => {
            css += `    --neutral-${shade}: ${hslToHex(state.neutralHue, s, l)};\n`;
        });
        css += `\n    /* Neutral Defaults */\n`;
        css += `    --neutral: var(--neutral-${state.defaultShade});\n`;
        css += `    --neutral-light: var(--neutral-${Math.max(50, state.defaultShade - 200)});\n`;
        css += `    --neutral-dark: var(--neutral-${Math.min(900, state.defaultShade + 200)});\n`;

        css += `\n    /* Backgrounds */\n`;
        css += `    --page-bg: ${getTokenColor(state.pageBg)};\n`;
        css += `    --panel-bg: ${getTokenColor(state.panelBg)};\n`;

        css += `\n    /* Semantic Colors */\n`;
        CONFIG.semanticColors.forEach(({ id }) => {
            const c = state[id];
            css += `    --${id}: ${hslToHex(c.h, c.s, c.l)};\n`;
        });
        
        css += `\n    /* Window Controls */\n`;
        CONFIG.windowColors.forEach(({ id }) => {
            const c = state[id];
            css += `    --window-${id}: ${hslToHex(c.h, c.s, c.l)};\n`;
        });
        
        css += `\n    /* Button Gradient */\n`;
        const g = state.gradient;
        const isFlat = g.angle === 'none';
        
        if (isFlat) {
            css += `    --btn-gradient: hsl(var(--primary-hue), 75%, ${g.stops.mid}%); /* flat */\n`;
            css += `    --btn-secondary-gradient: hsl(var(--neutral-hue), 5%, ${g.stops.mid}%); /* flat */\n`;
        } else {
            css += `    --btn-gradient-angle: ${g.angle}deg;\n`;
            css += `    --btn-gradient: linear-gradient(${g.angle}deg, \n`;
            css += `        hsl(var(--primary-hue), 75%, ${g.stops.top}%) 0%, \n`;
            css += `        hsl(var(--primary-hue), 75%, ${g.stops.mid}%) 50%, \n`;
            css += `        hsl(var(--primary-hue), 75%, ${g.stops.bottom}%) 100%);\n`;
            css += `    --btn-secondary-gradient: linear-gradient(${g.angle}deg, \n`;
            css += `        hsl(var(--neutral-hue), 5%, ${g.stops.top}%) 0%, \n`;
            css += `        hsl(var(--neutral-hue), 5%, ${g.stops.mid}%) 50%, \n`;
            css += `        hsl(var(--neutral-hue), 5%, ${g.stops.bottom}%) 100%);\n`;
        }
        css += `    --btn-text: hsl(var(--primary-hue), 60%, 25%);\n`;
        css += `    --btn-secondary-text: hsl(var(--neutral-hue), 10%, 25%);\n`;
        css += `\n    /* Button Styles */\n`;
        css += `    --btn-shadow: 0 1px 3px rgba(0,0,0,0.12), inset 0 0 0 1px rgba(0,0,0,0.1);\n`;
        css += `    --btn-shadow-hover: 0 2px 6px rgba(0,0,0,0.15), inset 0 0 0 1px rgba(0,0,0,0.1);\n`;
        
        css += `}\n`;
        return css;
    }
    
    function copyCSS() {
        navigator.clipboard.writeText(generateCSS()).then(() => {
            showNotification('Copied to clipboard');
        });
    }
    
    function showNotification(msg) {
        const el = document.getElementById('notification');
        el.textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 2000);
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // LOAD DEFAULT THEME FROM JSON
    // ═══════════════════════════════════════════════════════════════════════════
    
    async function loadDefaultTheme() {
        try {
            const response = await fetch('dist/default-theme.json');
            if (!response.ok) {
                console.warn('Could not load default theme, using built-in defaults');
                return false;
            }
            
            const theme = await response.json();
            console.log('Loading default theme:', theme.$name);
            
            // ─────────────────────────────────────────────────────────────
            // Load Core Theme values into state
            // ─────────────────────────────────────────────────────────────
            if (theme.primary) {
                if (theme.primary.hue?.$value !== undefined) state.primaryHue = theme.primary.hue.$value;
                if (theme.primary.defaultShade?.$value !== undefined) state.defaultShade = theme.primary.defaultShade.$value;
                if (theme.primary.textFlipShade?.$value !== undefined) state.textFlipShade = theme.primary.textFlipShade.$value;
                // Note: shades are computed from hue, not stored in state
            }
            
            if (theme.neutral?.hue?.$value !== undefined) {
                state.neutralHue = theme.neutral.hue.$value;
                // Note: shades are computed from hue, not stored in state
            }
            
            if (theme.semantic) {
                if (theme.semantic.success?.$extensions?.['nce-hsl']) {
                    state.success = theme.semantic.success.$extensions['nce-hsl'];
                }
                if (theme.semantic.error?.$extensions?.['nce-hsl']) {
                    state.error = theme.semantic.error.$extensions['nce-hsl'];
                }
                if (theme.semantic.warning?.$extensions?.['nce-hsl']) {
                    state.warning = theme.semantic.warning.$extensions['nce-hsl'];
                }
            }
            
            if (theme.windowControls) {
                if (theme.windowControls.close?.$extensions?.['nce-hsl']) {
                    state.close = theme.windowControls.close.$extensions['nce-hsl'];
                }
                if (theme.windowControls.minimize?.$extensions?.['nce-hsl']) {
                    state.minimize = theme.windowControls.minimize.$extensions['nce-hsl'];
                }
                if (theme.windowControls.maximize?.$extensions?.['nce-hsl']) {
                    state.maximize = theme.windowControls.maximize.$extensions['nce-hsl'];
                }
            }
            
            // Button settings (new structure)
            if (theme.button) {
                if (theme.button.gradient?.angle?.$value !== undefined) {
                    state.gradient.angle = theme.button.gradient.angle.$value;
                }
                if (theme.button.defaultShade?.$value !== undefined) {
                    state.defaultShade = theme.button.defaultShade.$value;
                }
                if (theme.button.textFlipShade?.$value !== undefined) {
                    state.textFlipShade = theme.button.textFlipShade.$value;
                }
            }
            
            // Legacy: buttonGradient (for backward compatibility)
            if (theme.buttonGradient?.angle?.$value !== undefined) {
                state.gradient.angle = theme.buttonGradient.angle.$value;
            }
            
            // ─────────────────────────────────────────────────────────────
            // Load Frappe values into frappeState (FRAPPE ONLY)
            // ─────────────────────────────────────────────────────────────
            if (typeof frappeState !== 'undefined' && theme.frappeCSS) {
                const css = theme.frappeCSS;
                
                // Helper to convert hex back to token (approximate)
                const hexToToken = (hex, prefix) => {
                    // For now, store the resolved values - we'll need reverse lookup
                    // This is a simplified approach - stores hex directly for some values
                    return hex;
                };
                
                // Sizing (direct values)
                if (css['--border-radius']) frappeState.borderRadius = css['--border-radius'];
                if (css['--border-radius-lg']) frappeState.borderRadiusLg = css['--border-radius-lg'];
                if (css['--btn-height']) frappeState.btnHeight = css['--btn-height'];
                if (css['--card-border-radius']) frappeState.cardBorderRadius = css['--card-border-radius'];
                
                // Navbar theme (detect from hex)
                if (css['--navbar-bg']) {
                    if (css['--navbar-bg'] === '#1a1a1a') frappeState.navbarTheme = 'dark';
                    else if (css['--navbar-bg'] === '#ffffff') frappeState.navbarTheme = 'light';
                    else frappeState.navbarTheme = 'primary';
                }
                
                // Indicators (purple is direct hex)
                if (css['--indicator-purple']) frappeState.indicatorPurple = css['--indicator-purple'];
                
                // Print B&W (direct hex values)
                if (css['--print-heading-bw']) frappeState.printHeadingBW = css['--print-heading-bw'];
                if (css['--print-text-bw']) frappeState.printTextBW = css['--print-text-bw'];
                if (css['--print-table-header-bw']) frappeState.printTableHeaderBW = css['--print-table-header-bw'];
                if (css['--print-table-border-bw']) frappeState.printTableBorderBW = css['--print-table-border-bw'];
                if (css['--print-footer-bw']) frappeState.printFooterBW = css['--print-footer-bw'];
                
                // Note: Token-based values (like 'primary-500', 'neutral-50') are 
                // regenerated from state.primaryHue/neutralHue, so we don't need 
                // to reverse-map those - they'll be correct after updateUI()
            }
            
            console.log('Default theme loaded successfully');
            return true;
            
        } catch (err) {
            console.warn('Error loading default theme:', err);
            return false;
        }
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // INIT
    // ═══════════════════════════════════════════════════════════════════════════
    
    // Build UI first (creates DOM elements)
    buildUI();
    buildTextFlipTiles();
    // Note: neutralHue slider removed - using new neutral picker instead
    
    // Wire up brand hex apply button
    document.getElementById('applyBrandHex').onclick = applyBrandHex;
    document.getElementById('brandHexInput').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') applyBrandHex();
    });
    
    // Sync color picker with text input
    document.getElementById('brandColorPicker').addEventListener('input', function() {
        document.getElementById('brandHexInput').value = this.value.toUpperCase();
    });
    document.getElementById('brandHexInput').addEventListener('input', function() {
        const hex = this.value;
        if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
            document.getElementById('brandColorPicker').value = hex;
        }
    });
    
    // ═══════════════════════════════════════════════════════════════════════════
    // ENVIRONMENT DETECTION & COLOR PICKER SETUP
    // ═══════════════════════════════════════════════════════════════════════════

    const ENV = {
        isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
        hasEyeDropper: 'EyeDropper' in window,
        isMac: /Mac/.test(navigator.platform)
    };

    let pickerHSV = { h: 210, s: 85, v: 94 };
    let selectedGridCell = null;

    // ─────────────────────────────────────────────────────────────────────────
    // HSV ↔ HEX Conversion
    // ─────────────────────────────────────────────────────────────────────────
    function hsvToHex(h, s, v) {
        s /= 100;
        v /= 100;
        const c = v * s;
        const x = c * (1 - Math.abs((h / 60) % 2 - 1));
        const m = v - c;
        let r, g, b;
        if (h < 60) { r = c; g = x; b = 0; }
        else if (h < 120) { r = x; g = c; b = 0; }
        else if (h < 180) { r = 0; g = c; b = x; }
        else if (h < 240) { r = 0; g = x; b = c; }
        else if (h < 300) { r = x; g = 0; b = c; }
        else { r = c; g = 0; b = x; }
        const toHex = (n) => Math.round((n + m) * 255).toString(16).padStart(2, '0');
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`.toUpperCase();
    }

    function hexToHSV(hex) {
        hex = hex.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16) / 255;
        const g = parseInt(hex.substr(2, 2), 16) / 255;
        const b = parseInt(hex.substr(4, 2), 16) / 255;
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        const d = max - min;
        let h = 0, s = max === 0 ? 0 : d / max, v = max;
        if (d !== 0) {
            if (max === r) h = 60 * ((g - b) / d + (g < b ? 6 : 0));
            else if (max === g) h = 60 * ((b - r) / d + 2);
            else h = 60 * ((r - g) / d + 4);
        }
        if (h < 0) h += 360;
        return { h: Math.round(h), s: Math.round(s * 100), v: Math.round(v * 100) };
    }

    // ─────────────────────────────────────────────────────────────────────────
    // Build Color Grid (Apple NSColorPanel grid: 12x1 + 12x10)
    // ─────────────────────────────────────────────────────────────────────────
    function buildColorGrid() {
        const grid = document.getElementById('colorGridPicker');
        if (!grid) return;
        grid.innerHTML = '';

        // Top row (12): Apple palette anchors (from Apple.clr + system gray)
        const topRow = [
            '#FF2600', // Red
            '#FF9300', // Orange
            '#FFFB00', // Yellow
            '#00F900', // Green
            '#00FDFF', // Cyan
            '#0433FF', // Blue
            '#FF40FF', // Magenta
            '#942192', // Purple
            '#AA7942', // Brown
            '#FFFFFF', // White
            '#8E8E93', // Gray (system gray)
            '#000000'  // Black
        ];

        // 12x10 matrix: exact Apple grid values (row-major)
        // Grayscale row (row_0 from Apple spec, first cell is "no fill")
        const grayRow = [
            null, '#FFFFFF', '#EBEBEB', '#D6D6D6', '#C0C0C0', '#ABABAB',
            '#939393', '#7A7A7A', '#5F5F5F', '#444444', '#232323', '#000000'
        ];

        // Color grid rows - exact Apple color picker values (rows 1-9)
        const gridRows = [
            ['#00313F', '#001D4C', '#12013B', '#2E043E', '#3D071C', '#5C0700', '#5B1B01', '#573501', '#563D01', '#666101', '#4F5604', '#263D0F'],
            ['#014D63', '#002F7B', '#1B0853', '#430E59', '#56102A', '#821100', '#7C2A01', '#7B4A02', '#775801', '#8C8700', '#707607', '#375819'],
            ['#026E8E', '#0142A9', '#2C1276', '#61187C', '#781A3E', '#B61A01', '#AD3F00', '#A96801', '#A77B01', '#C4BC01', '#9BA60E', '#4F7A28'],
            ['#018DB4', '#0157D7', '#371A96', '#7B209E', '#9A234E', '#E22400', '#DA5100', '#D48601', '#D29F01', '#F5EC00', '#C5D117', '#679C33'],
            ['#00A2D7', '#0062FE', '#4E22B3', '#992ABD', '#BF2E66', '#FF4112', '#FF6A01', '#FEAA00', '#FEC802', '#FFFC40', '#DAEB38', '#77BB40'],
            ['#00C7FC', '#3A8AFC', '#5E30EA', '#BD39F3', '#E53C7A', '#FF6251', '#FF8548', '#FEB440', '#FECA3E', '#FFF86B', '#E4EF65', '#97D25F'],
            ['#52D4FD', '#74A7FF', '#864EFE', '#D258FE', '#EC719F', '#FF8D81', '#FEA57D', '#FFC879', '#FFD876', '#FFF894', '#EAF48F', '#B1DE8B'],
            ['#93D9F7', '#A4C7FF', '#B18CFF', '#DF90FC', '#F4A4C1', '#FFB5AE', '#FFC4AA', '#FED9A8', '#FFE4A9', '#FEFBB8', '#F2F8B8', '#CBE8B5'],
            ['#D1E6F1', '#D4E4FE', '#D7CEFD', '#F0CAFD', '#F9D2E2', '#FFDBD9', '#FEE2D5', '#FFEDD6', '#FFF2D4', '#FEFCDD', '#F7FADB', '#E0EDD4']
        ];

        // Render top row (anchor colors)
        topRow.forEach(hex => {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.style.backgroundColor = hex;
            cell.dataset.hex = hex;
            cell.onclick = () => selectGridCell(cell, hex);
            grid.appendChild(cell);
        });

        // Spacer row (gap after top row like Apple)
        for (let i = 0; i < 12; i++) {
            const spacer = document.createElement('div');
            spacer.className = 'grid-spacer';
            grid.appendChild(spacer);
        }

        // Render grayscale row
        grayRow.forEach(hex => {
            const cell = document.createElement('div');
            if (hex === null) {
                // "No fill" cell with red diagonal line
                cell.className = 'grid-cell no-fill';
                cell.style.backgroundColor = '#FFFFFF';
                cell.dataset.hex = 'none';
                cell.title = 'No Fill';
            } else {
                cell.className = 'grid-cell';
                cell.style.backgroundColor = hex;
                cell.dataset.hex = hex;
                cell.onclick = () => selectGridCell(cell, hex);
            }
            grid.appendChild(cell);
        });

        // Render 12x10 color grid (dark to light)
        gridRows.forEach(row => {
            row.forEach(hex => {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.style.backgroundColor = hex;
                cell.dataset.hex = hex;
                cell.onclick = () => selectGridCell(cell, hex);
                grid.appendChild(cell);
            });
        });
    }

    function selectGridCell(cell, hex) {
        if (selectedGridCell) selectedGridCell.classList.remove('selected');
        selectedGridCell = cell;
        cell.classList.add('selected');
        pickerHSV = hexToHSV(hex);
        updatePickerUI(false);
        updatePickerSliderBackgrounds();
    }

    function updatePickerUI(deselectGrid = true) {
        const hex = hsvToHex(pickerHSV.h, pickerHSV.s, pickerHSV.v);
        document.getElementById('pickerHue').value = pickerHSV.h;
        document.getElementById('pickerHueNum').value = pickerHSV.h;
        document.getElementById('pickerSat').value = pickerHSV.s;
        document.getElementById('pickerSatNum').value = pickerHSV.s;
        document.getElementById('pickerVal').value = pickerHSV.v;
        document.getElementById('pickerValNum').value = pickerHSV.v;
        document.getElementById('pickerSwatchLarge').style.backgroundColor = hex;
        document.getElementById('pickerHexInput').value = hex;
        if (deselectGrid && selectedGridCell) {
            selectedGridCell.classList.remove('selected');
            selectedGridCell = null;
        }
    }

    function updatePickerSliderBackgrounds() {
        const satSlider = document.getElementById('pickerSat');
        const valSlider = document.getElementById('pickerVal');
        if (satSlider) {
            satSlider.style.background = `linear-gradient(to right, #888, hsl(${pickerHSV.h},100%,50%))`;
        }
        if (valSlider) {
            valSlider.style.background = `linear-gradient(to right, #000, hsl(${pickerHSV.h},100%,50%))`;
        }
    }

    function setupPickerSliders() {
        ['Hue', 'Sat', 'Val'].forEach(name => {
            const slider = document.getElementById('picker' + name);
            const num = document.getElementById('picker' + name + 'Num');
            if (!slider || !num) return;

            const update = (val) => {
                val = parseInt(val);
                if (name === 'Hue') pickerHSV.h = Math.max(0, Math.min(360, val));
                else if (name === 'Sat') pickerHSV.s = Math.max(0, Math.min(100, val));
                else pickerHSV.v = Math.max(0, Math.min(100, val));
                updatePickerUI();
                updatePickerSliderBackgrounds();
            };

            slider.addEventListener('input', () => { num.value = slider.value; update(slider.value); });
            num.addEventListener('input', () => { slider.value = num.value; update(num.value); });
        });

        // Hex input
        document.getElementById('pickerHexInput').addEventListener('input', function() {
            const hex = this.value;
            if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
                pickerHSV = hexToHSV(hex);
                updatePickerUI(false);
                updatePickerSliderBackgrounds();
            }
        });

        // Copy button
        document.getElementById('pickerCopyBtn').onclick = () => {
            const hex = document.getElementById('pickerHexInput').value;
            navigator.clipboard.writeText(hex);
            const indicator = document.getElementById('copiedIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        };

        // Apply button
        document.getElementById('pickerApplyBtn').onclick = () => {
            const hex = document.getElementById('pickerHexInput').value;
            document.getElementById('brandHexInput').value = hex;
            applyBrandHex();
        };
    }

    // Global eyedropper handler
    async function handleEyedropper() {
        // Check if EyeDropper API is available
        if (!('EyeDropper' in window)) {
            // Show polite browser message for Safari/Firefox users
            document.getElementById('modalContent').innerHTML = `
                <div class="modal-title">Eyedropper Not Available</div>
                <div class="modal-message">Please open this app in Chrome or Edge to use this feature.</div>
                <div class="modal-buttons">
                    <button class="btn btn-primary" data-action="close-modal">OK</button>
                </div>
            `;
            document.getElementById('modalOverlay').classList.add('show');
            return;
        }
        
        // Chrome/Edge: Use EyeDropper API
        try {
            const eyeDropper = new EyeDropper();
            const result = await eyeDropper.open();
            const hex = result.sRGBHex.toUpperCase();
            pickerHSV = hexToHSV(hex);
            updatePickerUI(false);
            updatePickerSliderBackgrounds();
        } catch (err) {
            // User cancelled
        }
    }

    function setupColorPicker() {
        const safariRow = document.getElementById('safariPickerRow');
        const pickerPanel = document.getElementById('colorPickerPanel');
        const nativePicker = document.getElementById('brandColorPicker');
        const eyedropperBtn = document.getElementById('pickerEyedropperBtn');
        
        // Keep Safari row in normal flow but collapsed/hidden
        safariRow.style.height = '0';
        safariRow.style.overflow = 'hidden';
        safariRow.style.margin = '0';
        safariRow.style.marginLeft = '300px';
        safariRow.style.padding = '0';
        
        // Show custom inline panel
        pickerPanel.classList.add('active');
        
        // Build the color grid
        buildColorGrid();
        setupPickerSliders();
        updatePickerSliderBackgrounds();
        updatePickerUI(false);
        
        // Always show eyedropper button (all browsers)
        // The handler will show a message for Safari/Firefox
        if (eyedropperBtn) {
            eyedropperBtn.classList.remove('eyedropper-hidden');
        }
    }

    // Setup color picker
    setupColorPicker();

    // Load default theme, then update UI
    loadDefaultTheme().then(() => {
        updateUI(); // Also updates gradient preview

        // FRAPPE ONLY: Initialize Frappe color swatches
        if (typeof initFrappeSwatches === 'function') {
            initFrappeSwatches();
        }

        // Sync brand color picker with current primary-500
        const currentColor = getTokenColor('primary-500');
        if (!state.anchorHex) {
            document.getElementById('brandColorPicker').value = currentColor;
            pickerHSV = hexToHSV(currentColor);
            updatePickerUI(false);
            updatePickerSliderBackgrounds();
        }
        
        updateBumpButtons();
        console.log('Theme editor initialized');
    });

    // ═══════════════════════════════════════════════════════════════════════════
    // NEUTRAL COLOR PICKER (completely independent)
    // ═══════════════════════════════════════════════════════════════════════════

    var neutralSelectedHue = 210;
    var neutralSelectedCell = null;

    function buildNeutralGrid() {
        var grid = document.getElementById('neutralColorGrid');
        if (!grid) return;
        grid.innerHTML = '';

        // Exact hex codes from reference - 3 rows x 5 columns
        // Row 1: Subtle (LE)
        // Row 2: Medium (M)
        // Row 3: Strong (G)
        var gridColors = [
            // Row 1: Subtle - Cool to Warm
            { hex: '#9BA3A9', hue: 210 },
            { hex: '#9CA2A7', hue: 200 },
            { hex: '#9DA1A4', hue: 190 },
            { hex: '#9E9E9E', hue: 0 },
            { hex: '#9F9D9C', hue: 30 },
            // Row 2: Medium - Cool to Warm
            { hex: '#8A9BA8', hue: 210 },
            { hex: '#8F9BA3', hue: 200 },
            { hex: '#949B9F', hue: 190 },
            { hex: '#9E9E9E', hue: 0 },
            { hex: '#A19D9B', hue: 30 },
            // Row 3: Strong - Cool to Warm
            { hex: '#7A93A7', hue: 210 },
            { hex: '#84959F', hue: 200 },
            { hex: '#8E979A', hue: 190 },
            { hex: '#9E9E9E', hue: 0 },
            { hex: '#A39B97', hue: 30 }
        ];

        gridColors.forEach(function(color) {
            var cell = document.createElement('div');
            cell.className = 'neutral-grid-cell';
            cell.style.backgroundColor = color.hex;
            cell.dataset.hue = color.hue;
            cell.onclick = function() { selectNeutralCell(cell, color.hue, color.hex); };
            grid.appendChild(cell);
        });
    }

    function selectNeutralCell(cell, hue, hex) {
        if (neutralSelectedCell) neutralSelectedCell.classList.remove('selected');
        neutralSelectedCell = cell;
        cell.classList.add('selected');
        neutralSelectedHue = hue;
        document.getElementById('neutralPreviewSwatch').style.backgroundColor = hex;
    }

    function applyNeutralColor() {
        state.neutralHue = neutralSelectedHue;
        state.neutralOffset = 0;
        document.getElementById('neutralBumpIndicator').textContent = '0';
        updateNeutralBumpButtons();
        updateUI();
    }

    function bumpNeutralScale(direction) {
        state.neutralOffset = (state.neutralOffset || 0) + direction;
        state.neutralOffset = Math.max(-5, Math.min(5, state.neutralOffset));
        document.getElementById('neutralBumpIndicator').textContent = String(state.neutralOffset);
        updateNeutralBumpButtons();
        updateUI();
    }

    function updateNeutralBumpButtons() {
        var lighterBtn = document.getElementById('neutralBumpLighter');
        var darkerBtn = document.getElementById('neutralBumpDarker');
        if (!lighterBtn || !darkerBtn) return;
        var offset = state.neutralOffset || 0;
        lighterBtn.disabled = (offset <= -5);
        darkerBtn.disabled = (offset >= 5);
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // BOOTSTRAP - Initialize the application when DOM is ready
    // ═══════════════════════════════════════════════════════════════════════════
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        // DOM is already ready
        initializeApp();
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // MODULE END - IIFE closes here
    // All interactions now handled via event delegation
    // ═══════════════════════════════════════════════════════════════════════════
    })(); // End IIFE

    </script>
</body>
</html>
